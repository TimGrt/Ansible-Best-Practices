
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Best Practices and Style Guide for Ansible Projects">
      
      
      
      
      
      
      <link rel="icon" href="../assets/images/ansible-logo-black.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.33">
    
    
      
        <title>Ansible Best Practices</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      
  
  
    
    
  
  
  <style>:root{--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.25 12a.75.75 0 0 1-.22.53l-2.75 2.75a.75.75 0 0 1-1.06-1.06L7.44 12 5.22 9.78a.75.75 0 1 1 1.06-1.06l2.75 2.75c.141.14.22.331.22.53Zm2 2a.75.75 0 0 0 0 1.5h5a.75.75 0 0 0 0-1.5h-5Z"/><path d="M0 4.75C0 3.784.784 3 1.75 3h20.5c.966 0 1.75.784 1.75 1.75v14.5A1.75 1.75 0 0 1 22.25 21H1.75A1.75 1.75 0 0 1 0 19.25Zm1.75-.25a.25.25 0 0 0-.25.25v14.5c0 .138.112.25.25.25h20.5a.25.25 0 0 0 .25-.25V4.75a.25.25 0 0 0-.25-.25Z"/></svg>');}</style>



    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/print-site-enum-headings1.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings2.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings3.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings4.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings5.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings6.css">
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
      <link rel="stylesheet" href="../assets/stylesheets/extra.css">
    
      <link rel="stylesheet" href="../assets/stylesheets/tables.css">
    
    <script>__md_scope=new URL("/",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  
        <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            remove_material_navigation();remove_mkdocs_theme_navigation();generate_toc();
        })
        </script>
        </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
  <!-- Add announcement here, including arbitrary HTML -->
  <!-- <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M1.75 1h12.5c.966 0 1.75.784 1.75 1.75v9.5A1.75 1.75 0 0 1 14.25 14H8.061l-2.574 2.573A1.458 1.458 0 0 1 3 15.543V14H1.75A1.75 1.75 0 0 1 0 12.25v-9.5C0 1.784.784 1 1.75 1ZM1.5 2.75v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25Z"/><path d="M22.5 8.75a.25.25 0 0 0-.25-.25h-3.5a.75.75 0 0 1 0-1.5h3.5c.966 0 1.75.784 1.75 1.75v9.5A1.75 1.75 0 0 1 22.25 20H21v1.543a1.457 1.457 0 0 1-2.487 1.03L15.939 20H10.75A1.75 1.75 0 0 1 9 18.25v-1.465a.75.75 0 0 1 1.5 0v1.465c0 .138.112.25.25.25h5.5a.75.75 0 0 1 .53.22l2.72 2.72v-2.19a.75.75 0 0 1 .75-.75h2a.25.25 0 0 0 .25-.25v-9.5Z"/></svg></span> &nbsp;Anmerkungen und eure Best Practices sind gern gesehen! -->
  <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M7.875 2.292a.114.114 0 0 0-.032.018A7.239 7.239 0 0 0 4.75 8.25a7.248 7.248 0 0 0 3.654 6.297c.57.327.982.955.941 1.682v.002l-.317 6.058a.75.75 0 1 1-1.498-.078l.317-6.062v-.004c.006-.09-.047-.215-.188-.296A8.749 8.749 0 0 1 3.25 8.25a8.738 8.738 0 0 1 3.732-7.169 1.547 1.547 0 0 1 1.709-.064c.484.292.809.835.809 1.46v4.714a.25.25 0 0 0 .119.213l2.25 1.385c.08.05.182.05.262 0l2.25-1.385a.25.25 0 0 0 .119-.213V2.478c0-.626.325-1.169.81-1.461a1.547 1.547 0 0 1 1.708.064 8.741 8.741 0 0 1 3.732 7.17 8.747 8.747 0 0 1-4.41 7.598c-.14.081-.193.206-.188.296v.004l.318 6.062a.75.75 0 1 1-1.498.078l-.317-6.058v-.002c-.041-.727.37-1.355.94-1.682A7.247 7.247 0 0 0 19.25 8.25a7.239 7.239 0 0 0-3.093-5.94.114.114 0 0 0-.032-.018l-.01-.001c-.003 0-.014 0-.031.01-.036.022-.084.079-.084.177V7.19c0 .608-.315 1.172-.833 1.49l-2.25 1.385a1.75 1.75 0 0 1-1.834 0l-2.25-1.384A1.752 1.752 0 0 1 8 7.192V2.477c0-.098-.048-.155-.084-.176a.068.068 0 0 0-.031-.011l-.01.001Z"/></svg></span> &nbsp;Work in Progress! <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.97 8.265a1.45 1.45 0 0 0-.487.57.75.75 0 0 1-1.341-.67c.2-.402.513-.826.997-1.148C10.627 6.69 11.244 6.5 12 6.5c.658 0 1.369.195 1.934.619a2.45 2.45 0 0 1 1.004 2.006c0 1.033-.513 1.72-1.027 2.215-.19.183-.399.358-.579.508l-.147.123a4.329 4.329 0 0 0-.435.409v1.37a.75.75 0 1 1-1.5 0v-1.473c0-.237.067-.504.247-.736.22-.28.486-.517.718-.714l.183-.153.001-.001c.172-.143.324-.27.47-.412.368-.355.569-.676.569-1.136a.953.953 0 0 0-.404-.806C12.766 8.118 12.384 8 12 8c-.494 0-.814.121-1.03.265ZM13 17a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/><path d="M12 1c6.075 0 11 4.925 11 11s-4.925 11-11 11S1 18.075 1 12 5.925 1 12 1ZM2.5 12a9.5 9.5 0 0 0 9.5 9.5 9.5 9.5 0 0 0 9.5-9.5A9.5 9.5 0 0 0 12 2.5 9.5 9.5 0 0 0 2.5 12Z"/></svg></span> <b>Missing something? <a href="https://github.com/TimGrt/Ansible-Best-Practices/issues/new/choose" target="_blank">Open an issue!</a></b>

          </div>
          
        </aside>
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Ansible Best Practices" class="md-header__button md-logo" aria-label="Ansible Best Practices" data-md-component="logo">
      
  <img src="../assets/images/ansible-logo-black.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ansible Best Practices
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="red"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/TimGrt/Ansible-Best-Practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    TimGrt/Ansible-Best-Practices
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Ansible Best Practices" class="md-nav__button md-logo" aria-label="Ansible Best Practices" data-md-component="logo">
      
  <img src="../assets/images/ansible-logo-black.png" alt="logo">

    </a>
    Ansible Best Practices
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/TimGrt/Ansible-Best-Practices" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    TimGrt/Ansible-Best-Practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../mindset/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Mindset
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Mindset
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../ansible/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Ansible
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Ansible
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ansible/installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ansible/project/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Project
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ansible/inventory/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Inventory
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ansible/playbook/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Playbook
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ansible/roles/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Roles
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ansible/tasks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tasks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ansible/variables/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Variables
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../development/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Ansible Development
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Ansible Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Version Control
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/linting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Linting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/testing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Testing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../development/extending/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Extending
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../automation-platform/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Ansible Automation Platform
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Ansible Automation Platform
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../automation-platform/credentials/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Credentials
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../automation-platform/workflows/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Workflows
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#" class="md-nav__link">
    <span class="md-ellipsis">
      1. Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-mindset" class="md-nav__link">
    <span class="md-ellipsis">
      I. Mindset
    </span>
  </a>
  
    <nav class="md-nav" aria-label="I. Mindset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mindset" class="md-nav__link">
    <span class="md-ellipsis">
      2. The Zen of Ansible
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-ansible" class="md-nav__link">
    <span class="md-ellipsis">
      II. Ansible
    </span>
  </a>
  
    <nav class="md-nav" aria-label="II. Ansible">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ansible" class="md-nav__link">
    <span class="md-ellipsis">
      3. Ansible
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-installation" class="md-nav__link">
    <span class="md-ellipsis">
      4. Installation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-project" class="md-nav__link">
    <span class="md-ellipsis">
      5. Project
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-inventory" class="md-nav__link">
    <span class="md-ellipsis">
      6. Inventory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-playbook" class="md-nav__link">
    <span class="md-ellipsis">
      7. Playbook
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-roles" class="md-nav__link">
    <span class="md-ellipsis">
      8. Roles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      9. Tasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-variables" class="md-nav__link">
    <span class="md-ellipsis">
      10. Variables
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-ansible-development" class="md-nav__link">
    <span class="md-ellipsis">
      III. Ansible Development
    </span>
  </a>
  
    <nav class="md-nav" aria-label="III. Ansible Development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#development" class="md-nav__link">
    <span class="md-ellipsis">
      11. Development
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#development-git" class="md-nav__link">
    <span class="md-ellipsis">
      12. Version Control
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#development-linting" class="md-nav__link">
    <span class="md-ellipsis">
      13. Linting
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#development-testing" class="md-nav__link">
    <span class="md-ellipsis">
      14. Testing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#development-extending" class="md-nav__link">
    <span class="md-ellipsis">
      15. Extending
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-ansible-automation-platform" class="md-nav__link">
    <span class="md-ellipsis">
      IV. Ansible Automation Platform
    </span>
  </a>
  
    <nav class="md-nav" aria-label="IV. Ansible Automation Platform">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#automation-platform" class="md-nav__link">
    <span class="md-ellipsis">
      16. Ansible Automation Platform
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automation-platform-credentials" class="md-nav__link">
    <span class="md-ellipsis">
      17. Credentials
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#automation-platform-workflows" class="md-nav__link">
    <span class="md-ellipsis">
      18. Workflows
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                




                  


<div id="print-site-page" class="print-site-enumerate-headings print-site-enumerate-figures">
        <section id="print-site-cover-page">
            <div>

    
        <h1>Ansible Best Practices</h1>
    

</div>

<p>
    <img src="../assets/images/ansible-community-logo-black.png" width=500/>
</p>


<p>
    Best Practices and Style Guide for Ansible Projects
</p>



<p>
    <em>Copyright &copy; Tim Grützmacher 2024</em>
</p>

        </section>
        
        <div id="print-site-banner">
            <p>
    <b><em>This box will disappear when printing!</em></b>
</p>
<p>This page has combined all site pages into one. This cover page and a table of contents will be added.</p>
<p>You can export to PDF using <b>File > Print > Save as PDF</b> (or use <b>Ctrl-P</b> and set to <b>Save as PDF</b>).</p>
<p>See also <a href="https://timvink.github.io/mkdocs-print-site-plugin/how-to/export-PDF.html">Export to PDF</a>.</p>
        </div>
        
        <section class="print-page">
            <div id="print-page-toc" data-toc-depth="3">
                <nav role='navigation' class='print-page-toc-nav'>
                <h1 class='print-page-toc-title'>Table of Contents</h1>
                </nav>
            </div>
        </section>
        <section class="print-page" id="index"><h1 id="index-best-practices">Best Practices</h1>
<p>This document aims to gather good and best practices from Ansible practitioners and experience from multiple Ansible projects. It strives to give all Ansible users a guideline from which to start their automation journey in good conditions.</p>
<figure>
<p><img alt="CC Logo" src="../assets/images/ansible-community-logo-black.png#only-light" width="500" />
  <img alt="CC Logo" src="../assets/images/ansible-community-logo-white.png#only-dark" width="500" />
  </p>
<figcaption></figcaption>
</figure>
<p>Ansible is simple, flexible, and powerful. Like any powerful tool, there are many ways to use it, some better than others.</p>
<p>Those are <strong>opinionated</strong> guidelines based on the experience of many projects. They are not meant to be followed blindly if they don’t fit the reader’s specific use case or needs. Take them as an inspiration and adjust them to your needs, still let us know your good and best practices, we all can learn.</p>
<div class="grid cards">
<ul>
<li><a href="#mindset"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12.3 7.29c.2-.18.44-.29.7-.29.27 0 .5.11.71.29.19.21.29.45.29.71 0 .27-.1.5-.29.71-.21.19-.44.29-.71.29-.26 0-.5-.1-.7-.29-.19-.21-.3-.44-.3-.71 0-.26.11-.5.3-.71m-2.5 4.68s2.17-1.72 2.96-1.79c.74-.06.59.79.52 1.23l-.01.06c-.14.53-.31 1.17-.48 1.78-.38 1.39-.75 2.75-.66 3 .1.34.72-.09 1.17-.39.06-.04.11-.08.16-.11 0 0 .08-.08.16.03.02.03.04.06.06.08.09.14.14.19.02.27l-.04.02c-.22.15-1.16.81-1.54 1.05-.41.27-1.98 1.17-1.74-.58.21-1.23.49-2.29.71-3.12.41-1.5.59-2.18-.33-1.59-.37.22-.59.36-.72.45-.11.08-.12.08-.19-.05l-.03-.06-.05-.08c-.07-.1-.07-.11.03-.2M22 12c0 5.5-4.5 10-10 10S2 17.5 2 12 6.5 2 12 2s10 4.5 10 10m-2 0c0-4.42-3.58-8-8-8s-8 3.58-8 8 3.58 8 8 8 8-3.58 8-8Z"/></svg></span> &nbsp; <strong>Mindset</strong></a></li>
<li><a href="#ansible"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2m4.1 15c-.19 0-.34-.1-.55-.27l-5.16-4.17-1.73 4.34H7.17l4.37-10.51c.11-.28.35-.42.63-.42s.5.14.62.42l3.98 9.58c.04.11.07.22.07.29-.01.42-.34.74-.74.74m-3.93-8.89 2.59 6.39-3.91-3.08 1.32-3.31Z"/></svg></span> &nbsp; <strong>Ansible</strong></a></li>
<li><a href="#development"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.6 16.6 4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4m-5.2 0L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4Z"/></svg></span> &nbsp; <strong>Ansible Development</strong></a></li>
<li><a href="#automation-platform"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M341.52 285.56c33.65 0 82.34-6.94 82.34-47 .22-6.74.86-1.82-20.88-96.24-4.62-19.15-8.68-27.84-42.31-44.65-26.09-13.34-82.92-35.37-99.73-35.37-15.66 0-20.2 20.17-38.87 20.17-18 0-31.31-15.06-48.12-15.06-16.14 0-26.66 11-34.78 33.62-27.5 77.55-26.28 74.27-26.12 78.27 0 24.8 97.64 106.11 228.47 106.11M429 254.84c4.65 22 4.65 24.35 4.65 27.25 0 37.66-42.33 58.56-98 58.56-125.74.08-235.91-73.65-235.91-122.33a49.55 49.55 0 0 1 4.06-19.72C58.56 200.86 0 208.93 0 260.63c0 84.67 200.63 189 359.49 189 121.79 0 152.51-55.08 152.51-98.58 0-34.21-29.59-73.05-82.93-96.24"/></svg></span> &nbsp; <strong>Ansible Automation Platform</strong></a></li>
</ul>
</div>
<p>Searching for something specific? Use the <strong>Search</strong> at the top!</p>
<div class="admonition tip">
<p class="admonition-title">Versioning</p>
<p>This guide is updated constantly, last update on <strong><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">July 11, 2024</span></strong>.</p>
</div>
<!-- markdownlint-disable --></section>
                        <h1 class='nav-section-title' id='section-mindset'>
                            Mindset <a class='headerlink' href='#section-mindset' title='Permanent link'>↵</a>
                        </h1>
                        <section class="print-page" id="mindset"><h1 id="mindset-the-zen-of-ansible">The Zen of Ansible</h1>
<p>Your Ansible automation content doesn’t necessarily have to follow this guidance, but they’re good ideas to keep in mind. These aphorisms are opinions that can be debated and sometimes can be contradictory. What matters is that they communicate a mindset for getting the most from Ansible and your automation.</p>
<div class="grid cards">
<ul>
<li>
<p><img alt="♾" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.0.3/assets/svg/267e.svg" title=":infinity:" /> 20 aphorisms for Ansible</p>
<div class="no-copy highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#mindset-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#mindset-__codelineno-0-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>Ansible is not Python.
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>YAML sucks for coding.
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>Playbooks are not for programming.
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>Ansible users are (most likely) not programmers.
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>Clear is better than cluttered.
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>Concise is better than verbose.
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>Simple is better than complex.
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>Readability counts.
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>Helping users get things done matters most.
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>User experience beats ideological purity.
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>“Magic” conquers the manual.
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>When giving users options, use convention over configuration.
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>Declarative is better than imperative – most of the time.
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>Focus avoids complexity.
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>Complexity kills productivity.
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>If the implementation is hard to explain, it&#39;s a bad idea.
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>Every shell command and UI interaction is an opportunity to automate.
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>Just because something works, doesn’t mean it can’t be improved.
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>Friction should be eliminated whenever possible.
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>Automation is a journey that never ends.
</code></pre></div></td></tr></table></div>
</li>
</ul>
</div>
<p>Let me take you deeper into each of the aphorisms and explain what they mean to your automation practice.</p>
<h2 id="mindset-ansible-is-not-python">Ansible is not Python</h2>
<p>YAML sucks for coding. Playbooks are not for programming. Ansible users are (most probably) not programmers.  </p>
<p>These aphorisms are at the heart of why applying guidelines for a programming language to good Ansible automation content didn’t seem right to me. As I said, it would give the wrong impression and would reinforce a mindset we don't recommend – that Ansible is a programming language for coding your playbooks.</p>
<p>These aphorisms are all saying the same thing in different ways – certainly the first 3. If you're trying to "write code" in your plays and roles, you're setting yourself up for failure. Ansible’s YAML-based playbooks were never meant to be for programming.</p>
<p>So it bothers me when I see Python-isms bleeding into what Ansible users see and do. It may be natural and make sense if you write code in Python, but most Ansible users are not Pythonistas. So, it can be challenging and confusing when these isms are incorporated, thereby introducing friction that degrades their user experience and the value that Ansible provides.</p>
<p>By Ansible not being a programming language, all parts of your organization can contribute to automating your entire IT stack rather than relying on skill programmers to understand your operations to write and maintain code for it.</p>
<p>If you are a programmer creating Ansible modules and plugins, assume you are not the target audience for what you are developing and your target audience won’t have the same skills and resources you possess.</p>
<h2 id="mindset-clear-concise-simple">Clear, Concise, Simple</h2>
<p>Clear is better than cluttered. Concise is better than verbose. Simple is better than complex. Readability counts.  </p>
<p>These are really just interpretations of aphorisms in “The Zen of Python”. The last one is taken directly from it because you can’t improve on perfection.</p>
<p>In the original Ansible best practices talk, we recommended users optimize for readability. This holds true even more so today. If done properly, your content can be the documentation of your workflow automation. Take the time to make your automation as clear and concise as possible. Iterate over what you create and always look for opportunities to simplify and clarify.</p>
<p>These aphorisms don’t just apply to those writing playbooks and creating roles. If you are a module developer, think about how your work can assist users, be clear and concise, do things simply and just get things done.</p>
<h2 id="mindset-helping-users">Helping users</h2>
<p>Helping users get things done matters most. User experience beats ideological purity.  </p>
<p>Whether you are creating modules, plugins and collections or writing playbooks or designing a cross domain hybrid automation workflow – Ansible is for helping you get things done. Always consider and look to maximize the user experience. Don’t get caught up and beholden to some strict interpretation of standards or ideological purity that shifts the burden on the end user.</p>
<h2 id="mindset-its-a-kind-of-magic">It's a kind of Magic</h2>
<p>“Magic” conquers the manual Arthur C. Clarke wrote, “Any sufficiently advanced technology is indistinguishable from magic.”</p>
<p>The “magic” in Ansible is its playbook engine and module system. It is how Ansible provides powerful and flexible capabilities in a straightforward and accessible way by abstracting users from all of the complex implementation details that lie beneath. This frees users from doing time consuming and error prone manual operations or writing brittle one-off scripts and code, enabling them the time to put their valuable expertise to use where it is needed.</p>
<p>Design automation that amazes users can make difficult or tedious tasks easy and almost effortless. Look to provide powerful time saving capabilities that are quick to deploy and utilize them to get things done.</p>
<h2 id="mindset-convention-over-configuration">Convention over configuration</h2>
<p>When giving users options, use convention over configuration.  </p>
<p>I am a big proponent of convention over configuration and don’t think it gets enough consideration in the Ansible community. Convention over configuration is a design paradigm that attempts to decrease the number of decisions that a developer is required to make without necessarily losing flexibility so they don't have to repeat themselves. It was popularized by Ruby on Rails.</p>
<p>A playbook developer utilizing your work should only need to specify unique and unconventional aspects of their automation tasks and workflows and no more. Look to reduce the number of decisions and implementation details a user needs to make. Take the time to handle the most common use cases for them. Look to provide as many sensible defaults with modules, plugins and roles as possible. Optimize for users to get things done quickly.</p>
<h2 id="mindset-declarative">Declarative</h2>
<p>Declarative is better than imperative – most of the time.</p>
<p>This aphorism is particularly for Ansible Content Collection developers. Ansible is a desired state engine by design. Think declaratively first. If there truly is no way to design something declaratively, then use imperative (procedural) means.</p>
<p>Declarative means that configuration is guaranteed by a set of facts instead of by a set of instructions, for example, “there should be 10 RHEL servers”, rather than “depending on how many RHEL servers are running, start/stop servers until you have 10, and tell me if it worked or not”.</p>
<p>This aphorism is an example of the “user experience beats ideological purity” aphorism in practice. Rather than strictly adhering to a declarative approach to automation, Ansible incorporates declarative and imperative means. This mix offers you the flexibility to focus on what you need to do, rather than strictly adhere to one paradigm.</p>
<h2 id="mindset-avoid-complexity">Avoid complexity</h2>
<p>Focus avoids complexity. Complexity kills productivity.</p>
<p>Remember that complexity kills productivity. The Ansible team at Red Hat really means it and believes that. That's not just a marketing slogan. Automation can crush complexity and give you the one thing you can’t get enough of ⎯ time.</p>
<p>Follow Linux principles of doing one thing, and one thing well. Keep roles and playbooks focused on a specific purpose. Multiple simple ones are better than having a huge single playbook full of conditionals and “programming” that Ansible is not well suited for.</p>
<p>We strive to reduce complexity in how we've designed Ansible and encourage you to do the same. Strive for simplification in what you automate.</p>
<h2 id="mindset-hard-to-explain">Hard to explain !?</h2>
<p>If the implementation is hard to explain, it's a bad idea.  </p>
<p>This aphorism, like “readability counts”, is also taken directly from “The Zen of Python” because you cannot improve upon perfection.</p>
<p>In his essay on Literate Programming, Charles Knuth wrote, “Instead of imagining that our main task is to instruct a computer what to do, let us concentrate rather on explaining to human beings what we want a computer to do.” So it goes that if you cannot explain or document your implementation easily, then it’s a bad idea that needs to be rethought or scrapped. If it is hard to explain, what chance do others have of understanding it, using it and debugging it? Kernighan’s Law says “Debugging is twice as hard as writing the code in the first place. Therefore, if you write the code as cleverly as possible, you are, by definition, not smart enough to debug it.”</p>
<p>Ansible is designed for how real people think and work. Recall earlier when I said Ansible Playbooks are human readable automation with no special coding skills needed. Take advantage of that. Then, if you are having trouble explaining what you are trying to do, pause and re-consider your implementation and the process you are trying to automate. How can I make it easier to explain? Can my process be improved or streamlined? How can I simplify and clarify? Can I break it down into smaller more focused parts and iterate over this?</p>
<p>This will help you identify a bad idea sooner and avoid the types of friction that will slow down you and your organization over time.</p>
<h2 id="mindset-opportunity-to-automate">Opportunity to automate!</h2>
<p>Every shell command and UI interaction is an opportunity to automate.</p>
<p>This aphorism comes from my personal experience talking about Ansible and automation for many years. Sometimes I am asked what they should automate. Other times, I am challenged that an automation tool like Ansible is unnecessary or does not apply to what they are doing. No matter if we were talking about RHEL, Windows, networking infrastructure, security, edge devices, or cloud services, my response has essentially been the same over the years. I have repeated it so often, that I have jokingly formulated the point into my own theorem on automation. So call it “Appnel's Theorem on Automation” if you will.</p>
<p>If you are wondering what should be automated, look for anything anyone is typing into a Linux shell and clicking through in a user interface. Then ask yourself “is this something that can be automated?” Then ask “what is the value of automating this?” Most Ansible modules wrap command line tools or use the same APIs behind UIs.</p>
<p>Given a sufficient number of things to automate is identified, start with those that cause the most pain and those that you can get done quickly. Remember you want to create a virtuous cycle of releasing reliability, feedback and building trust across your organization. Showing progress and business value quickly will help do that.</p>
<h2 id="mindset-cant-be-improved">Can't be improved?</h2>
<p>Just because something works, doesn’t mean it can’t be improved. Friction should be eliminated whenever possible.  </p>
<p>This first aphorism just so happens to be a quote from the movie Black Panther, and it elegantly expresses some important wisdom when it comes to Ansible automation.</p>
<p>Always iterate and adapt to real world feedback from your operations. Optimize readability. Continue to find ways to simplify and reduce friction in your organization and its processes. As changes are introduced into your environments and IT policies over time, they will create new friction and pain points. They will also create new opportunities to apply your automation practices to eliminate them.</p>
<h2 id="mindset-never-ending-story">Never ending story...</h2>
<p>Automation is a journey that never ends.</p>
<p>Heraclitus, a Greek philosopher, said "change is the only constant in life. Nothing endures but change."</p>
<p>Anyone who has been around the IT industry for any length of time knows there is constant change. This is why it is so vital to be agile and prepared to respond to ongoing change, innovation and business demands quickly and reliably.</p>
<p>Automation is not a destination. It is a practice. It is a culture, a mindset and an attitude. Automation is a continuous process of feedback and learning and adapting to change and improving upon what you did before.</p>
<p>Automation creates opportunities and we at Red Hat see opportunities for automation everywhere.</p>
<p>So the question I pose to you is: Where will your automation journey lead you?</p>
<h2 id="mindset-further-reading">Further Reading</h2>
<p>If you want to dive more deeply into the application of the zen of Ansible and its origins, I recommend these resources.</p>
<p>The <a href="https://redhat-cop.github.io/automation-good-practices/" target="_blank">Ansible Community of Practice (CoP)</a> has assembled a comprehensive repository of “good practices” for Ansible content development. The Ansible Lint tool has now been added to the Red Hat Ansible Automation Platform and codifies many of these practices in rules and profiles to help you quickly identify and enforce consistent application to your work.</p>
<h3 id="mindset-source">Source</h3>
<p><a href="https://www.ansible.com/blog/the-zen-of-ansible" target="_blank">Ansible Blog - The Zen of Ansible</a></p>
<!-- markdownlint-disable --></section><h1 class='nav-section-title-end'>Ended: Mindset</h1>
                        <h1 class='nav-section-title' id='section-ansible'>
                            Ansible <a class='headerlink' href='#section-ansible' title='Permanent link'>↵</a>
                        </h1>
                        <section class="print-page" id="ansible"><h1 id="ansible-ansible">Ansible</h1>
<p>This topic is split into seven main sections, each section covers a different aspect of automation using Ansible.</p>
<div class="grid cards">
<ul>
<li>
<p><a href="#ansible-installation"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 0a8.2 8.2 0 0 1 .701.031C9.444.095 9.99.645 10.16 1.29l.288 1.107c.018.066.079.158.212.224.231.114.454.243.668.386.123.082.233.09.299.071l1.103-.303c.644-.176 1.392.021 1.82.63.27.385.506.792.704 1.218.315.675.111 1.422-.364 1.891l-.814.806c-.049.048-.098.147-.088.294.016.257.016.515 0 .772-.01.147.038.246.088.294l.814.806c.475.469.679 1.216.364 1.891a7.977 7.977 0 0 1-.704 1.217c-.428.61-1.176.807-1.82.63l-1.102-.302c-.067-.019-.177-.011-.3.071a5.909 5.909 0 0 1-.668.386c-.133.066-.194.158-.211.224l-.29 1.106c-.168.646-.715 1.196-1.458 1.26a8.006 8.006 0 0 1-1.402 0c-.743-.064-1.289-.614-1.458-1.26l-.289-1.106c-.018-.066-.079-.158-.212-.224a5.738 5.738 0 0 1-.668-.386c-.123-.082-.233-.09-.299-.071l-1.103.303c-.644.176-1.392-.021-1.82-.63a8.12 8.12 0 0 1-.704-1.218c-.315-.675-.111-1.422.363-1.891l.815-.806c.05-.048.098-.147.088-.294a6.214 6.214 0 0 1 0-.772c.01-.147-.038-.246-.088-.294l-.815-.806C.635 6.045.431 5.298.746 4.623a7.92 7.92 0 0 1 .704-1.217c.428-.61 1.176-.807 1.82-.63l1.102.302c.067.019.177.011.3-.071.214-.143.437-.272.668-.386.133-.066.194-.158.211-.224l.29-1.106C6.009.645 6.556.095 7.299.03 7.53.01 7.764 0 8 0Zm-.571 1.525c-.036.003-.108.036-.137.146l-.289 1.105c-.147.561-.549.967-.998 1.189-.173.086-.34.183-.5.29-.417.278-.97.423-1.529.27l-1.103-.303c-.109-.03-.175.016-.195.045-.22.312-.412.644-.573.99-.014.031-.021.11.059.19l.815.806c.411.406.562.957.53 1.456a4.709 4.709 0 0 0 0 .582c.032.499-.119 1.05-.53 1.456l-.815.806c-.081.08-.073.159-.059.19.162.346.353.677.573.989.02.03.085.076.195.046l1.102-.303c.56-.153 1.113-.008 1.53.27.161.107.328.204.501.29.447.222.85.629.997 1.189l.289 1.105c.029.109.101.143.137.146a6.6 6.6 0 0 0 1.142 0c.036-.003.108-.036.137-.146l.289-1.105c.147-.561.549-.967.998-1.189.173-.086.34-.183.5-.29.417-.278.97-.423 1.529-.27l1.103.303c.109.029.175-.016.195-.045.22-.313.411-.644.573-.99.014-.031.021-.11-.059-.19l-.815-.806c-.411-.406-.562-.957-.53-1.456a4.709 4.709 0 0 0 0-.582c-.032-.499.119-1.05.53-1.456l.815-.806c.081-.08.073-.159.059-.19a6.464 6.464 0 0 0-.573-.989c-.02-.03-.085-.076-.195-.046l-1.102.303c-.56.153-1.113.008-1.53-.27a4.44 4.44 0 0 0-.501-.29c-.447-.222-.85-.629-.997-1.189l-.289-1.105c-.029-.11-.101-.143-.137-.146a6.6 6.6 0 0 0-1.142 0ZM11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM9.5 8a1.5 1.5 0 1 0-3.001.001A1.5 1.5 0 0 0 9.5 8Z"/></svg></span> &nbsp; Installation</a></p>
<hr />
<p>How to install Ansible and run it, from present to future.</p>
</li>
<li>
<p><a href="#ansible-project"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 0 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 1 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5Zm10.5-1h-8a1 1 0 0 0-1 1v6.708A2.486 2.486 0 0 1 4.5 9h8ZM5 12.25a.25.25 0 0 1 .25-.25h3.5a.25.25 0 0 1 .25.25v3.25a.25.25 0 0 1-.4.2l-1.45-1.087a.249.249 0 0 0-.3 0L5.4 15.7a.25.25 0 0 1-.4-.2Z"/></svg></span> &nbsp; Project</a></p>
<hr />
<p>Your Ansible project, versioning control, dependencies, syntax</p>
</li>
<li>
<p><a href="#ansible-inventory"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1.75 1h12.5c.966 0 1.75.784 1.75 1.75v4c0 .372-.116.717-.314 1 .198.283.314.628.314 1v4a1.75 1.75 0 0 1-1.75 1.75H1.75A1.75 1.75 0 0 1 0 12.75v-4c0-.358.109-.707.314-1a1.739 1.739 0 0 1-.314-1v-4C0 1.784.784 1 1.75 1ZM1.5 2.75v4c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-4a.25.25 0 0 0-.25-.25H1.75a.25.25 0 0 0-.25.25Zm.25 5.75a.25.25 0 0 0-.25.25v4c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-4a.25.25 0 0 0-.25-.25ZM7 4.75A.75.75 0 0 1 7.75 4h4.5a.75.75 0 0 1 0 1.5h-4.5A.75.75 0 0 1 7 4.75ZM7.75 10h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM3 4.75A.75.75 0 0 1 3.75 4h.5a.75.75 0 0 1 0 1.5h-.5A.75.75 0 0 1 3 4.75ZM3.75 10h.5a.75.75 0 0 1 0 1.5h-.5a.75.75 0 0 1 0-1.5Z"/></svg></span> &nbsp; Inventory</a></p>
<hr />
<p>How to define your inventory and target hosts</p>
</li>
<li>
<p><a href="#ansible-playbook"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M14.064 0h.186C15.216 0 16 .784 16 1.75v.186a8.752 8.752 0 0 1-2.564 6.186l-.458.459c-.314.314-.641.616-.979.904v3.207c0 .608-.315 1.172-.833 1.49l-2.774 1.707a.749.749 0 0 1-1.11-.418l-.954-3.102a1.214 1.214 0 0 1-.145-.125L3.754 9.816a1.218 1.218 0 0 1-.124-.145L.528 8.717a.749.749 0 0 1-.418-1.11l1.71-2.774A1.748 1.748 0 0 1 3.31 4h3.204c.288-.338.59-.665.904-.979l.459-.458A8.749 8.749 0 0 1 14.064 0ZM8.938 3.623h-.002l-.458.458c-.76.76-1.437 1.598-2.02 2.5l-1.5 2.317 2.143 2.143 2.317-1.5c.902-.583 1.74-1.26 2.499-2.02l.459-.458a7.25 7.25 0 0 0 2.123-5.127V1.75a.25.25 0 0 0-.25-.25h-.186a7.249 7.249 0 0 0-5.125 2.123ZM3.56 14.56c-.732.732-2.334 1.045-3.005 1.148a.234.234 0 0 1-.201-.064.234.234 0 0 1-.064-.201c.103-.671.416-2.273 1.15-3.003a1.502 1.502 0 1 1 2.12 2.12Zm6.94-3.935c-.088.06-.177.118-.266.175l-2.35 1.521.548 1.783 1.949-1.2a.25.25 0 0 0 .119-.213ZM3.678 8.116 5.2 5.766c.058-.09.117-.178.176-.266H3.309a.25.25 0 0 0-.213.119l-1.2 1.95ZM12 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg></span> &nbsp; Playbook</a></p>
<hr />
<p>Structure your automation, how to separate playbooks and plays</p>
</li>
<li>
<p><a href="#ansible-roles"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M7.122.392a1.75 1.75 0 0 1 1.756 0l5.003 2.902c.83.481.83 1.68 0 2.162L8.878 8.358a1.75 1.75 0 0 1-1.756 0L2.119 5.456a1.251 1.251 0 0 1 0-2.162ZM8.125 1.69a.248.248 0 0 0-.25 0l-4.63 2.685 4.63 2.685a.248.248 0 0 0 .25 0l4.63-2.685ZM1.601 7.789a.75.75 0 0 1 1.025-.273l5.249 3.044a.248.248 0 0 0 .25 0l5.249-3.044a.75.75 0 0 1 .752 1.298l-5.248 3.044a1.75 1.75 0 0 1-1.756 0L1.874 8.814A.75.75 0 0 1 1.6 7.789Zm0 3.5a.75.75 0 0 1 1.025-.273l5.249 3.044a.248.248 0 0 0 .25 0l5.249-3.044a.75.75 0 0 1 .752 1.298l-5.248 3.044a1.75 1.75 0 0 1-1.756 0l-5.248-3.044a.75.75 0 0 1-.273-1.025Z"/></svg></span> &nbsp; Roles</a></p>
<hr />
<p>A best practice in itself, including how to create and fill the role folder</p>
</li>
<li>
<p><a href="#ansible-tasks"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M5 3.25a.75.75 0 0 1 .75-.75h8.5a.75.75 0 0 1 0 1.5h-8.5A.75.75 0 0 1 5 3.25Zm0 5a.75.75 0 0 1 .75-.75h8.5a.75.75 0 0 1 0 1.5h-8.5A.75.75 0 0 1 5 8.25Zm0 5a.75.75 0 0 1 .75-.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1-.75-.75ZM.924 10.32a.5.5 0 0 1-.851-.525l.001-.001.001-.002.002-.004.007-.011c.097-.144.215-.273.348-.384.228-.19.588-.392 1.068-.392.468 0 .858.181 1.126.484.259.294.377.673.377 1.038 0 .987-.686 1.495-1.156 1.845l-.047.035c-.303.225-.522.4-.654.597h1.357a.5.5 0 0 1 0 1H.5a.5.5 0 0 1-.5-.5c0-1.005.692-1.52 1.167-1.875l.035-.025c.531-.396.8-.625.8-1.078a.57.57 0 0 0-.128-.376C1.806 10.068 1.695 10 1.5 10a.658.658 0 0 0-.429.163.835.835 0 0 0-.144.153ZM2.003 2.5V6h.503a.5.5 0 0 1 0 1H.5a.5.5 0 0 1 0-1h.503V3.308l-.28.14a.5.5 0 0 1-.446-.895l1.003-.5a.5.5 0 0 1 .723.447Z"/></svg></span> &nbsp; Tasks</a></p>
<hr />
<p>Everything about tasks, module usage, tags, loops and filters</p>
</li>
<li>
<p><a href="#ansible-variables"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M5.75 7.5h7.5a.75.75 0 0 1 0 1.5h-7.5a.75.75 0 0 1 0-1.5Zm0 5h7.5a.75.75 0 0 1 0 1.5h-7.5a.75.75 0 0 1 0-1.5Zm-4-10h6.5a.75.75 0 0 1 0 1.5h-6.5a.75.75 0 0 1 0-1.5ZM2 14a1 1 0 1 1 0-2 1 1 0 0 1 0 2Zm1-6a1 1 0 1 1-2 0 1 1 0 0 1 2 0Zm10.314-3.082L11.07 2.417A.25.25 0 0 1 11.256 2h4.488a.25.25 0 0 1 .186.417l-2.244 2.5a.25.25 0 0 1-.372 0Z"/></svg></span> &nbsp; Variables</a></p>
<hr />
<p>All about variables, where to store them, naming conventions and encryption</p>
</li>
</ul>
</div>
<!-- markdownlint-disable --></section><section class="print-page" id="ansible-installation"><h1 id="ansible-installation-installation">Installation</h1>
<h2 id="ansible-installation-standard-install-method">Standard install method</h2>
<p>The latest version can only be obtained via the Python package manager, the <em>ansible-core</em> package contains the binaries and 69 standard modules.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#ansible-installation-__codelineno-0-1"></a><span class="go">pip3 install ansible-core</span>
</code></pre></div>
<p>The included modules can be listed with <code>ansible-doc --list ansible.builtin</code>.<br />
If more special modules are needed, the complete <em>ansible</em> package can be installed, this corresponds to the "old" installation method (<em>batteries included</em>).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#ansible-installation-__codelineno-1-1"></a><span class="go">pip3 install ansible</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>It makes sense to install <strong>only the <em>ansible-core</em> package</strong>. Afterwards, install the few collections necessary for your project via <code>ansible-galaxy</code>.
This way you have an up-to-date, lean installation without unnecessary modules and plugins.<br />
Take a look at the following section for the recommended installation.</p>
</div>
<p>Most OS package managers like <em>apt</em> or <em>yum</em> also provide the <code>ansible-core</code> or <code>ansible</code> packages, these versions are not latest but a couple of minor versions behind.</p>
<details class="example">
<summary>Installing Ansible with OS package manager</summary>
<p>Even in fairly recent distributions the Ansible versions are not up to date:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#ansible-installation-__codelineno-2-1"></a><span class="gp">$ </span>pip3<span class="w"> </span>show<span class="w"> </span>ansible-core
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#ansible-installation-__codelineno-2-2"></a><span class="go">Name: ansible-core</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#ansible-installation-__codelineno-2-3"></a><span class="go">Version: 2.14.3</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#ansible-installation-__codelineno-2-4"></a><span class="go">...</span>
</code></pre></div>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#ansible-installation-__codelineno-3-1"></a><span class="gp">$ </span>dnf<span class="w"> </span>info<span class="w"> </span>ansible-core
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#ansible-installation-__codelineno-3-2"></a><span class="go">Available Packages</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#ansible-installation-__codelineno-3-3"></a><span class="go">Name         : ansible-core</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#ansible-installation-__codelineno-3-4"></a><span class="go">Version      : 2.13.3</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#ansible-installation-__codelineno-3-5"></a><span class="go">Release      : 2.el8_7</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#ansible-installation-__codelineno-3-6"></a><span class="go">Architecture : x86_64</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#ansible-installation-__codelineno-3-7"></a><span class="go">Size         : 2.8 M</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#ansible-installation-__codelineno-3-8"></a><span class="go">Source       : ansible-core-2.13.3-2.el8_7.src.rpm</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#ansible-installation-__codelineno-3-9"></a><span class="go">Repository   : appstream</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#ansible-installation-__codelineno-3-10"></a><span class="go">...</span>
</code></pre></div>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#ansible-installation-__codelineno-4-1"></a><span class="gp">$ </span>apt<span class="w"> </span>info<span class="w"> </span>ansible-core
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#ansible-installation-__codelineno-4-2"></a><span class="go">Package: ansible-core</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#ansible-installation-__codelineno-4-3"></a><span class="go">Version: 2.12.0-1ubuntu0.1</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#ansible-installation-__codelineno-4-4"></a><span class="go">Priority: optional</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#ansible-installation-__codelineno-4-5"></a><span class="go">Section: universe/admin</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#ansible-installation-__codelineno-4-6"></a><span class="go">Origin: Ubuntu</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#ansible-installation-__codelineno-4-7"></a><span class="go">...</span>
</code></pre></div>
</details>
<h3 id="ansible-installation-install-collections">Install Collections</h3>
<p>The recommended installation method is through the Python package manager, necessary modules and plugins not included in the <code>ansible-core</code> binary are installed through <em>collections</em>.<br />
Additional collections (the included collection is called <em>ansible.builtin</em>) are installed with the <code>ansible-galaxy</code> command-line utility:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#ansible-installation-__codelineno-5-1"></a><span class="go">ansible-galaxy collection install community.general</span>
</code></pre></div>
<p>Multiple collections can be installed at once with a <code>requirements.yml</code> file.</p>
<p>Thereby the <a href="#ansible-project-collections">chapter Project &gt; Collections</a> is to be considered. If a container runtime is available, the complete installation can also be bundled in a container image (so-called <em>Execution Environment</em>).</p>
<p>By default, collections are installed into a (hidden) folder in the home directory (<code>~/.ansible/collections/ansible_collections/</code>). This is defined by the <code>collections_path</code> configuration setting.</p>
<p>If you want to store collections alongside you project, create a folder <code>collections</code> in your project directory and install collections by providing the <code>--collections-path</code> (<code>-p</code>) argument:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#ansible-installation-__codelineno-6-1"></a><span class="go">ansible-galaxy collection install community.general --collections-path ./collections/</span>
</code></pre></div>
<h4 id="ansible-installation-list-installed-collections">List installed collections</h4>
<p>Show the name and version of each collection installed in the <code>collections_path</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#ansible-installation-__codelineno-7-1"></a><span class="go">ansible-galaxy collection list</span>
</code></pre></div>
<h4 id="ansible-installation-upgrade-installed-collections">Upgrade installed collections</h4>
<p>To upgrade installed collections use the <code>--upgrade</code> (<code>-U</code>) argument:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#ansible-installation-__codelineno-8-1"></a><span class="go">ansible-galaxy collection install community.general --upgrade</span>
</code></pre></div>
<h4 id="ansible-installation-install-collections-offline">Install collections offline</h4>
<p>Download the collection tarball from <a href="https://galaxy.ansible.com/" target="_blank">Galaxy</a> for offline use:</p>
<ol>
<li>Navigate to the collection page.</li>
<li>Click on <em>Download tarball</em>.</li>
<li>Copy the archive to the remote server.</li>
<li>
<p>Install the collection with the <code>ansible-galaxy</code> CLI utility, use the <code>--offline</code> argument:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#ansible-installation-__codelineno-9-1"></a><span class="go">ansible-galaxy collection install ~/community-general-6.4.0.tar.gz --offline</span>
</code></pre></div>
</li>
</ol>
<h2 id="ansible-installation-execution-environments">Execution environments</h2>
<p>Execution Environments are container images that serve as Ansible control nodes.<br />
<abbr title="Execution Environments">EEs</abbr> provide you with:</p>
<ul>
<li>Software dependency isolation</li>
<li>Portability across teams and environments</li>
<li>Separation from other automation content and tooling</li>
</ul>
<h3 id="ansible-installation-ansible-builder">Ansible Builder</h3>
<p>Ansible Builder is a tool that aids in the creation of Ansible Execution Environments. It does this by using the dependency information defined in various Ansible Content Collections, as well as by the user. Ansible Builder will produce a directory that acts as the build context for the container image build, which will contain the <em>Containerfile</em> (<em>Dockerfile</em>), along with any other files that need to be added to the image. There is no need to write a single line of Dockerfile, which makes it easy to build and use Execution Environments.</p>
<p>To build an <abbr title="Execution Environment">EE</abbr>, install <code>ansible-builder</code> from the Python Package Manager:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#ansible-installation-__codelineno-10-1"></a><span class="go">pip3 install ansible-builder</span>
</code></pre></div>
<p>Define at least the definition file for the Execution Environment and other files, depending on your use-case.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:4"><input checked="checked" id="ansible-installation-__tabbed_1_1" name="ansible-installation-__tabbed_1" type="radio" /><input id="ansible-installation-__tabbed_1_2" name="ansible-installation-__tabbed_1" type="radio" /><input id="ansible-installation-__tabbed_1_3" name="ansible-installation-__tabbed_1" type="radio" /><input id="ansible-installation-__tabbed_1_4" name="ansible-installation-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="ansible-installation-__tabbed_1_1"><abbr title="Execution Environment">EE</abbr> definition file</label><label for="ansible-installation-__tabbed_1_2">Collection Dependencies</label><label for="ansible-installation-__tabbed_1_3">Python Dependencies</label><label for="ansible-installation-__tabbed_1_4">Cross-Platform requirements</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">execution-environment.yml</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#ansible-installation-__codelineno-11-1"></a><span class="nn">---</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#ansible-installation-__codelineno-11-2"></a><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#ansible-installation-__codelineno-11-3"></a>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#ansible-installation-__codelineno-11-4"></a><span class="nt">images</span><span class="p">:</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#ansible-installation-__codelineno-11-5"></a><span class="w">  </span><span class="nt">base_image</span><span class="p">:</span><span class="w"> </span><span class="c1"># (1)!</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#ansible-installation-__codelineno-11-6"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/ansible-community/community-ee-base:latest</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#ansible-installation-__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#ansible-installation-__codelineno-11-8"></a><span class="nt">dependencies</span><span class="p">:</span><span class="w"> </span><span class="c1"># (2)!</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#ansible-installation-__codelineno-11-9"></a><span class="w">  </span><span class="nt">galaxy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">requirements.yml</span><span class="w"> </span><span class="c1"># (3)!</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#ansible-installation-__codelineno-11-10"></a><span class="w">  </span><span class="nt">python</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">requirements.txt</span><span class="w"> </span><span class="c1"># (4)!</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#ansible-installation-__codelineno-11-11"></a><span class="w">  </span><span class="nt">system</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bindep.txt</span>
</code></pre></div>
<ol>
<li>Some more useful base images are (take a look if a more recent tag is available):<ul>
<li>quay.io/rockylinux/rockylinux:9</li>
<li>ghcr.io/ansible-community/community-ee-minimal:latest</li>
<li>registry.redhat.io/ansible-automation-platform-24/ee-supported-rhel9:1.0.0-456</li>
<li>registry.redhat.io/ansible-automation-platform/ee-minimal-rhel9::2.15.5-4</li>
</ul>
</li>
<li>If you want to install a specific Ansible version add this configuration under the <code>dependencies</code> key:
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#ansible-installation-__codelineno-12-1"></a><span class="nt">dependencies</span><span class="p">:</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#ansible-installation-__codelineno-12-2"></a><span class="w">  </span><span class="nt">ansible_core</span><span class="p">:</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#ansible-installation-__codelineno-12-3"></a><span class="w">    </span><span class="nt">package_pip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible-core==2.14.3</span>
</code></pre></div></li>
<li>Instead of using a separate file, you can provide collections (and roles) as a list:
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#ansible-installation-__codelineno-13-1"></a><span class="nt">dependencies</span><span class="p">:</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#ansible-installation-__codelineno-13-2"></a><span class="w">  </span><span class="nt">galaxy</span><span class="p">:</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#ansible-installation-__codelineno-13-3"></a><span class="w">    </span><span class="nt">collections</span><span class="p">:</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#ansible-installation-__codelineno-13-4"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.core</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#ansible-installation-__codelineno-13-5"></a><span class="w">    </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#ansible-installation-__codelineno-13-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">timgrt.terraform</span>
</code></pre></div></li>
<li>Instead of using a separate file, you can provide the Python packages as a list:
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#ansible-installation-__codelineno-14-1"></a><span class="nt">dependencies</span><span class="p">:</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#ansible-installation-__codelineno-14-2"></a><span class="w">  </span><span class="nt">python</span><span class="p">:</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#ansible-installation-__codelineno-14-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">awxkit</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#ansible-installation-__codelineno-14-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">boto</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#ansible-installation-__codelineno-14-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">botocore</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#ansible-installation-__codelineno-14-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">boto3</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#ansible-installation-__codelineno-14-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openshift</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#ansible-installation-__codelineno-14-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">requests-oauthlib</span>
</code></pre></div></li>
</ol>
</div>
</div>
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">requirements.yml</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#ansible-installation-__codelineno-15-1"></a><span class="nn">---</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#ansible-installation-__codelineno-15-2"></a><span class="nt">collections</span><span class="p">:</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#ansible-installation-__codelineno-15-3"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redhat.openshift</span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">requirements.txt</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#ansible-installation-__codelineno-16-1"></a>awxkit&gt;=13.0.0
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#ansible-installation-__codelineno-16-2"></a>boto&gt;=2.49.0
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#ansible-installation-__codelineno-16-3"></a>botocore&gt;=1.12.249
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#ansible-installation-__codelineno-16-4"></a>boto3&gt;=1.9.249
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#ansible-installation-__codelineno-16-5"></a>openshift&gt;=0.6.2
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#ansible-installation-__codelineno-16-6"></a>requests-oauthlib
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">bindep.txt</p>
<p>If there are RPMS necessary, put them here.
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#ansible-installation-__codelineno-17-1"></a>subversion [platform:rpm]
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#ansible-installation-__codelineno-17-2"></a>subversion [platform:dpkg]
</code></pre></div></p>
</div>
</div>
</div>
</div>
<details class="failure">
<summary>Package manager not found?</summary>
<p>In case you see an error like this: <code>unable to execute /usr/bin/dnf: No such file or directory</code>.
This can happen when using RHEL minimal images, you need to adjust the package manager path. Add the following setting to your <code>execution-environment.yml</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#ansible-installation-__codelineno-18-1"></a><span class="nt">options</span><span class="p">:</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#ansible-installation-__codelineno-18-2"></a><span class="w">  </span><span class="nt">package_manager_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/bin/microdnf</span>
</code></pre></div>
</details>
<p>For more information, go to the <a href="https://ansible-builder.readthedocs.io/en/stable/" target="_blank">Ansible Builder Documentation</a>.</p>
<p>To build the <abbr title="Execution Environment">EE</abbr>, run this command (assuming you have Docker installed, by default Podman is used):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#ansible-installation-__codelineno-19-1"></a><span class="go">ansible-builder build --tag=demo/openshift-ee --container-runtime=docker -v=3</span>
</code></pre></div>
<p>The resulting container images can be viewed with the <code>docker images</code> command:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#ansible-installation-__codelineno-20-1"></a><span class="gp">$ </span>docker<span class="w"> </span>images
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#ansible-installation-__codelineno-20-2"></a><span class="go">REPOSITORY                        TAG       IMAGE ID       CREATED              SIZE</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#ansible-installation-__codelineno-20-3"></a><span class="go">demo/openshift-ee                 latest    2ea9d5d7b185   10 seconds ago       1.14GB</span>
</code></pre></div>
<p>You can also build Execution Environments with <em>ansible-navigator</em>, the Builder is installed alongside Navigator.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#ansible-installation-__codelineno-21-1"></a><span class="go">ansible-navigator builder build --tag=demo/openshift-ee --container-runtime=docker</span>
</code></pre></div>
<h3 id="ansible-installation-ansible-runner">Ansible Runner</h3>
<p>Using the <abbr title="Execution Environment">EE</abbr> requires a binary which can make use of the Container images, it is not possible to run them with the <code>ansible-playbook</code> binary. You have to use (and install) either the <code>ansible-navigator</code> or the <code>ansible-runner</code> binary.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The <em>Ansible Navigator</em> is easier to use than the <code>ansible-runner</code>, use this one for creating, reviewing, running and troubleshooting Ansible content, including inventories, playbooks, collections, documentation and execution environments.  </p>
</div>
<p>Ansible Runner is a tool and python library to provide a stable and consistent interface abstraction to Ansible, it represents the modularization of the part of Ansible AWX that is responsible for running <code>ansible</code> and <code>ansible-playbook</code> tasks and gathers the output from it.</p>
<p>If you want to use it standalone, install the <code>ansible-runner</code> binary:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#ansible-installation-__codelineno-22-1"></a><span class="go">pip3 install ansible-runner</span>
</code></pre></div>
<p>To use the Ansible from the container image, e.g. run this command which executes an ad hoc command (<em>setup</em> module) against localhost:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#ansible-installation-__codelineno-23-1"></a><span class="go">ansible-runner run --container-image demo/openshift-ee /tmp -m setup --hosts localhost</span>
</code></pre></div>
<p>Most parameters should be self-explanatory:</p>
<ul>
<li><em>run</em> - Run ansible-runner in the foreground</li>
<li><em>--container-image demo/openshift</em> - Container image to use when running an ansible task</li>
<li><em>/tmp</em> - base directory containing the ansible-runner metadata (project, inventory, env, etc)</li>
<li><em>-m setup</em> - Module to execute</li>
<li><em>--hosts localhost</em> - set of hosts to execute against (here only localhost)</li>
</ul>
<p>The output looks like expected:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#ansible-installation-__codelineno-24-1"></a><span class="gp">$ </span>ansible-runner<span class="w"> </span>run<span class="w"> </span>--container-image<span class="w"> </span>demo/openshift-ee<span class="w"> </span>/tmp<span class="w"> </span>-m<span class="w"> </span>setup<span class="w"> </span>--hosts<span class="w"> </span>localhost
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#ansible-installation-__codelineno-24-2"></a><span class="go">[WARNING]: No inventory was parsed, only implicit localhost is available</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#ansible-installation-__codelineno-24-3"></a><span class="go">localhost | SUCCESS =&gt; {</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#ansible-installation-__codelineno-24-4"></a><span class="go">    &quot;ansible_facts&quot;: {</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#ansible-installation-__codelineno-24-5"></a><span class="go">        &quot;ansible_all_ipv4_addresses&quot;: [</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#ansible-installation-__codelineno-24-6"></a><span class="go">            &quot;192.168.178.114&quot;,</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#ansible-installation-__codelineno-24-7"></a><span class="go">            &quot;172.17.0.1&quot;</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#ansible-installation-__codelineno-24-8"></a><span class="go">        ],</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#ansible-installation-__codelineno-24-9"></a><span class="go">        &quot;ansible_all_ipv6_addresses&quot;: [</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#ansible-installation-__codelineno-24-10"></a><span class="go">            &quot;2001:9e8:4a14:2401:a00:27ff:febf:4207&quot;,</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#ansible-installation-__codelineno-24-11"></a><span class="go">            &quot;fe80::a00:27ff:febf:4207&quot;,</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#ansible-installation-__codelineno-24-12"></a><span class="go">            &quot;fe80::42:9eff:fef9:df59&quot;</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#ansible-installation-__codelineno-24-13"></a><span class="go">        ],</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#ansible-installation-__codelineno-24-14"></a><span class="go">        &quot;ansible_apparmor&quot;: {</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#ansible-installation-__codelineno-24-15"></a><span class="go">            &quot;status&quot;: &quot;enabled&quot;</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#ansible-installation-__codelineno-24-16"></a><span class="go">        },</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#ansible-installation-__codelineno-24-17"></a><span class="go">        &quot;ansible_architecture&quot;: &quot;x86_64&quot;,</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#ansible-installation-__codelineno-24-18"></a><span class="go">        &quot;ansible_bios_date&quot;: &quot;12/01/2006&quot;,</span>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#ansible-installation-__codelineno-24-19"></a><span class="go">        &quot;ansible_bios_vendor&quot;: &quot;innotek GmbH&quot;,</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#ansible-installation-__codelineno-24-20"></a><span class="go">        &quot;ansible_bios_version&quot;: &quot;VirtualBox&quot;,</span>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#ansible-installation-__codelineno-24-21"></a><span class="go">        &quot;ansible_board_asset_tag&quot;: &quot;NA&quot;,</span>
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#ansible-installation-__codelineno-24-22"></a><span class="go">        &quot;ansible_board_name&quot;: &quot;VirtualBox&quot;,</span>
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#ansible-installation-__codelineno-24-23"></a><span class="go">        &quot;ansible_board_serial&quot;: &quot;NA&quot;,</span>
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#ansible-installation-__codelineno-24-24"></a><span class="go">        &quot;ansible_board_vendor&quot;: &quot;Oracle Corporation&quot;,</span>
<a id="__codelineno-24-25" name="__codelineno-24-25" href="#ansible-installation-__codelineno-24-25"></a><span class="go">        ...</span>
</code></pre></div>
<h3 id="ansible-installation-ansible-navigator">Ansible Navigator</h3>
<p>The <code>ansible-navigator</code> is <em>text-based user interface</em> (<abbr title="Text-based User Interface">TUI</abbr>) for the Red Hat Ansible Automation Platform.
The Navigator also makes use of the Execution Environments and provides an easier to use interface to interact with <abbr title="Execution Environments">EEs</abbr> (than <em>ansible-runner</em>).<br />
Install the <code>ansible-navigator</code> binary and its dependencies with the Python package manager:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#ansible-installation-__codelineno-25-1"></a><span class="go">pip3 install ansible-navigator</span>
</code></pre></div>
<p>If you want to use the Navigator with <abbr title="Execution Environments">EEs</abbr>, you'll need a <em>container runtime</em>, install Docker or Podman an your system.</p>
<p>With the Navigator you, for example, can inspect *<em>all locally available</em> Execution Environments</p>
<p>Take a look at the <a href="#ansible-playbook-with-ansible-navigator">Playbooks section</a> on how to run playbooks in Execution Environments with the Navigator.</p>
<p>Some <code>ansible-navigator</code> commands map to <code>ansible</code> commands (prefix every Navigator command with <code>ansible-navigator</code>):</p>
<table>
<thead>
<tr>
<th>Navigator command</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><nobr><code>exec -- ansible ...</code></nobr></td>
<td>Runs Ansible <em>ad-hoc</em> commands.</td>
</tr>
<tr>
<td><code>builder</code></td>
<td>Builds new execution environments, the <code>ansible-builder</code> utility is installed with <code>ansible-navigator</code>.</td>
</tr>
<tr>
<td><code>config</code></td>
<td>Explore the current ansible configuration as with <code>ansible-config</code>.</td>
</tr>
<tr>
<td><code>doc</code></td>
<td>Explore the documentation for modules and plugins as with <code>ansible-doc</code>.</td>
</tr>
<tr>
<td><code>inventory</code></td>
<td>Inspect the inventory and browser groups and hosts.</td>
</tr>
<tr>
<td><code>lint</code></td>
<td>Runs best-practice checker, <code>ansible-lint</code> needs to be installed locally or in the selected execution-environment.</td>
</tr>
<tr>
<td><code>run</code></td>
<td>Runs Playbooks.</td>
</tr>
<tr>
<td><nobr><code>exec -- ansible-test ...</code></nobr></td>
<td>Executes sanity, unit and integration tests for Collections.</td>
</tr>
<tr>
<td><nobr><code>exec -- ansible-vault ...</code></nobr></td>
<td>Runs utility to encrypt or decrypt Ansible content.</td>
</tr>
</tbody>
</table>
<!-- markdownlint-disable --></section><section class="print-page" id="ansible-project"><h1 id="ansible-project-project">Project</h1>
<h2 id="ansible-project-version-control">Version Control</h2>
<p>Keep your playbooks and inventory file in git (or another version control system), and commit when you make changes to them. This way you have an audit trail describing when and why you changed the rules that are automating your infrastructure.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Always use version control!</p>
</div>
<p>Take a look at the <a href="#development-git">Development section</a> for additional information.</p>
<h2 id="ansible-project-ansible-configuration">Ansible configuration</h2>
<p>Always use a project-specific <code>ansible.cfg</code> in the parent directory of your project. The following configuration can be used as a starting point:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#ansible-project-__codelineno-0-1"></a><span class="k">[defaults]</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#ansible-project-__codelineno-0-2"></a><span class="c1"># Define inventory, no need to provide &#39;-i&#39; anymore.</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#ansible-project-__codelineno-0-3"></a><span class="na">inventory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">inventory/production.ini</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#ansible-project-__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#ansible-project-__codelineno-0-5"></a><span class="c1"># Playbook-Output in YAML instead of JSON</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#ansible-project-__codelineno-0-6"></a><span class="na">callback_result_format</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">yaml</span>
</code></pre></div>
<h3 id="ansible-project-show-check-mode">Show check mode</h3>
<p>The following parameter enables displaying markers when running in check mode.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#ansible-project-__codelineno-1-1"></a><span class="k">[defaults]</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#ansible-project-__codelineno-1-2"></a><span class="na">check_mode_markers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
</code></pre></div>
<p>The markers are <code>DRY RUN</code> at the beginning and ending of playbook execution (when calling <code>ansible-playbook --check</code>) and <code>CHECK MODE</code> as a suffix at every play and task that is run in check mode.</p>
<details class="example">
<summary>Example</summary>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#ansible-project-__codelineno-2-1"></a><span class="gp">$ </span>ansible-playbook<span class="w"> </span>-i<span class="w"> </span>inventory.ini<span class="w"> </span>playbook.yml<span class="w"> </span>-C
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#ansible-project-__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#ansible-project-__codelineno-2-3"></a><span class="go">DRY RUN ******************************************************************</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#ansible-project-__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#ansible-project-__codelineno-2-5"></a><span class="go">PLAY [Install and configure Worker Nodes] [CHECK MODE] *******************</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#ansible-project-__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#ansible-project-__codelineno-2-7"></a><span class="go">TASK [Gathering Facts] [CHECK MODE] **************************************</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#ansible-project-__codelineno-2-8"></a><span class="go">ok: [k8s-worker1]</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#ansible-project-__codelineno-2-9"></a><span class="go">ok: [k8s-worker2]</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#ansible-project-__codelineno-2-10"></a><span class="go">ok: [k8s-worker2]</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#ansible-project-__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#ansible-project-__codelineno-2-12"></a><span class="go">...</span>
</code></pre></div>
</details>
<h3 id="ansible-project-show-task-path-when-failed">Show task path when failed</h3>
<p>For easier development when handling with very big playbooks, it may be useful to know which file holds the failed task. To display the path to the file containing the failed task and the line number, add this parameter:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#ansible-project-__codelineno-3-1"></a><span class="k">[defaults]</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#ansible-project-__codelineno-3-2"></a><span class="na">show_task_path_on_failure</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
</code></pre></div>
<details class="example">
<summary>Example</summary>
<p>When set to <code>true</code>:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#ansible-project-__codelineno-4-1"></a><span class="go">...</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#ansible-project-__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#ansible-project-__codelineno-4-3"></a><span class="go">TASK [Set motd message for k8s worker node] **************************************************</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#ansible-project-__codelineno-4-4"></a><span class="go">task path: /home/timgrt/kubernetes-installation/roles/kube-worker/tasks/configure.yml:39</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#ansible-project-__codelineno-4-5"></a><span class="go">fatal: [k8s-worker1]: FAILED! =&gt;</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#ansible-project-__codelineno-4-6"></a><span class="go">...</span>
</code></pre></div>
<p>When set to <code>false</code>:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#ansible-project-__codelineno-5-1"></a><span class="go">...</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#ansible-project-__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#ansible-project-__codelineno-5-3"></a><span class="go">TASK [Set motd message for k8s worker node] ****************************************************</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#ansible-project-__codelineno-5-4"></a><span class="go">fatal: [k8s-worker1]: FAILED! =&gt;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#ansible-project-__codelineno-5-5"></a><span class="go">...</span>
</code></pre></div>
</details>
<p>Even if you don't set this, the path is displayed automatically for every task when running with <code>-vv</code> or greater verbosity, but you'll need to run the playbook again.</p>
<h2 id="ansible-project-dependencies">Dependencies</h2>
<p>Your project will have certain dependencies, make sure to provide a <code>requirements.yml</code> for necessary Ansible collections and a <code>requirements.txt</code> for necessary Python packages.<br />
Consider using <a href="#ansible-installation-execution-environments"><em>Execution Environments</em></a> where all dependencies are combined in a Container Image.</p>
<h3 id="ansible-project-collections">Collections</h3>
<p>Always provide a <code>requirements.yml</code> with <strong>all</strong> collections used within your project.<br />
This makes sure that required collections can be installed, if only the <em>ansible-core</em> binary is installed.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#ansible-project-__codelineno-6-1"></a><span class="nn">---</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#ansible-project-__codelineno-6-2"></a><span class="nt">collections</span><span class="p">:</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#ansible-project-__codelineno-6-3"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">community.general</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#ansible-project-__codelineno-6-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible.posix</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#ansible-project-__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#ansible-project-__codelineno-6-6"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cisco.ios</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#ansible-project-__codelineno-6-7"></a><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&gt;=3.1.0&#39;</span><span class="w">  </span>
</code></pre></div>
<p>Install all collections from the <em>requirements</em>-file:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#ansible-project-__codelineno-7-1"></a><span class="go">ansible-galaxy collection install -r requirements.yml</span>
</code></pre></div>
<h3 id="ansible-project-python-packages">Python packages</h3>
<p>Always provide a <code>requirements.txt</code> with <strong>all</strong> Python packages need by modules used within your project.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#ansible-project-__codelineno-8-1"></a>boto
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#ansible-project-__codelineno-8-2"></a>openshift&gt;=0.6
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#ansible-project-__codelineno-8-3"></a>PyYAML&gt;=3.11
</code></pre></div>
<p>Install all dependencies from the <em>requirements</em>-file:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#ansible-project-__codelineno-9-1"></a><span class="go">pip3 install -r requirements.txt</span>
</code></pre></div>
<h2 id="ansible-project-directory-structure">Directory structure</h2>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#ansible-project-__codelineno-10-1"></a><span class="go">.</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#ansible-project-__codelineno-10-2"></a><span class="go">├── ansible.cfg</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#ansible-project-__codelineno-10-3"></a><span class="go">├── hosts</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#ansible-project-__codelineno-10-4"></a><span class="go">├── k8s-install.yml</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#ansible-project-__codelineno-10-5"></a><span class="go">├── README.md</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#ansible-project-__codelineno-10-6"></a><span class="go">├── requirements.txt</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#ansible-project-__codelineno-10-7"></a><span class="go">├── requirements.yml</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#ansible-project-__codelineno-10-8"></a><span class="go">└── roles</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#ansible-project-__codelineno-10-9"></a><span class="go">    ├── k8s-bootstrap</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#ansible-project-__codelineno-10-10"></a><span class="go">    │   ├── files</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#ansible-project-__codelineno-10-11"></a><span class="go">    │   │   ├── daemon.json</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#ansible-project-__codelineno-10-12"></a><span class="go">    │   │   └── k8s.conf</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#ansible-project-__codelineno-10-13"></a><span class="go">    │   ├── tasks</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#ansible-project-__codelineno-10-14"></a><span class="go">    │   │   ├── install-kubeadm.yml</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#ansible-project-__codelineno-10-15"></a><span class="go">    │   │   ├── main.yml</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#ansible-project-__codelineno-10-16"></a><span class="go">    │   │   └── prerequisites.yml</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#ansible-project-__codelineno-10-17"></a><span class="go">    │   └── templates</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#ansible-project-__codelineno-10-18"></a><span class="go">    │       └── kubernetes.repo.j2</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#ansible-project-__codelineno-10-19"></a><span class="go">    ├── k8s-control-plane</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#ansible-project-__codelineno-10-20"></a><span class="go">    │   ├── files</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#ansible-project-__codelineno-10-21"></a><span class="go">    │   │   └── kubeconfig.sh</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#ansible-project-__codelineno-10-22"></a><span class="go">    │   └── tasks</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#ansible-project-__codelineno-10-23"></a><span class="go">    │       └── main.yml</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#ansible-project-__codelineno-10-24"></a><span class="go">    └── k8s-worker-nodes</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#ansible-project-__codelineno-10-25"></a><span class="go">        └── tasks</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#ansible-project-__codelineno-10-26"></a><span class="go">            └── main.yml</span>
</code></pre></div>
<h3 id="ansible-project-filenames">Filenames</h3>
<p>Folder- and file-names consisting of multiple words are separated with hyphens (e.g. <code>roles/grafana-deployment/tasks/grafana-installation.yml</code>).<br />
YAML files are saved with the extension <code>.yml</code>.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="ansible-project-__tabbed_1_1" name="ansible-project-__tabbed_1" type="radio" /><input id="ansible-project-__tabbed_1_2" name="ansible-project-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="ansible-project-__tabbed_1_1">Good</label><label for="ansible-project-__tabbed_1_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#ansible-project-__codelineno-11-1"></a><span class="go">.</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#ansible-project-__codelineno-11-2"></a><span class="go">├── ansible.cfg</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#ansible-project-__codelineno-11-3"></a><span class="go">├── hosts</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#ansible-project-__codelineno-11-4"></a><span class="go">├── k8s-install.yml</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#ansible-project-__codelineno-11-5"></a><span class="go">├── README.md</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#ansible-project-__codelineno-11-6"></a><span class="go">├── requirements.yml</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#ansible-project-__codelineno-11-7"></a><span class="go">└── roles</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#ansible-project-__codelineno-11-8"></a><span class="go">    ├── k8s-bootstrap</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#ansible-project-__codelineno-11-9"></a><span class="go">    │   ├── files</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#ansible-project-__codelineno-11-10"></a><span class="go">    │   │   ├── daemon.json</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#ansible-project-__codelineno-11-11"></a><span class="go">    │   │   └── k8s.conf</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#ansible-project-__codelineno-11-12"></a><span class="go">    │   ├── tasks</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#ansible-project-__codelineno-11-13"></a><span class="go">    │   │   ├── install-kubeadm.yml</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#ansible-project-__codelineno-11-14"></a><span class="go">    │   │   ├── main.yml</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#ansible-project-__codelineno-11-15"></a><span class="go">    │   │   └── prerequisites.yml</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#ansible-project-__codelineno-11-16"></a><span class="go">    │   └── templates</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#ansible-project-__codelineno-11-17"></a><span class="go">    │       └── kubernetes.repo.j2</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#ansible-project-__codelineno-11-18"></a><span class="go">    ├── k8s-control-plane</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#ansible-project-__codelineno-11-19"></a><span class="go">    │   ├── files</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#ansible-project-__codelineno-11-20"></a><span class="go">    │   │   └── kubeconfig.sh</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#ansible-project-__codelineno-11-21"></a><span class="go">    │   └── tasks</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#ansible-project-__codelineno-11-22"></a><span class="go">    │       └── main.yml</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#ansible-project-__codelineno-11-23"></a><span class="go">    └── k8s-worker-nodes</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#ansible-project-__codelineno-11-24"></a><span class="go">        └── tasks</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#ansible-project-__codelineno-11-25"></a><span class="go">            └── main.yml</span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p>Playbook-name without hyphens and wrong file extension, role folders or task files inconsistent, with underscores and wrong extension.
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#ansible-project-__codelineno-12-1"></a><span class="go">.</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#ansible-project-__codelineno-12-2"></a><span class="go">├── ansible.cfg</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#ansible-project-__codelineno-12-3"></a><span class="go">├── hosts</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#ansible-project-__codelineno-12-4"></a><span class="go">├── k8s-install.yaml</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#ansible-project-__codelineno-12-5"></a><span class="go">├── README.md</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#ansible-project-__codelineno-12-6"></a><span class="go">└── roles</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#ansible-project-__codelineno-12-7"></a><span class="go">    ├── k8s_bootstrap</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#ansible-project-__codelineno-12-8"></a><span class="go">    │   ├── files</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#ansible-project-__codelineno-12-9"></a><span class="go">    │   │   ├── daemon.json</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#ansible-project-__codelineno-12-10"></a><span class="go">    │   │   └── k8s.conf</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#ansible-project-__codelineno-12-11"></a><span class="go">    │   ├── tasks</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#ansible-project-__codelineno-12-12"></a><span class="go">    │   │   ├── installKubeadm.yaml</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#ansible-project-__codelineno-12-13"></a><span class="go">    │   │   ├── main.yml</span>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#ansible-project-__codelineno-12-14"></a><span class="go">    │   │   └── prerequisites.yaml</span>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#ansible-project-__codelineno-12-15"></a><span class="go">    │   └── templates</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#ansible-project-__codelineno-12-16"></a><span class="go">    │       └── kubernetes.repo.j2</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#ansible-project-__codelineno-12-17"></a><span class="go">    ├── k8sControlPlane</span>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#ansible-project-__codelineno-12-18"></a><span class="go">    │   ├── files</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#ansible-project-__codelineno-12-19"></a><span class="go">    │   │   └── kubeconfig.sh</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#ansible-project-__codelineno-12-20"></a><span class="go">    │   └── tasks</span>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#ansible-project-__codelineno-12-21"></a><span class="go">    │       └── main.yaml</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#ansible-project-__codelineno-12-22"></a><span class="go">    └── k8s_worker-nodes</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#ansible-project-__codelineno-12-23"></a><span class="go">        └── tasks</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#ansible-project-__codelineno-12-24"></a><span class="go">            └── main.yaml</span>
</code></pre></div></p>
</div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Subject to change</p>
<p>Maybe this has to change in the future, as <em>collection roles</em> only allow <em>underscores</em> for separation.<br />
See <a href="https://docs.ansible.com/ansible/devel/dev_guide/developing_collections_structure.html#roles-directory">Ansible Docs - Roles directory</a> for more information.<br />
Also, <em>ansible-lint</em> checks role names to ensure they conform these requirements, which must be disabled otherwise.</p>
</div>
<h2 id="ansible-project-yaml-syntax">YAML Syntax</h2>
<p>Following a basic YAML coding style across the whole team improves readability and reusability.</p>
<h3 id="ansible-project-indentation">Indentation</h3>
<p>Two spaces are used to indent everything, e.g. list items or dictionary keys.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="ansible-project-__tabbed_2_1" name="ansible-project-__tabbed_2" type="radio" /><input id="ansible-project-__tabbed_2_2" name="ansible-project-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="ansible-project-__tabbed_2_1">Good</label><label for="ansible-project-__tabbed_2_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<p>Playbook:
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#ansible-project-__codelineno-13-1"></a><span class="nn">---</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#ansible-project-__codelineno-13-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Initialize Control-Plane Nodes</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#ansible-project-__codelineno-13-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubemaster</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#ansible-project-__codelineno-13-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#ansible-project-__codelineno-13-5"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#ansible-project-__codelineno-13-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-control-plane</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#ansible-project-__codelineno-13-7"></a>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#ansible-project-__codelineno-13-8"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install and configure Worker Nodes</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#ansible-project-__codelineno-13-9"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeworker</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#ansible-project-__codelineno-13-10"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#ansible-project-__codelineno-13-11"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#ansible-project-__codelineno-13-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-worker-nodes</span>
</code></pre></div>
Variable-file:
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#ansible-project-__codelineno-14-1"></a><span class="nt">ntp_server_list</span><span class="p">:</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#ansible-project-__codelineno-14-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.de.pool.ntp.org</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#ansible-project-__codelineno-14-3"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.de.pool.ntp.org</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#ansible-project-__codelineno-14-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.de.pool.ntp.org</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#ansible-project-__codelineno-14-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.de.pool.ntp.org</span>
</code></pre></div></p>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p>Playbook with roles <strong>not</strong> indented by two whitespaces.
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#ansible-project-__codelineno-15-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Demo play</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#ansible-project-__codelineno-15-2"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">database_servers</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#ansible-project-__codelineno-15-3"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#ansible-project-__codelineno-15-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">common</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#ansible-project-__codelineno-15-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
</code></pre></div>
List in variable-file indented with four whitespaces:
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#ansible-project-__codelineno-16-1"></a><span class="nt">ntp_server_list</span><span class="p">:</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#ansible-project-__codelineno-16-2"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.de.pool.ntp.org</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#ansible-project-__codelineno-16-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.de.pool.ntp.org</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#ansible-project-__codelineno-16-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.de.pool.ntp.org</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#ansible-project-__codelineno-16-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.de.pool.ntp.org</span>
</code></pre></div></p>
</div>
</div>
</div>
</div>
<p>The so-called YAML "one-line" syntax is not used, neither for passing parameters in tasks, nor for lists or dictionaries.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="ansible-project-__tabbed_3_1" name="ansible-project-__tabbed_3" type="radio" /><input id="ansible-project-__tabbed_3_2" name="ansible-project-__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="ansible-project-__tabbed_3_1">Good</label><label for="ansible-project-__tabbed_3_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#ansible-project-__codelineno-17-1"></a><span class="nn">---</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#ansible-project-__codelineno-17-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install Apache from the testing repo</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#ansible-project-__codelineno-17-3"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#ansible-project-__codelineno-17-4"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#ansible-project-__codelineno-17-5"></a><span class="w">    </span><span class="nt">enablerepo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">testing</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#ansible-project-__codelineno-17-6"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#ansible-project-__codelineno-18-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install a list of packages</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#ansible-project-__codelineno-18-2"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#ansible-project-__codelineno-18-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#ansible-project-__codelineno-18-4"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#ansible-project-__codelineno-18-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresql</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#ansible-project-__codelineno-18-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresql-server</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#ansible-project-__codelineno-18-7"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div></p>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p>Task with <em>One-line</em> syntax:
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#ansible-project-__codelineno-19-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install the latest version of Apache from the testing repo</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#ansible-project-__codelineno-19-2"></a><span class="w">  </span><span class="nt">yum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=httpd enablerepo=testing state=present</span>
</code></pre></div>
List in task with <em>One-line</em> syntax:
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#ansible-project-__codelineno-20-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install a list of packages</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#ansible-project-__codelineno-20-2"></a><span class="w">  </span><span class="nt">yum</span><span class="p">:</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#ansible-project-__codelineno-20-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;nginx&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;postgresql&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;postgresql-server&#39;</span><span class="p p-Indicator">]</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#ansible-project-__codelineno-20-4"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div></p>
</div>
</div>
</div>
</div>
<h3 id="ansible-project-booleans">Booleans</h3>
<p>Use <code>true</code> and <code>false</code> for boolean values in playbooks.<br />
Do not use the Ansible-specific <code>yes</code> and <code>no</code> as boolean values in YAML as these are completely custom extensions used by Ansible and are not part of the YAML spec. Also, avoid the use of the Python-style <code>True</code> and <code>False</code> for boolean values.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="ansible-project-__tabbed_4_1" name="ansible-project-__tabbed_4" type="radio" /><input id="ansible-project-__tabbed_4_2" name="ansible-project-__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="ansible-project-__tabbed_4_1">Good</label><label for="ansible-project-__tabbed_4_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#ansible-project-__codelineno-21-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Start and enable service httpd</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#ansible-project-__codelineno-21-2"></a><span class="w">  </span><span class="nt">ansible.builtin.service</span><span class="p">:</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#ansible-project-__codelineno-21-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#ansible-project-__codelineno-21-4"></a><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#ansible-project-__codelineno-21-5"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">started</span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#ansible-project-__codelineno-22-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Start and enable service httpd</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#ansible-project-__codelineno-22-2"></a><span class="w">  </span><span class="nt">ansible.builtin.service</span><span class="p">:</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#ansible-project-__codelineno-22-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#ansible-project-__codelineno-22-4"></a><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#ansible-project-__codelineno-22-5"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">started</span>
</code></pre></div>
</div>
</div>
</div>
</div>
<p><em>YAML 1.1</em> allows all variants whereas <em>YAML 1.2</em> allows only <em>true/false</em>, you can avoid a massive migration effort for when it becomes the default.</p>
<p>Use the <code>| bool</code> filter when using bare variables (expressions consisting of just one variable reference without any operator) in <code>when</code> conditions.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="ansible-project-__tabbed_5_1" name="ansible-project-__tabbed_5" type="radio" /><input id="ansible-project-__tabbed_5_2" name="ansible-project-__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="ansible-project-__tabbed_5_1">Good</label><label for="ansible-project-__tabbed_5_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<p>Using a variable <code>upgrade_allowed</code> with the default value <code>false</code>, task is executed when overwritten with <code>true</code> value.
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#ansible-project-__codelineno-23-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upgrade all packages, excluding kernel &amp; foo related packages</span><span class="w"> </span><span class="c1"># noqa package-latest</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#ansible-project-__codelineno-23-2"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#ansible-project-__codelineno-23-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*&quot;</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#ansible-project-__codelineno-23-4"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latest</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#ansible-project-__codelineno-23-5"></a><span class="w">    </span><span class="nt">exclude</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kernel*,foo*</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#ansible-project-__codelineno-23-6"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">upgrade_allowed | bool</span>
</code></pre></div></p>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#ansible-project-__codelineno-24-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upgrade all packages, excluding kernel &amp; foo related packages</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#ansible-project-__codelineno-24-2"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#ansible-project-__codelineno-24-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*&quot;</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#ansible-project-__codelineno-24-4"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latest</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#ansible-project-__codelineno-24-5"></a><span class="w">    </span><span class="nt">exclude</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kernel*,foo*</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#ansible-project-__codelineno-24-6"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">upgrade_allowed</span>
</code></pre></div>
</div>
</div>
</div>
</div>
<h3 id="ansible-project-quoting">Quoting</h3>
<p>Do not use quotes unless you have to, especially for short module-keyword-like strings like <em>present</em>, <em>absent</em>, etc.<br />
When using quotes, use the same <em>type</em> of quotes throughout your playbooks. Always use <strong>double quotes</strong> (<code>"</code>), whenever possible.</p>
<h2 id="ansible-project-comments">Comments</h2>
<p>Use loads of comments!<br />
Well, the <em>name</em> parameter should describe your task in detail, but if your task uses multiple filters or regex's, comments should be used for further explanation.<br />
Commented code is generally to be avoided. Playbooks or task files are not committed, if they contain commented out code.  </p>
<div class="admonition bad-practice">
<p class="admonition-title">Bad</p>
<p>Why is the second task commented? Is it not necessary anymore? Does it not work as expected?
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#ansible-project-__codelineno-25-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Change port to {{ grafana_port }}</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#ansible-project-__codelineno-25-2"></a><span class="w">  </span><span class="nt">community.general.ini_file</span><span class="p">:</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#ansible-project-__codelineno-25-3"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/grafana/grafana.ini</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#ansible-project-__codelineno-25-4"></a><span class="w">    </span><span class="nt">section</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#ansible-project-__codelineno-25-5"></a><span class="w">    </span><span class="nt">option</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http_port</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#ansible-project-__codelineno-25-6"></a><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">grafana_port</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#ansible-project-__codelineno-25-7"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#ansible-project-__codelineno-25-8"></a><span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restart grafana</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#ansible-project-__codelineno-25-9"></a>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#ansible-project-__codelineno-25-10"></a><span class="c1"># - name: Change theme to {{ grafana_theme }}</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#ansible-project-__codelineno-25-11"></a><span class="c1">#   ansible.builtin.lineinfile:</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#ansible-project-__codelineno-25-12"></a><span class="c1">#     path: /etc/grafana/grafana.ini</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#ansible-project-__codelineno-25-13"></a><span class="c1">#     regexp: &#39;.*default_theme =&#39;</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#ansible-project-__codelineno-25-14"></a><span class="c1">#     line: &quot;default_theme = {{ grafana_theme }}&quot;</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#ansible-project-__codelineno-25-15"></a><span class="c1">#   become: yes</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#ansible-project-__codelineno-25-16"></a><span class="c1">#   notify: restart grafana</span>
</code></pre></div></p>
<div class="admonition good-practice">
<p class="admonition-title">Comment commented tasks</p>
<p>If you really have to comment the whole task, add a description why, when and by whom it was commented.</p>
</div>
</div>
<!-- markdownlint-disable --></section><section class="print-page" id="ansible-inventory"><h1 id="ansible-inventory-inventory">Inventory</h1>
<p>An <em>inventory</em> is a list of managed nodes, or hosts, that Ansible deploys and configures. The inventory can either be static or dynamic.</p>
<h2 id="ansible-inventory-convert-ini-to-yaml">Convert INI to YAML</h2>
<p>The most common format for the <em>Ansible Inventory</em> is the <code>.ini</code> format, but sometimes you might need the inventory file in the <em>YAML</em> format.<br />
 A <code>.ini</code> inventory file for example might look like this:</p>
<div class="highlight"><span class="filename">inventory.ini</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#ansible-inventory-__codelineno-0-1"></a><span class="k">[control]</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#ansible-inventory-__codelineno-0-2"></a><span class="na">controller ansible_host</span><span class="o">=</span><span class="s">localhost ansible_connection=local</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#ansible-inventory-__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#ansible-inventory-__codelineno-0-4"></a><span class="k">[target]</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#ansible-inventory-__codelineno-0-5"></a><span class="na">rocky8 ansible_connection</span><span class="o">=</span><span class="s">docker</span>
</code></pre></div>
<p>You can convert your existing inventory to the YAML format with the <code>ansible-inventory</code> utility.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#ansible-inventory-__codelineno-1-1"></a><span class="go">ansible-inventory -i inventory.ini -y --list &gt; inventory.yml</span>
</code></pre></div>
<p>The resulting file is your inventory in YAML format:</p>
<div class="highlight"><span class="filename">inventory.yml</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#ansible-inventory-__codelineno-2-1"></a><span class="nt">all</span><span class="p">:</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#ansible-inventory-__codelineno-2-2"></a><span class="w">  </span><span class="nt">children</span><span class="p">:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#ansible-inventory-__codelineno-2-3"></a><span class="w">    </span><span class="nt">control</span><span class="p">:</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#ansible-inventory-__codelineno-2-4"></a><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#ansible-inventory-__codelineno-2-5"></a><span class="w">        </span><span class="nt">controller</span><span class="p">:</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#ansible-inventory-__codelineno-2-6"></a><span class="w">          </span><span class="nt">ansible_connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#ansible-inventory-__codelineno-2-7"></a><span class="w">          </span><span class="nt">ansible_host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#ansible-inventory-__codelineno-2-8"></a><span class="w">    </span><span class="nt">target</span><span class="p">:</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#ansible-inventory-__codelineno-2-9"></a><span class="w">      </span><span class="nt">hosts</span><span class="p">:</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#ansible-inventory-__codelineno-2-10"></a><span class="w">        </span><span class="nt">rocky8</span><span class="p">:</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#ansible-inventory-__codelineno-2-11"></a><span class="w">          </span><span class="nt">ansible_connection</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker</span>
</code></pre></div>
<h2 id="ansible-inventory-static-inventory">Static inventory</h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Work in Progress</strong> - More description necessary.</p>
</div>
<h2 id="ansible-inventory-dynamic-inventory">Dynamic inventory</h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Work in Progress</strong> - More description necessary.</p>
</div>
<h3 id="ansible-inventory-custom-dynamic-inventory">Custom dynamic inventory</h3>
<p>In case no suitable inventory plugin exists, you can easily write your own. Take a look at the <a href="#development-extending-inventory-plugins">Ansible Development - Extending</a> section for additional information.</p>
<!-- markdownlint-disable --></section><section class="print-page" id="ansible-playbook"><h1 id="ansible-playbook-playbooks">Playbooks</h1>
<p><em>Playbooks</em> are first thing you think of when using Ansible. This section describes some good practices.  </p>
<h2 id="ansible-playbook-directory-structure">Directory structure</h2>
<p>The <em>main</em> playbook should have a recognizable name, e.g. referencing the projects name or scope.
If you have multiple playbooks, create a new folder <code>playbooks</code> and store all playbooks there, except the <em>main</em> playbook (here called <code>site.yml</code>).</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#ansible-playbook-__codelineno-0-1"></a><span class="go">.</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#ansible-playbook-__codelineno-0-2"></a><span class="go">├── ansible.cfg</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#ansible-playbook-__codelineno-0-3"></a><span class="go">├── site.yml</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#ansible-playbook-__codelineno-0-4"></a><span class="go">└── playbooks</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#ansible-playbook-__codelineno-0-5"></a><span class="go">    ├── database.yml</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#ansible-playbook-__codelineno-0-6"></a><span class="go">    ├── loadbalancer.yml</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#ansible-playbook-__codelineno-0-7"></a><span class="go">    └── webserver.yml</span>
</code></pre></div>
<p>The <code>site.yml</code> file contains references to the other playbooks:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#ansible-playbook-__codelineno-1-1"></a><span class="nn">---</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#ansible-playbook-__codelineno-1-2"></a><span class="c1"># Main playbook including all other playbooks</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#ansible-playbook-__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#ansible-playbook-__codelineno-1-4"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.import_playbook</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">playbooks/database.yml</span><span class="w"> </span><span class="c1"># noqa name[play]</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#ansible-playbook-__codelineno-1-5"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.import_playbook</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">playbooks/webserver.yml</span><span class="w"> </span><span class="c1"># noqa name[play]</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#ansible-playbook-__codelineno-1-6"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.import_playbook</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">playbooks/loadbalancer.yml</span><span class="w"> </span><span class="c1"># noqa name[play]</span>
</code></pre></div>
<details class="hint">
<summary>Hint</summary>
<p>The file <code>site.yml</code> only references other playbooks, still, the <em>ansible-lint</em> utility would trigger, as every <em>play</em> should have the <code>name</code> parameter.<br />
While this is correct (and you should always name your <strong>actual</strong> <em>plays</em>), the <em>name</em> parameter on <em>import</em> statements is <strong>not shown anyway</strong>, as they are pre-processed at the time playbooks are parsed.  </p>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Therefore, silencing the linter in this particular case with the <code>noqa</code> statement is acceptable.  </p>
</div>
<p>In contrast, <em>include</em> statements like <code>ansible.builtin.include_tasks</code> should have the <code>name</code> parameter, as these statements are processed when they are encountered during the execution of the playbook.</p>
</details>
<p>The <em>lower-level</em> playbooks contains actual <a href="#ansible-playbook-plays"><em>plays</em></a>:</p>
<div class="highlight"><span class="filename">playbooks/database.yml</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#ansible-playbook-__codelineno-2-1"></a><span class="nn">---</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#ansible-playbook-__codelineno-2-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install and configure PostgreSQL database</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#ansible-playbook-__codelineno-2-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_servers</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#ansible-playbook-__codelineno-2-4"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#ansible-playbook-__codelineno-2-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span>
</code></pre></div>
<p>To be able to run the overall playbook, as well as the imported playbooks, add this parameter to your <code>ansible.cfg</code>, otherwise roles are not found:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#ansible-playbook-__codelineno-3-1"></a><span class="k">[defaults]</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#ansible-playbook-__codelineno-3-2"></a><span class="na">roles_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">.roles</span>
</code></pre></div>
<h2 id="ansible-playbook-playbook-definition">Playbook definition</h2>
<p>Don't put too much logic in your playbook, put it in your roles (or even in custom modules).<br />
A playbook <strong>could</strong> contain <code>pre_tasks</code>, <code>roles</code>, <code>tasks</code> and <code>post_tasks</code> sections, try to limit your playbooks to a <strong>list of a roles</strong>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Avoid using both <em>roles</em> and <em>tasks</em> sections, the latter possibly containing <code>import_role</code> or <code>include_role</code> tasks. The order of execution between <em>roles</em> and <em>tasks</em> isn’t obvious, and hence mixing them should be avoided.</p>
</div>
<p>Either you need only static importing of roles and you can use the roles section, or you need dynamic inclusion and you should use only the tasks section. Of course, for very simple cases, you can just use tasks without roles (but playbooks/projects grow quickly, refactor to roles early).</p>
<h3 id="ansible-playbook-plays">Plays</h3>
<p>Avoid putting multiple plays in a playbook, if not really necessary. As every play most likely targets a different host group, create a separate playbook file for it. This way you achieve to most flexibility.</p>
<div class="no-copy highlight"><span class="filename">k8s-installation.yml</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#ansible-playbook-__codelineno-4-1"></a><span class="nn">---</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#ansible-playbook-__codelineno-4-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Initialize Control-Plane Nodes</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#ansible-playbook-__codelineno-4-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubemaster</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#ansible-playbook-__codelineno-4-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#ansible-playbook-__codelineno-4-5"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#ansible-playbook-__codelineno-4-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-control-plane</span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#ansible-playbook-__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#ansible-playbook-__codelineno-4-8"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install and configure Worker Nodes</span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#ansible-playbook-__codelineno-4-9"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeworker</span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#ansible-playbook-__codelineno-4-10"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#ansible-playbook-__codelineno-4-11"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#ansible-playbook-__codelineno-4-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-worker-nodes</span>
</code></pre></div>
<p>Separate the two plays into their respective playbooks files and reference them in an overall playbook file:</p>
<div class="highlight"><span class="filename">k8s-control-plane-playbook.yml</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#ansible-playbook-__codelineno-5-1"></a><span class="nn">---</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#ansible-playbook-__codelineno-5-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Initialize Control-Plane Nodes</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#ansible-playbook-__codelineno-5-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubemaster</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#ansible-playbook-__codelineno-5-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#ansible-playbook-__codelineno-5-5"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#ansible-playbook-__codelineno-5-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-control-plane</span>
</code></pre></div>
<div class="highlight"><span class="filename">k8s-worker-node-playbook.yml</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#ansible-playbook-__codelineno-6-1"></a><span class="nn">---</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#ansible-playbook-__codelineno-6-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install and configure Worker Nodes</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#ansible-playbook-__codelineno-6-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeworker</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#ansible-playbook-__codelineno-6-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#ansible-playbook-__codelineno-6-5"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#ansible-playbook-__codelineno-6-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-worker-nodes</span>
</code></pre></div>
<div class="highlight"><span class="filename">k8s-installation.yml</span><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#ansible-playbook-__codelineno-7-1"></a><span class="nn">---</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#ansible-playbook-__codelineno-7-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.import_playbook</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-control-plane-playbook.yml</span><span class="w"> </span><span class="c1"># noqa name[play]</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#ansible-playbook-__codelineno-7-3"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.import_playbook</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-worker-node-playbook.yml</span><span class="w"> </span><span class="c1"># noqa name[play]</span>
</code></pre></div>
<h3 id="ansible-playbook-module-defaults">Module defaults</h3>
<p>If your playbook uses modules which need the be called with the same set of parameters or arguments, you can define these as <em>module_defaults</em>.<br />
The defaults can be set at <em>play</em>, <em>block</em> or <em>task</em> level.</p>
<p>Module defaults are defined by <a href="https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_module_defaults.html#module-defaults-groups" target="_blank"><em>grouping</em> together modules that share common sets of parameters</a>, especially for modules making heavy use of API-interaction such as cloud modules.  </p>
<p>Since <strong>ansible-core 2.12</strong>, collections can define their own groups in the <code>meta/runtime.yml</code> file. <em>module_defaults</em> does not take the collections keyword into account, so the <em>fully qualified group name</em> must be used for new groups in module_defaults.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="ansible-playbook-__tabbed_1_1" name="ansible-playbook-__tabbed_1" type="radio" /><input id="ansible-playbook-__tabbed_1_2" name="ansible-playbook-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="ansible-playbook-__tabbed_1_1">Good</label><label for="ansible-playbook-__tabbed_1_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#ansible-playbook-__codelineno-8-1"></a><span class="nn">---</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#ansible-playbook-__codelineno-8-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Demo play with modules which need to call the same arguments</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#ansible-playbook-__codelineno-8-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aci</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#ansible-playbook-__codelineno-8-4"></a><span class="hll"><span class="w">  </span><span class="nt">module_defaults</span><span class="p">:</span>
</span><a id="__codelineno-8-5" name="__codelineno-8-5" href="#ansible-playbook-__codelineno-8-5"></a><span class="hll"><span class="w">    </span><span class="nt">group/cisco.aci.all</span><span class="p">:</span>
</span><a id="__codelineno-8-6" name="__codelineno-8-6" href="#ansible-playbook-__codelineno-8-6"></a><span class="hll"><span class="w">      </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">apic_api</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><a id="__codelineno-8-7" name="__codelineno-8-7" href="#ansible-playbook-__codelineno-8-7"></a><span class="hll"><span class="w">      </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">apic_user</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><a id="__codelineno-8-8" name="__codelineno-8-8" href="#ansible-playbook-__codelineno-8-8"></a><span class="hll"><span class="w">      </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">apic_password</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><a id="__codelineno-8-9" name="__codelineno-8-9" href="#ansible-playbook-__codelineno-8-9"></a><span class="w">      </span><span class="nt">validate_certs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#ansible-playbook-__codelineno-8-10"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#ansible-playbook-__codelineno-8-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Get system info</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#ansible-playbook-__codelineno-8-12"></a><span class="w">      </span><span class="nt">cisco.aci.aci_system</span><span class="p">:</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#ansible-playbook-__codelineno-8-13"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">query</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#ansible-playbook-__codelineno-8-14"></a>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#ansible-playbook-__codelineno-8-15"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create a new demo tenant</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#ansible-playbook-__codelineno-8-16"></a><span class="w">      </span><span class="nt">cisco.aci.aci_tenant</span><span class="p">:</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#ansible-playbook-__codelineno-8-17"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo-tenant</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#ansible-playbook-__codelineno-8-18"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Tenant for demo purposes</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#ansible-playbook-__codelineno-8-19"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p>Authentication parameters are repeated in every task.
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#ansible-playbook-__codelineno-9-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Demo play with modules which need to call the same arguments</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#ansible-playbook-__codelineno-9-2"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aci</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#ansible-playbook-__codelineno-9-3"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#ansible-playbook-__codelineno-9-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Get system info</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#ansible-playbook-__codelineno-9-5"></a><span class="w">      </span><span class="nt">cisco.aci.aci_system</span><span class="p">:</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#ansible-playbook-__codelineno-9-6"></a><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">apic_api</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#ansible-playbook-__codelineno-9-7"></a><span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">apic_user</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#ansible-playbook-__codelineno-9-8"></a><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">apic_password</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#ansible-playbook-__codelineno-9-9"></a><span class="w">        </span><span class="nt">validate_certs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#ansible-playbook-__codelineno-9-10"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">query</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#ansible-playbook-__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#ansible-playbook-__codelineno-9-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create a new demo tenant</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#ansible-playbook-__codelineno-9-13"></a><span class="w">      </span><span class="nt">cisco.aci.aci_tenant</span><span class="p">:</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#ansible-playbook-__codelineno-9-14"></a><span class="w">        </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">apic_api</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#ansible-playbook-__codelineno-9-15"></a><span class="w">        </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">apic_user</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#ansible-playbook-__codelineno-9-16"></a><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">apic_password</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#ansible-playbook-__codelineno-9-17"></a><span class="w">        </span><span class="nt">validate_certs</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#ansible-playbook-__codelineno-9-18"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo-tenant</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#ansible-playbook-__codelineno-9-19"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Tenant for demo purposes</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#ansible-playbook-__codelineno-9-20"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div></p>
</div>
</div>
</div>
</div>
<p>To identify the correct group (<em>remember, these are </em><em>not</em><em> inventory groups</em>), take a look at the <code>meta/runtime.yml</code> of the desired collection. It needs to define the <code>action_groups</code> list, for example:</p>
<div class="no-copy highlight"><span class="filename">~/.ansible/collections/ansible_collections/cisco/aci/meta/runtime.yml</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#ansible-playbook-__codelineno-10-1"></a><span class="nn">---</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#ansible-playbook-__codelineno-10-2"></a><span class="nt">requires_ansible</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&gt;=2.9.10&#39;</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#ansible-playbook-__codelineno-10-3"></a><span class="nt">action_groups</span><span class="p">:</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#ansible-playbook-__codelineno-10-4"></a><span class="w">  </span><span class="nt">all</span><span class="p">:</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#ansible-playbook-__codelineno-10-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aci_aaa_custom_privilege</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#ansible-playbook-__codelineno-10-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aci_aaa_domain</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#ansible-playbook-__codelineno-10-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aci_aaa_role</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#ansible-playbook-__codelineno-10-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aci_aaa_ssh_auth</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#ansible-playbook-__codelineno-10-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aci_aaa_user</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#ansible-playbook-__codelineno-10-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aci_aaa_user_certificate</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#ansible-playbook-__codelineno-10-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aci_aaa_user_domain</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#ansible-playbook-__codelineno-10-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aci_aaa_user_role</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#ansible-playbook-__codelineno-10-13"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">aci_access_port_block_to_access_port</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#ansible-playbook-__codelineno-10-14"></a><span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div>
<p>The <em>group</em> is called <code>all</code>, therefore the module defaults groups needs to be <code>group/cisco.aci.all</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Any module defaults set at the play level (and block/task level when using <code>include_role</code> or <code>import_role</code>) will apply to <strong>any</strong> roles used, which may cause unexpected behavior in the role.</p>
</div>
<h2 id="ansible-playbook-collections-in-playbooks">Collections in playbooks</h2>
<p>In a playbook, you can control the collections Ansible searches for modules and action plugins to execute.</p>
<div class="admonition quote">
<p class="admonition-title">tl;dr</p>
<p>This is not recommended, try to avoid this.</p>
</div>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#ansible-playbook-__codelineno-11-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Initialize Control-Plane Nodes</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#ansible-playbook-__codelineno-11-2"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubemaster</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#ansible-playbook-__codelineno-11-3"></a><span class="w">  </span><span class="nt">collections</span><span class="p">:</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#ansible-playbook-__codelineno-11-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.core</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#ansible-playbook-__codelineno-11-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">computacenter.utils</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#ansible-playbook-__codelineno-11-6"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#ansible-playbook-__codelineno-11-7"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#ansible-playbook-__codelineno-11-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-control-plane</span>
</code></pre></div>
<p>With that you could omit the <em>provider.collection</em> part when using modules, by default you would reference a module with the <a href="#ansible-tasks-modules-and-collections"><abbr title="Full Qualified Collection Name">FQCN</abbr></a>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#ansible-playbook-__codelineno-12-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Check if Weave is already installed</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#ansible-playbook-__codelineno-12-2"></a><span class="w">  </span><span class="nt">kubernetes.core.k8s_info</span><span class="p">:</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#ansible-playbook-__codelineno-12-3"></a><span class="w">    </span><span class="nt">api_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#ansible-playbook-__codelineno-12-4"></a><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#ansible-playbook-__codelineno-12-5"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">weave-net</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#ansible-playbook-__codelineno-12-6"></a><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#ansible-playbook-__codelineno-12-7"></a><span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">weave_daemonset</span>
</code></pre></div>
<p>With the <code>collections</code> list defined as part of the play definition, you could write your tasks like this:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#ansible-playbook-__codelineno-13-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Check if Weave is already installed</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#ansible-playbook-__codelineno-13-2"></a><span class="w">  </span><span class="nt">k8s_info</span><span class="p">:</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#ansible-playbook-__codelineno-13-3"></a><span class="w">    </span><span class="nt">api_version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#ansible-playbook-__codelineno-13-4"></a><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#ansible-playbook-__codelineno-13-5"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">weave-net</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#ansible-playbook-__codelineno-13-6"></a><span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#ansible-playbook-__codelineno-13-7"></a><span class="w">  </span><span class="nt">register</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">weave_daemonset</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If your playbook uses both the collections keyword and one or more roles, the roles do not inherit the collections set by the playbook!<br />
The collections keyword merely creates an ordered <em>search path</em> for non-namespaced plugin and role references. It does not install content or otherwise change Ansible’s behavior around the loading of plugins or roles. Note that an <abbr title="Full Qualified Collection Name">FQCN</abbr> is still required for non-action or module plugins (for example, lookups, filters, tests).</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>It is preferable to use a module or plugin’s <abbr title="Full Qualified Collection Name">FQCN</abbr> over the <code>collections</code> keyword!</p>
</div>
<h2 id="ansible-playbook-executing-playbooks">Executing playbooks</h2>
<p>To run your playbook, use the <code>ansible-playbook</code> command.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#ansible-playbook-__codelineno-14-1"></a><span class="go">ansible-playbook playbook.yml</span>
</code></pre></div>
<p>Some useful command-line parameters when executing your playbook are the following</p>
<ul>
<li><code>-C</code> or <code>--check</code> runs the playbook without making any modifications</li>
<li><code>-D</code> or <code>--diff</code> shows the differences when changing (small) files and templates</li>
<li><code>--step</code> runs one-step-at-a-time, you need to confirm each task before running</li>
<li><code>--list-tags</code> lists all available tags</li>
<li><code>--list-tasks</code> lists all tasks that would be executed</li>
</ul>
<h3 id="ansible-playbook-with-ansible-navigator">With Ansible Navigator</h3>
<p>To ensure that your Ansible Content works when running it locally during development and when running it in AAP or AWX later, it is advisable to execute it with the same Execution Environment. The <em>ansible-playbook</em> command can't run these, this is where the Navigator comes in.  </p>
<p>The Ansible (Content) Navigator is a command-line tool and a text-based user interface (<abbr title="Text-based User Interface">TUI</abbr>) for creating, reviewing, running and troubleshooting Ansible content, including inventories, playbooks, collections, documentation and container images (execution environments). Take a look at the <a href="#ansible-installation-ansible-navigator">Installation section</a> on how to install the utility and dependencies.</p>
<p>Use the following minimal configuration for the Navigator and store it in your project root directory:</p>
<div class="admonition example">
<p class="admonition-title">ansible-navigator.yml</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#ansible-playbook-__codelineno-15-1"></a><span class="nn">---</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#ansible-playbook-__codelineno-15-2"></a><span class="nt">ansible-navigator</span><span class="p">:</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#ansible-playbook-__codelineno-15-3"></a><span class="w">  </span><span class="nt">execution-environment</span><span class="p">:</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#ansible-playbook-__codelineno-15-4"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ghcr.io/ansible-community/community-ee-base:latest</span><span class="w"> </span><span class="c1"># (1)!</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#ansible-playbook-__codelineno-15-5"></a><span class="w">    </span><span class="nt">pull</span><span class="p">:</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#ansible-playbook-__codelineno-15-6"></a><span class="w">      </span><span class="nt">policy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">missing</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#ansible-playbook-__codelineno-15-7"></a><span class="w">  </span><span class="nt">logging</span><span class="p">:</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#ansible-playbook-__codelineno-15-8"></a><span class="w">    </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#ansible-playbook-__codelineno-15-9"></a><span class="w">    </span><span class="nt">file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">logs/ansible-navigator.log</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#ansible-playbook-__codelineno-15-10"></a><span class="w">  </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">stdout</span><span class="w"> </span><span class="c1"># (2)!</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#ansible-playbook-__codelineno-15-11"></a><span class="w">  </span><span class="nt">playbook-artifact</span><span class="p">:</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#ansible-playbook-__codelineno-15-12"></a><span class="w">    </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#ansible-playbook-__codelineno-15-13"></a><span class="w">    </span><span class="nt">save-as</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;logs/{playbook_status}-{playbook_name}-{time_stamp}.json&quot;</span><span class="w"> </span><span class="c1"># (3)!</span>
</code></pre></div>
<ol>
<li>Specifies the name of the execution environment image to use, change this, if you want to use your own. The <em>pull policy</em> will download the image if it is not already present (this also means no updated images will be downloaded!).<br />
To build and use your own Execution Environment take a look at the section <a href="#ansible-installation-execution-environments">Installation &gt; Execution Environments</a>.</li>
<li>Specifies the user-interface mode, with <code>stdout</code> it will output to standard-out as with the usual <code>ansible-playbook</code> command. Use <code>interactive</code> to use the <abbr title="Text-based User Interface">TUI</abbr>. You can provide the CLI-parameter <code>-m</code> or <code>--mode</code> to overwrite the configuration.</li>
<li>Specifies the name for artifacts created from completed playbooks. For example, for a successful run of the <code>site.yml</code> playbook a log file like <code>logs/successful-site-2023-11-01T12:20:20.907856+00:00.json</code>. For failed runs it would be <code>logs/failed-site-2023-11-01T12:29:17.020432+00:00.json</code>. With the <em>replay</em> command, you now can observe output of previous playbook runs, e.g. <code>ansible-navigator replay logs/failed-site-2023-11-01T12\:29\:33.129179+00\:00.json</code>.</li>
</ol>
</div>
<p>You can also use the Navigator configuration for <strong>all</strong> your projects, save it as a hidden file in your home directory (e.g. <code>~/.ansible-navigator.yml</code>).</p>
<p>Take a look at the <a href="https://ansible.readthedocs.io/projects/navigator/settings/" target="_blank">official Ansible Navigator Documentation</a> for all other configuration options.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>With the configuration above, playbook artifacts (logs), as well as the Navigator Log-file, will be stored in a <code>logs</code> folder in your playbook directory. <strong>Consider ignoring the folder from Git tracking.</strong></p>
<div class="highlight"><span class="filename">.gitignore</span><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#ansible-playbook-__codelineno-16-1"></a>logs/
</code></pre></div>
</div>
<p>Executing a playbook with the Navigator is as easy as before, just run it like this:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#ansible-playbook-__codelineno-17-1"></a><span class="go">ansible-navigator run site.yml</span>
</code></pre></div>
<p>Append any CLI-parameters (e.g. <code>-i inventory.ini</code>) that you are used to as when executing it with <em>ansible-playbook</em>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Using the <em>Interactive</em> mode (the <em><abbr title="Text-based User Interface">TUI</abbr></em>) is encouraged, try around!</p>
</div>
<!-- markdownlint-disable --></section><section class="print-page" id="ansible-roles"><h1 id="ansible-roles-roles">Roles</h1>
<p>New playbook functionality is always added in a role. Roles should only serve a defined purpose that is unambiguous by the role name.
The role name should be short and unique. It is separated with hyphens, if it consists of several words.</p>
<h2 id="ansible-roles-readme">Readme</h2>
<p>Every role must have a role-specific <code>README.md</code> describing scope and focus of the role. Use the following example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#ansible-roles-__codelineno-0-1"></a><span class="gh"># Role name/title</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#ansible-roles-__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#ansible-roles-__codelineno-0-3"></a>Brief description of the role, what it does and what not.
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#ansible-roles-__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#ansible-roles-__codelineno-0-5"></a><span class="gu">## Requirements</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#ansible-roles-__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#ansible-roles-__codelineno-0-7"></a>Technical requirements, e.g. necessary packages/rpms, own modules or plugins.
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#ansible-roles-__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#ansible-roles-__codelineno-0-9"></a><span class="gu">## Role Variables</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#ansible-roles-__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#ansible-roles-__codelineno-0-11"></a>The role uses the following variables:
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#ansible-roles-__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#ansible-roles-__codelineno-0-13"></a>| Variable Name | Type    | Default Value | Description            |
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#ansible-roles-__codelineno-0-14"></a>| ------------- | ------- | ------------- | ---------------------- |
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#ansible-roles-__codelineno-0-15"></a>| example       | Boolean | false         | Brief description      |
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#ansible-roles-__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#ansible-roles-__codelineno-0-17"></a><span class="gu">## Dependencies</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#ansible-roles-__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#ansible-roles-__codelineno-0-19"></a>This role expects to run <span class="gs">**after**</span> the following roles:
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#ansible-roles-__codelineno-0-20"></a><span class="k">*</span><span class="w"> </span>repository
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#ansible-roles-__codelineno-0-21"></a><span class="k">*</span><span class="w"> </span>networking
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#ansible-roles-__codelineno-0-22"></a><span class="k">*</span><span class="w"> </span>common
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#ansible-roles-__codelineno-0-23"></a><span class="k">*</span><span class="w"> </span>software
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#ansible-roles-__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#ansible-roles-__codelineno-0-25"></a><span class="gu">## Tags</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#ansible-roles-__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#ansible-roles-__codelineno-0-27"></a>The role can be executed with the following tags:
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#ansible-roles-__codelineno-0-28"></a><span class="k">*</span><span class="w"> </span>install
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#ansible-roles-__codelineno-0-29"></a><span class="k">*</span><span class="w"> </span>configure
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#ansible-roles-__codelineno-0-30"></a><span class="k">*</span><span class="w"> </span>service
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#ansible-roles-__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#ansible-roles-__codelineno-0-32"></a><span class="gu">## Example Playbook</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#ansible-roles-__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#ansible-roles-__codelineno-0-34"></a>Use the role in a playbook like this (after running plays/roles from dependencies section):
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#ansible-roles-__codelineno-0-35"></a><span class="sb">```yaml</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#ansible-roles-__codelineno-0-36"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Execute role</span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#ansible-roles-__codelineno-0-37"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example_servers</span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#ansible-roles-__codelineno-0-38"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#ansible-roles-__codelineno-0-39"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#ansible-roles-__codelineno-0-40"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-role</span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#ansible-roles-__codelineno-0-41"></a><span class="sb">```</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#ansible-roles-__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#ansible-roles-__codelineno-0-43"></a><span class="gu">## Authors</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#ansible-roles-__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#ansible-roles-__codelineno-0-45"></a>Tim Grützmacher - &lt;tim.gruetzmacher@computacenter.com&gt;
</code></pre></div>
<h2 id="ansible-roles-role-structure">Role structure</h2>
<h3 id="ansible-roles-role-skeleton">Role skeleton</h3>
<p>The <code>ansible-galaxy</code> utility can be used to create the role <em>skeleton</em> with the following command:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#ansible-roles-__codelineno-1-1"></a><span class="go">ansible-galaxy role init roles/demo</span>
</code></pre></div>
<p>This would create the following directory:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#ansible-roles-__codelineno-2-1"></a><span class="go">roles/demo/</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#ansible-roles-__codelineno-2-2"></a><span class="go">├── defaults</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#ansible-roles-__codelineno-2-3"></a><span class="go">│   └── main.yml</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#ansible-roles-__codelineno-2-4"></a><span class="go">├── files</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#ansible-roles-__codelineno-2-5"></a><span class="go">├── handlers</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#ansible-roles-__codelineno-2-6"></a><span class="go">│   └── main.yml</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#ansible-roles-__codelineno-2-7"></a><span class="go">├── meta</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#ansible-roles-__codelineno-2-8"></a><span class="go">│   └── main.yml</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#ansible-roles-__codelineno-2-9"></a><span class="go">├── README.md</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#ansible-roles-__codelineno-2-10"></a><span class="go">├── tasks</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#ansible-roles-__codelineno-2-11"></a><span class="go">│   └── main.yml</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#ansible-roles-__codelineno-2-12"></a><span class="go">├── templates</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#ansible-roles-__codelineno-2-13"></a><span class="go">├── tests</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#ansible-roles-__codelineno-2-14"></a><span class="go">│   ├── inventory</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#ansible-roles-__codelineno-2-15"></a><span class="go">│   └── test.yml</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#ansible-roles-__codelineno-2-16"></a><span class="go">├── .travis.yml</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#ansible-roles-__codelineno-2-17"></a><span class="go">└── vars</span>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#ansible-roles-__codelineno-2-18"></a><span class="go">    └── main.yml</span>
</code></pre></div>
<p>At least the folders (and content) <code>tests</code> (a sample inventory and playbook for testing, we will use a different testing method) and <code>vars</code> (variable definitions, not used according to this Best Practice Guide, because we use only <em>group_vars</em>, <em>host_vars</em> and <em>defaults</em>) are not necessary. Also the <code>.travis.yml</code> (a <abbr title="Continuous Integration">CI</abbr>/<abbr title="Continuous Deployment">CD</abbr> solution) definition is not useful.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Use a custom role skeleton which is used by <code>ansible-galaxy</code>!</p>
</div>
<p>Consider the following role skeleton, note the missing <em>vars</em> and <em>test</em> folder and the newly added <a href="#development-testing-molecule">Molecule folder</a>.</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#ansible-roles-__codelineno-3-1"></a><span class="go">roles/role-skeleton/</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#ansible-roles-__codelineno-3-2"></a><span class="go">├── defaults</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#ansible-roles-__codelineno-3-3"></a><span class="go">│   └── main.yml</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#ansible-roles-__codelineno-3-4"></a><span class="go">├── files</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#ansible-roles-__codelineno-3-5"></a><span class="go">├── handlers</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#ansible-roles-__codelineno-3-6"></a><span class="go">│   └── main.yml</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#ansible-roles-__codelineno-3-7"></a><span class="go">├── meta</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#ansible-roles-__codelineno-3-8"></a><span class="go">│   └── main.yml</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#ansible-roles-__codelineno-3-9"></a><span class="go">├── molecule</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#ansible-roles-__codelineno-3-10"></a><span class="go">│   └── default</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#ansible-roles-__codelineno-3-11"></a><span class="go">│       ├── converge.yml</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#ansible-roles-__codelineno-3-12"></a><span class="go">│       └── molecule.yml</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#ansible-roles-__codelineno-3-13"></a><span class="go">├── README.md</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#ansible-roles-__codelineno-3-14"></a><span class="go">├── tasks</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#ansible-roles-__codelineno-3-15"></a><span class="go">│   └── main.yml</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#ansible-roles-__codelineno-3-16"></a><span class="go">└── templates</span>
</code></pre></div>
<p>You need to define the following parameter in your custom <code>ansible.cfg</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#ansible-roles-__codelineno-4-1"></a><span class="k">[galaxy]</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#ansible-roles-__codelineno-4-2"></a><span class="na">role_skeleton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">roles/role-skeleton</span>
</code></pre></div>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Afterwards, initializing a new role with <code>ansible-galaxy role init</code> creates a role structure with exactly the content you need!</p>
</div>
<!-- markdownlint-disable --></section><section class="print-page" id="ansible-tasks"><h1 id="ansible-tasks-tasks">Tasks</h1>
<p>Tasks should always be inside of a role. Do not use tasks in a play directly.<br />
Logically related tasks are to be separated into individual files, the <code>main.yml</code> of a role only imports other task files.</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#ansible-tasks-__codelineno-0-1"></a><span class="go">.</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#ansible-tasks-__codelineno-0-2"></a><span class="go">└── roles</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#ansible-tasks-__codelineno-0-3"></a><span class="go">    └── k8s-bootstrap</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#ansible-tasks-__codelineno-0-4"></a><span class="go">        └── tasks</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#ansible-tasks-__codelineno-0-5"></a><span class="go">            ├── install-kubeadm.yml</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#ansible-tasks-__codelineno-0-6"></a><span class="go">            ├── main.yml</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#ansible-tasks-__codelineno-0-7"></a><span class="go">            └── prerequisites.yml</span>
</code></pre></div>
<p>The file name of a task file should describe the content.</p>
<div class="highlight"><span class="filename">roles/k8s-bootstrap/tasks/main.yml</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#ansible-tasks-__codelineno-1-1"></a><span class="nn">---</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#ansible-tasks-__codelineno-1-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prerequisites.yml</span><span class="w"> </span><span class="c1"># noqa name[missing]</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#ansible-tasks-__codelineno-1-3"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install-kubeadm.yml</span><span class="w"> </span><span class="c1"># noqa name[missing]</span>
</code></pre></div>
<h2 id="ansible-tasks-naming-tasks">Naming tasks</h2>
<p>It is possible to leave off the <em>name</em> for a given task, though it is recommended to provide a description about why something is being done instead. This description is shown when the playbook is run.<br />
Write task names in the imperative (e.g. <em>"Ensure service is running"</em>), this communicates the action of the task. Start with a capital letter.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="ansible-tasks-__tabbed_1_1" name="ansible-tasks-__tabbed_1" type="radio" /><input id="ansible-tasks-__tabbed_1_2" name="ansible-tasks-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_1_1">Good</label><label for="ansible-tasks-__tabbed_1_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#ansible-tasks-__codelineno-2-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install webserver package</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#ansible-tasks-__codelineno-2-2"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#ansible-tasks-__codelineno-2-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#ansible-tasks-__codelineno-2-4"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p><div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#ansible-tasks-__codelineno-3-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">yum</span><span class="p">:</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#ansible-tasks-__codelineno-3-2"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#ansible-tasks-__codelineno-3-3"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div>
Using name parameter, but not starting with capital letter, nor describing the task properly.
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#ansible-tasks-__codelineno-4-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install package</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#ansible-tasks-__codelineno-4-2"></a><span class="w">  </span><span class="nt">yum</span><span class="p">:</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#ansible-tasks-__codelineno-4-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#ansible-tasks-__codelineno-4-4"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div></p>
</div>
</div>
</div>
</div>
<h3 id="ansible-tasks-prefix-task-names-in-sub-task-files">Prefix task names in sub-task files</h3>
<p>It is a common practice to have <code>tasks/main.yml</code> file including other tasks files, which we’ll call <em>sub-tasks</em> files. Make sure that the tasks' names in these sub-tasks files are prefixed with a shortcut reminding of the sub-tasks file’s name. Especially in a complex role with multiple (sub-)tasks file, it becomes difficult to understand which task belongs to which file.  </p>
<p>For example, having a sub-task file <code>tasks/kubeadm-setup.yml</code> with every task in it having a short reminder to which file it belongs.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#ansible-tasks-__codelineno-5-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeadm-setup | Install kubeadm, kubelet and kubectl</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#ansible-tasks-__codelineno-5-2"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#ansible-tasks-__codelineno-5-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#ansible-tasks-__codelineno-5-4"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubelet</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#ansible-tasks-__codelineno-5-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeadm</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#ansible-tasks-__codelineno-5-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#ansible-tasks-__codelineno-5-7"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div>
<p>The log output will then look like this:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#ansible-tasks-__codelineno-6-1"></a><span class="go">...</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#ansible-tasks-__codelineno-6-2"></a><span class="go">TASK [k8s-bootstrap: kubeadm-setup | Install kubeadm, kubelet and kubectl] **********</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#ansible-tasks-__codelineno-6-3"></a><span class="go">changed: [kubemaster]</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#ansible-tasks-__codelineno-6-4"></a><span class="go">...</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you move around your tasks often during development phase, it may be difficult to keep this up to date.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can check for this rule with <em>ansible-lint</em> by enabling it in the config:</p>
<div class="highlight"><span class="filename">.ansible-lint</span><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#ansible-tasks-__codelineno-7-1"></a><span class="nt">enable_list</span><span class="p">:</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#ansible-tasks-__codelineno-7-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name[prefix]</span>
</code></pre></div>
</div>
</div>
<h2 id="ansible-tasks-tags">Tags</h2>
<p>Don't use too many tags, it gets confusing very quickly.<br />
Tags should only be allowed for imported task files within the <code>main.yml</code> of a role. Tags at the task level in sub-task files should be avoided.</p>
<div class="highlight"><span class="filename">tasks/main.yml</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#ansible-tasks-__codelineno-8-1"></a><span class="nn">---</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#ansible-tasks-__codelineno-8-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">installation.yml</span><span class="w"> </span><span class="c1"># noqa name[missing]</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#ansible-tasks-__codelineno-8-3"></a><span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#ansible-tasks-__codelineno-8-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#ansible-tasks-__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#ansible-tasks-__codelineno-8-6"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ansible.builtin.import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configuration.yml</span><span class="w"> </span><span class="c1"># noqa name[missing]</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#ansible-tasks-__codelineno-8-7"></a><span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#ansible-tasks-__codelineno-8-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configure</span>
</code></pre></div>
<p>Try to use the same tags across your roles, this way you would be able to run only e.g. <em>installation</em> tasks from multiple roles.</p>
<h2 id="ansible-tasks-idempotence">Idempotence</h2>
<p>Each task must be idempotent, if non-idempotent modules are used (<em>command</em>, <em>shell</em>, <em>raw</em>) these tasks must be developed via appropriate parameters or conditions to an idempotent mode of operation.  </p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>In general, the use of non-idempotent modules should be reduced to a necessary minimum.</p>
</div>
<h3 id="ansible-tasks-command-vs-shell-module"><em>command</em> vs. <em>shell</em> module</h3>
<p>In most of the use cases, both shell and command modules perform the same job. However, there are few main differences between these two modules. The <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/command_module.html" target="_blank"><em>command</em></a> module uses the Python interpreter on the target node (as all other modules), the <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html" target="_blank"><em>shell</em></a> module runs a real shell on the target (pipes and redirects are available, as well as access to environment variables).</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Always try to use the <code>command</code> module over the <code>shell</code> module, if you do not explicitly need shell functionality.</p>
</div>
<p>Parsing shell meta-characters can lead to unexpected commands being executed if quoting is not done correctly so it is more secure to use the command module when possible. To sanitize any variables passed to the shell module, you should use <code>{{ var | quote }}</code> instead of<br />
just <code>{{ var }}</code> to make sure they do not include evil things like semicolons.</p>
<h3 id="ansible-tasks-creates-and-removes"><em>creates</em> and <em>removes</em></h3>
<p>Check mode is supported for non-idempotent modules when passing <code>creates</code> or <code>removes</code>. If running in check mode and either of these are specified, the module will check for the existence of the file and report the correct changed status. If these are not supplied, the task will be skipped.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Work in Progress</strong> - More description necessary.</p>
</div>
<h3 id="ansible-tasks-failed_when-and-changed_when"><em>failed_when</em> and <em>changed_when</em></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Work in Progress</strong> - More description necessary.</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="ansible-tasks-__tabbed_2_1" name="ansible-tasks-__tabbed_2" type="radio" /><input id="ansible-tasks-__tabbed_2_2" name="ansible-tasks-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_2_1">Good</label><label for="ansible-tasks-__tabbed_2_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#ansible-tasks-__codelineno-9-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install webserver package</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#ansible-tasks-__codelineno-9-2"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#ansible-tasks-__codelineno-9-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#ansible-tasks-__codelineno-9-4"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p>This task never reports a changed state or fails when an error occurs.
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#ansible-tasks-__codelineno-10-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install webserver package</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#ansible-tasks-__codelineno-10-2"></a><span class="w">  </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sudo yum install http</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#ansible-tasks-__codelineno-10-3"></a><span class="w">  </span><span class="nt">changed_when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#ansible-tasks-__codelineno-10-4"></a><span class="w">  </span><span class="nt">failed_when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div></p>
</div>
</div>
</div>
</div>
<h2 id="ansible-tasks-modules-and-collections">Modules (and Collections)</h2>
<p>Use the <em>full qualified collection names (<abbr title="Full Qualified Collection Name">FQCN</abbr>)</em> for modules, they are supported since Version 2.9 and ensures your tasks are set for the future.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="ansible-tasks-__tabbed_3_1" name="ansible-tasks-__tabbed_3" type="radio" /><input id="ansible-tasks-__tabbed_3_2" name="ansible-tasks-__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_3_1">Good</label><label for="ansible-tasks-__tabbed_3_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#ansible-tasks-__codelineno-11-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install webserver package</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#ansible-tasks-__codelineno-11-2"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#ansible-tasks-__codelineno-11-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#ansible-tasks-__codelineno-11-4"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#ansible-tasks-__codelineno-12-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">yum</span><span class="p">:</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#ansible-tasks-__codelineno-12-2"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#ansible-tasks-__codelineno-12-3"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div>
</div>
</div>
</div>
</div>
<p>In Ansible 2.10, many plugins and modules have migrated to <strong>Collections</strong> on Ansible Galaxy. Your playbooks should continue to work without any changes. Using the <abbr title="Full Qualified Collection Name">FQCN</abbr> in your playbooks ensures the explicit and authoritative indicator of which collection to use as some collections may contain duplicate module names.</p>
<h2 id="ansible-tasks-module-parameters">Module parameters</h2>
<h3 id="ansible-tasks-module-defaults">Module defaults</h3>
<p>The <code>module_defaults</code> keyword can be used at the play, block, and task level. Any module arguments explicitly specified in a task will override any established default for that module argument.<br />
It makes the most sense to define the <em>module defaults</em> at <a href="#ansible-playbook-module-defaults"><em>play</em> level, take a look in that section</a> for an example and things to consider.</p>
<h3 id="ansible-tasks-permissions">Permissions</h3>
<p>When using modules like <code>copy</code> or <code>template</code> you can (and should) set permissions for the files/templates deployed with the <code>mode</code> parameter.</p>
<p>For those used to <em>/usr/bin/chmod</em>, remember that modes are actually octal numbers.<br />
Add a <strong>leading zero</strong> (or <code>1</code> for setting sticky bit), showing Ansible’s YAML parser it is an octal number <strong>and</strong> quote it (like <code>"0644"</code> or <code>"1777"</code>), this way Ansible receives a string and can do its own conversion from string into number.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Giving Ansible a number without following one of these rules will end up with a decimal number which can have unexpected results.</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="ansible-tasks-__tabbed_4_1" name="ansible-tasks-__tabbed_4" type="radio" /><input id="ansible-tasks-__tabbed_4_2" name="ansible-tasks-__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_4_1">Good</label><label for="ansible-tasks-__tabbed_4_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#ansible-tasks-__codelineno-13-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Copy index.html template</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#ansible-tasks-__codelineno-13-2"></a><span class="w">  </span><span class="nt">ansible.builtin.template</span><span class="p">:</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#ansible-tasks-__codelineno-13-3"></a><span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">welcome.html</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#ansible-tasks-__codelineno-13-4"></a><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/www/html/index.html</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#ansible-tasks-__codelineno-13-5"></a><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0644&quot;</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#ansible-tasks-__codelineno-13-6"></a><span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#ansible-tasks-__codelineno-13-7"></a><span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#ansible-tasks-__codelineno-13-8"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p>Missing leading zero:
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#ansible-tasks-__codelineno-14-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">copy index</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#ansible-tasks-__codelineno-14-2"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#ansible-tasks-__codelineno-14-3"></a><span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">welcome.html</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#ansible-tasks-__codelineno-14-4"></a><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/www/html/index.html</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#ansible-tasks-__codelineno-14-5"></a><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">644</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#ansible-tasks-__codelineno-14-6"></a><span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#ansible-tasks-__codelineno-14-7"></a><span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#ansible-tasks-__codelineno-14-8"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
This leads to these permissions!
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#ansible-tasks-__codelineno-15-1"></a><span class="gp">[root@demo /]# </span>ll<span class="w"> </span>/var/www/html/
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#ansible-tasks-__codelineno-15-2"></a><span class="go">total 68</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#ansible-tasks-__codelineno-15-3"></a><span class="go">--w----r-T 1 apache apache 67691 Nov 18 14:30 index.html</span>
</code></pre></div></p>
</div>
</div>
</div>
</div>
<h3 id="ansible-tasks-state-definition">State definition</h3>
<p>The <code>state</code> parameter is optional to a lot of modules. Whether <code>state: present</code> or <code>state: absent</code>, it’s always best to leave that parameter in your playbooks to make it clear, especially as some modules support additional states.</p>
<h2 id="ansible-tasks-files-vs-templates">Files vs. Templates</h2>
<p>Ansible differentiates between <em>files</em> for static content (deployed with <code>copy</code> module) and <em>templates</em> for content, which should be rendered dynamically with Jinja2 (deployed with <code>template</code> module).  </p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>In almost every case, use <em>templates</em>, deployed via <code>template</code> module.  </p>
</div>
<p>Even if there currently is nothing in the file that is being templated, if there is the possibility in the future that it might be added, having the file handled by the <code>template</code> module makes adding that functionality much simpler than if the file is initially handled by the <code>copy</code> module( and then needs to be moved before it can be edited).</p>
<p>Additionally, you now can add a <em>marker</em>, indicating that manual changes to the file will be lost:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="ansible-tasks-__tabbed_5_1" name="ansible-tasks-__tabbed_5" type="radio" /><input id="ansible-tasks-__tabbed_5_2" name="ansible-tasks-__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_5_1">Template</label><label for="ansible-tasks-__tabbed_5_2">Rendered output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#ansible-tasks-__codelineno-16-1"></a><span class="cp">{{</span> <span class="nv">ansible_managed</span> <span class="o">|</span> <span class="nf">ansible</span><span class="nv">.builtin.comment</span> <span class="cp">}}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#ansible-tasks-__codelineno-17-1"></a><span class="c1">#</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#ansible-tasks-__codelineno-17-2"></a><span class="c1"># Ansible Managed</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#ansible-tasks-__codelineno-17-3"></a><span class="c1">#</span>
</code></pre></div>
</div>
</div>
</div>
<details class="info">
<summary><code>ansible.builtin.comment</code> filter</summary>
<p>By default, <code>{{ ansible_managed }}</code> is replaced by the string <code>Ansible Managed</code> as is (can be adjusted in the <a href="https://docs.ansible.com/ansible/latest/reference_appendices/config.html#default-managed-str" target="_blank"><code>ansible.cfg</code>)</a>.<br />
In most cases, the appropriate <em>comment</em> symbol must be prefixed, this should be done with the <code>ansible.builtin.comment</code> filter.<br />
For example, <code>.xml</code> files need to be commented differently, which can be configured:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="ansible-tasks-__tabbed_6_1" name="ansible-tasks-__tabbed_6" type="radio" /><input id="ansible-tasks-__tabbed_6_2" name="ansible-tasks-__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_6_1">Template</label><label for="ansible-tasks-__tabbed_6_2">Rendered output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#ansible-tasks-__codelineno-18-1"></a><span class="cp">{{</span> <span class="nv">ansible_managed</span> <span class="o">|</span> <span class="nf">ansible</span><span class="nv">.builtin.comment</span><span class="o">(</span><span class="s1">&#39;xml&#39;</span><span class="o">)</span> <span class="cp">}}</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#ansible-tasks-__codelineno-19-1"></a><span class="cm">&lt;!--</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#ansible-tasks-__codelineno-19-2"></a><span class="cm">-</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#ansible-tasks-__codelineno-19-3"></a><span class="cm">- Ansible managed</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#ansible-tasks-__codelineno-19-4"></a><span class="cm">-</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#ansible-tasks-__codelineno-19-5"></a><span class="cm">--&gt;</span>
</code></pre></div>
</div>
</div>
</div>
<p>You can also use the <code>decorate</code> parameter to choose the symbol yourself.<br />
Take a look at the <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/comment_filter.html" target="_blank">Ansible documentation for additional information</a>.</p>
</details>
<p>When using the <code>template</code> module, append <code>.j2</code> to the template file name. Keep filenames and templates as close to the name on the destination system as possible.</p>
<h2 id="ansible-tasks-conditionals">Conditionals</h2>
<p>If the <code>when:</code> condition results in a line that is very long, and is an <code>and</code> expression, then break it into a list of conditions.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="ansible-tasks-__tabbed_7_1" name="ansible-tasks-__tabbed_7" type="radio" /><input id="ansible-tasks-__tabbed_7_2" name="ansible-tasks-__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_7_1">Good</label><label for="ansible-tasks-__tabbed_7_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#ansible-tasks-__codelineno-20-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set motd message for k8s worker node</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#ansible-tasks-__codelineno-20-2"></a><span class="w">  </span><span class="nt">ansible.builtin.copy</span><span class="p">:</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#ansible-tasks-__codelineno-20-3"></a><span class="w">    </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;This</span><span class="nv"> </span><span class="s">host</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">used</span><span class="nv"> </span><span class="s">as</span><span class="nv"> </span><span class="s">k8s</span><span class="nv"> </span><span class="s">worker.\n&quot;</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#ansible-tasks-__codelineno-20-4"></a><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/motd</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#ansible-tasks-__codelineno-20-5"></a><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0644&quot;</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#ansible-tasks-__codelineno-20-6"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#ansible-tasks-__codelineno-20-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">inventory_hostname in groups[&#39;kubeworker&#39;]</span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#ansible-tasks-__codelineno-20-8"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeadm_join_result.rc == 0</span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#ansible-tasks-__codelineno-21-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set motd message for k8s worker node</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#ansible-tasks-__codelineno-21-2"></a><span class="w">  </span><span class="nt">copy</span><span class="p">:</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#ansible-tasks-__codelineno-21-3"></a><span class="w">    </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;This</span><span class="nv"> </span><span class="s">host</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">used</span><span class="nv"> </span><span class="s">as</span><span class="nv"> </span><span class="s">k8s</span><span class="nv"> </span><span class="s">worker.\n&quot;</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#ansible-tasks-__codelineno-21-4"></a><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/motd</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#ansible-tasks-__codelineno-21-5"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">inventory_hostname in groups[&#39;kubeworker&#39;] and kubeadm_join_result.rc == 0</span>
</code></pre></div>
</div>
</div>
</div>
</div>
<p>When using conditions on <em>blocks</em>, move the <code>when</code> statement to the top, below the <em>name</em> parameter, to improve readability.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="8:2"><input checked="checked" id="ansible-tasks-__tabbed_8_1" name="ansible-tasks-__tabbed_8" type="radio" /><input id="ansible-tasks-__tabbed_8_2" name="ansible-tasks-__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_8_1">Good</label><label for="ansible-tasks-__tabbed_8_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#ansible-tasks-__codelineno-22-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install, configure, and start Apache</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#ansible-tasks-__codelineno-22-2"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible_facts[&#39;distribution&#39;] == &#39;CentOS&#39;</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#ansible-tasks-__codelineno-22-3"></a><span class="w">  </span><span class="nt">block</span><span class="p">:</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#ansible-tasks-__codelineno-22-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install httpd and memcached</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#ansible-tasks-__codelineno-22-5"></a><span class="w">      </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#ansible-tasks-__codelineno-22-6"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#ansible-tasks-__codelineno-22-7"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#ansible-tasks-__codelineno-22-8"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">memcached</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#ansible-tasks-__codelineno-22-9"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#ansible-tasks-__codelineno-22-10"></a>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#ansible-tasks-__codelineno-22-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Apply the foo config template</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#ansible-tasks-__codelineno-22-12"></a><span class="w">      </span><span class="nt">ansible.builtin.template</span><span class="p">:</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#ansible-tasks-__codelineno-22-13"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">templates/src.j2</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#ansible-tasks-__codelineno-22-14"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/foo.conf</span>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#ansible-tasks-__codelineno-22-15"></a><span class="w">        </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0644&quot;</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#ansible-tasks-__codelineno-22-16"></a>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#ansible-tasks-__codelineno-22-17"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Start service bar and enable it</span>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#ansible-tasks-__codelineno-22-18"></a><span class="w">      </span><span class="nt">ansible.builtin.service</span><span class="p">:</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#ansible-tasks-__codelineno-22-19"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bar</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#ansible-tasks-__codelineno-22-20"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">started</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#ansible-tasks-__codelineno-22-21"></a><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#ansible-tasks-__codelineno-23-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install, configure, and start Apache</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#ansible-tasks-__codelineno-23-2"></a><span class="w">  </span><span class="nt">block</span><span class="p">:</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#ansible-tasks-__codelineno-23-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install httpd and memcached</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#ansible-tasks-__codelineno-23-4"></a><span class="w">      </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#ansible-tasks-__codelineno-23-5"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#ansible-tasks-__codelineno-23-6"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#ansible-tasks-__codelineno-23-7"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">memcached</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#ansible-tasks-__codelineno-23-8"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#ansible-tasks-__codelineno-23-9"></a>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#ansible-tasks-__codelineno-23-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Apply the foo config template</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#ansible-tasks-__codelineno-23-11"></a><span class="w">      </span><span class="nt">ansible.builtin.template</span><span class="p">:</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#ansible-tasks-__codelineno-23-12"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">templates/src.j2</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#ansible-tasks-__codelineno-23-13"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/foo.conf</span>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#ansible-tasks-__codelineno-23-14"></a>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#ansible-tasks-__codelineno-23-15"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Start service bar and enable it</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#ansible-tasks-__codelineno-23-16"></a><span class="w">      </span><span class="nt">ansible.builtin.service</span><span class="p">:</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#ansible-tasks-__codelineno-23-17"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bar</span>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#ansible-tasks-__codelineno-23-18"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">started</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#ansible-tasks-__codelineno-23-19"></a><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#ansible-tasks-__codelineno-23-20"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible_facts[&#39;distribution&#39;] == &#39;CentOS&#39;</span>
</code></pre></div>
</div>
</div>
</div>
</div>
<p>Avoid the use of <code>when: foo_result is changed</code> whenever possible. Use handlers, and, if necessary, handler chains to achieve this same result.</p>
<h2 id="ansible-tasks-loops">Loops</h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Work in Progress</strong> - More description necessary.</p>
</div>
<p>Converting from <code>with_&lt;lookup&gt;</code> to <code>loop</code> is described with a <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html#migrating-from-with-x-to-loop" target="_blank">Migration Guide</a> in the Ansible documentation</p>
<h3 id="ansible-tasks-limit-loop-output">Limit loop output</h3>
<p>When looping over complex data structures, the console output of your task can be enormous. To limit the displayed output, use the <code>label</code> directive with <code>loop_control</code>. For example, this tasks creates users with multiple parameters in a loop:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#ansible-tasks-__codelineno-24-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create local users</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#ansible-tasks-__codelineno-24-2"></a><span class="w">  </span><span class="nt">ansible.builtin.user</span><span class="p">:</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#ansible-tasks-__codelineno-24-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.name</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#ansible-tasks-__codelineno-24-4"></a><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.groups</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#ansible-tasks-__codelineno-24-5"></a><span class="w">    </span><span class="nt">append</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.append</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#ansible-tasks-__codelineno-24-6"></a><span class="w">    </span><span class="nt">comment</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.comment</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#ansible-tasks-__codelineno-24-7"></a><span class="w">    </span><span class="nt">generate_ssh_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#ansible-tasks-__codelineno-24-8"></a><span class="w">    </span><span class="nt">password_expire_max</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.password_expire_max</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#ansible-tasks-__codelineno-24-9"></a><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">user_list</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#ansible-tasks-__codelineno-24-10"></a><span class="w">  </span><span class="nt">loop_control</span><span class="p">:</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#ansible-tasks-__codelineno-24-11"></a><span class="w">    </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.name</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"> </span><span class="c1"># (1)!</span>
</code></pre></div>
<ol>
<li>
<p>Content of variable <code>user_list</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#ansible-tasks-__codelineno-25-1"></a><span class="nt">user_list</span><span class="p">:</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#ansible-tasks-__codelineno-25-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tgruetz</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#ansible-tasks-__codelineno-25-3"></a><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admins,docker</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#ansible-tasks-__codelineno-25-4"></a><span class="w">    </span><span class="nt">append</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#ansible-tasks-__codelineno-25-5"></a><span class="w">    </span><span class="nt">comment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Tim Grützmacher</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#ansible-tasks-__codelineno-25-6"></a><span class="w">    </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bin/bash</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#ansible-tasks-__codelineno-25-7"></a><span class="w">    </span><span class="nt">password_expire_max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">180</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#ansible-tasks-__codelineno-25-8"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joschmi</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#ansible-tasks-__codelineno-25-9"></a><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">developers,docker</span>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#ansible-tasks-__codelineno-25-10"></a><span class="w">    </span><span class="nt">append</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#ansible-tasks-__codelineno-25-11"></a><span class="w">    </span><span class="nt">comment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Jonathan Schmidt</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#ansible-tasks-__codelineno-25-12"></a><span class="w">    </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bin/zsh</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#ansible-tasks-__codelineno-25-13"></a><span class="w">    </span><span class="nt">password_expire_max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">90</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#ansible-tasks-__codelineno-25-14"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mfrink</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#ansible-tasks-__codelineno-25-15"></a><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">developers</span>
<a id="__codelineno-25-16" name="__codelineno-25-16" href="#ansible-tasks-__codelineno-25-16"></a><span class="w">    </span><span class="nt">append</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-25-17" name="__codelineno-25-17" href="#ansible-tasks-__codelineno-25-17"></a><span class="w">    </span><span class="nt">comment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Mathias Frink</span>
<a id="__codelineno-25-18" name="__codelineno-25-18" href="#ansible-tasks-__codelineno-25-18"></a><span class="w">    </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bin/bash</span>
<a id="__codelineno-25-19" name="__codelineno-25-19" href="#ansible-tasks-__codelineno-25-19"></a><span class="w">    </span><span class="nt">password_expire_max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">90</span>
</code></pre></div>
</li>
</ol>
<p>Running the playbook results in the following task output, only the content of the <em>name</em> parameter is shown instead of all key-value pairs in the list item.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="9:2"><input checked="checked" id="ansible-tasks-__tabbed_9_1" name="ansible-tasks-__tabbed_9" type="radio" /><input id="ansible-tasks-__tabbed_9_2" name="ansible-tasks-__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_9_1">Good</label><label for="ansible-tasks-__tabbed_9_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#ansible-tasks-__codelineno-26-1"></a><span class="go">TASK [common : Create local users] *********************************************</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#ansible-tasks-__codelineno-26-2"></a><span class="go">Friday 18 November 2022  12:18:01 +0100 (0:00:01.955)       0:00:03.933 *******</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#ansible-tasks-__codelineno-26-3"></a><span class="go">changed: [demo] =&gt; (item=tgruetz)</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#ansible-tasks-__codelineno-26-4"></a><span class="go">changed: [demo] =&gt; (item=joschmi)</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#ansible-tasks-__codelineno-26-5"></a><span class="go">changed: [demo] =&gt; (item=mfrink)</span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p>Not using the <code>label</code> in the <code>loop_control</code> dictionary results in a very long output:
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#ansible-tasks-__codelineno-27-1"></a><span class="go">TASK [common : Create local users] *********************************************</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#ansible-tasks-__codelineno-27-2"></a><span class="go">Friday 18 November 2022  12:22:40 +0100 (0:00:01.512)       0:00:03.609 *******</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#ansible-tasks-__codelineno-27-3"></a><span class="go">changed: [demo] =&gt; (item={&#39;name&#39;: &#39;tgruetz&#39;, &#39;groups&#39;: &#39;admins,docker&#39;, &#39;append&#39;: False, &#39;comment&#39;: &#39;Tim Grützmacher&#39;, &#39;shell&#39;: &#39;/bin/bash&#39;, &#39;password_expire_max&#39;: 90})</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#ansible-tasks-__codelineno-27-4"></a><span class="go">changed: [demo] =&gt; (item={&#39;name&#39;: &#39;joschmi&#39;, &#39;groups&#39;: &#39;developers,docker&#39;, &#39;append&#39;: True, &#39;comment&#39;: &#39;Jonathan Schmidt&#39;, &#39;shell&#39;: &#39;/bin/zsh&#39;, &#39;password_expire_max&#39;: 90})</span>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#ansible-tasks-__codelineno-27-5"></a><span class="go">changed: [demo] =&gt; (item={&#39;name&#39;: &#39;mfrink&#39;, &#39;groups&#39;: &#39;developers&#39;, &#39;append&#39;: True, &#39;comment&#39;: &#39;Mathias Frink&#39;, &#39;shell&#39;: &#39;/bin/bash&#39;, &#39;password_expire_max&#39;: 90})</span>
</code></pre></div></p>
</div>
</div>
</div>
</div>
<h2 id="ansible-tasks-filter">Filter</h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Work in Progress</strong> - More description necessary.</p>
</div>
<!-- markdownlint-disable --></section><section class="print-page" id="ansible-variables"><h1 id="ansible-variables-variables">Variables</h1>
<h2 id="ansible-variables-where-to-put-variables">Where to put variables</h2>
<p>I always store all my variables at the following <strong>three</strong> locations:</p>
<ul>
<li><em>group_vars</em> folder</li>
<li><em>host_vars</em> folder</li>
<li><em>defaults</em> folder in roles</li>
</ul>
<p>The <em>defaults</em>-folder contains only default values for all variables used by the role.</p>
<h2 id="ansible-variables-naming-variables">Naming Variables</h2>
<p>The variable name should be self-explanatory (<em>as brief as possible, as detailed as necessary</em>), use multiple words and don't shorten things.</p>
<ul>
<li>Multiple words are separated with underscores (<code>_</code>)</li>
<li><em>List</em>-Variables are suffixed with <code>_list</code></li>
<li><em>Dictionary</em>-Variables are suffixed with <code>_dict</code></li>
<li><em>Boolean</em> values are provided with lowercase <code>true</code> or <code>false</code></li>
</ul>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="ansible-variables-__tabbed_1_1" name="ansible-variables-__tabbed_1" type="radio" /><input id="ansible-variables-__tabbed_1_2" name="ansible-variables-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="ansible-variables-__tabbed_1_1">Good</label><label for="ansible-variables-__tabbed_1_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#ansible-variables-__codelineno-0-1"></a><span class="nt">download_directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/.local/bin</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#ansible-variables-__codelineno-0-2"></a><span class="nt">create_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#ansible-variables-__codelineno-0-3"></a><span class="nt">needs_agent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#ansible-variables-__codelineno-1-1"></a><span class="nt">dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/.local/bin</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#ansible-variables-__codelineno-1-2"></a><span class="nt">create_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#ansible-variables-__codelineno-1-3"></a><span class="nt">needsAgent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#ansible-variables-__codelineno-1-4"></a><span class="nt">knows_oop</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span>
</code></pre></div>
</div>
</div>
</div>
</div>
<h2 id="ansible-variables-referencing-variables">Referencing variables</h2>
<p>After a variable is defined, use <em>Jinja2</em> syntax to reference it. Jinja2 variables use <em>double curly braces</em> (<code>{{</code> and <code>}}</code>).<br />
Use spaces after and before the double curly braces and the variable name.<br />
When referencing <em>list</em> or <em>dictionary</em> variables, try to use the <em>bracket notation</em> instead of the <em>dot notation</em>.
Bracket notation always works and you can use variables inside the brackets. Dot notation can cause problems because some keys collide with attributes and methods of python dictionaries.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="ansible-variables-__tabbed_2_1" name="ansible-variables-__tabbed_2" type="radio" /><input id="ansible-variables-__tabbed_2_2" name="ansible-variables-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="ansible-variables-__tabbed_2_1">Good</label><label for="ansible-variables-__tabbed_2_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<p>Simple variable reference:
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#ansible-variables-__codelineno-2-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy configuration file</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#ansible-variables-__codelineno-2-2"></a><span class="w">  </span><span class="nt">ansible.builtin.template</span><span class="p">:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#ansible-variables-__codelineno-2-3"></a><span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foo.cfg.j2</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#ansible-variables-__codelineno-2-4"></a><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">remote_install_path</span><span class="nv"> </span><span class="s">}}/foo.cfg&quot;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#ansible-variables-__codelineno-2-5"></a><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;0644&quot;</span>
</code></pre></div>
Bracket-notation and using variable (<em>interface_name</em>) inside:
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#ansible-variables-__codelineno-3-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Output IPv4 address of interface {{ interface_name }}</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#ansible-variables-__codelineno-3-2"></a><span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#ansible-variables-__codelineno-3-3"></a><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">ansible_facts[interface_name][&#39;ipv4&#39;][&#39;address&#39;]</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div></p>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p>Not using whitespaces around variable name.
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#ansible-variables-__codelineno-4-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy configuration file</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#ansible-variables-__codelineno-4-2"></a><span class="w">  </span><span class="nt">ansible.builtin.template</span><span class="p">:</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#ansible-variables-__codelineno-4-3"></a><span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foo.cfg.j2</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#ansible-variables-__codelineno-4-4"></a><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{remote_install_path}}/foo.cfg&quot;</span>
</code></pre></div>
Not using whitespaces and using dot-notation.
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#ansible-variables-__codelineno-5-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Output IPv4 address of eth0 interface</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#ansible-variables-__codelineno-5-2"></a><span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#ansible-variables-__codelineno-5-3"></a><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{ansible_facts.eth0.ipv4.address}}&quot;</span>
</code></pre></div></p>
</div>
</div>
</div>
</div>
<h2 id="ansible-variables-encrypted-variables">Encrypted variables</h2>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>All variables with sensitive content should be <em>vault</em>-encrypted.  </p>
</div>
<p>Although encrypting just the value of a single variable is possible (with <code>ansible-vault encrypt_string</code>), you should avoid this. Store all sensitive variables in a single file and encrypt the whole file.<br />
For example, to store sensitive variables in <code>group_vars</code>, create the subdirectory for the group and within create two files named <code>vars.yml</code> and <code>vault.yml</code>.<br />
Inside of the <code>vars.yml</code> file, define all of the variables needed, including any sensitive ones. Next, copy all of the sensitive variables over to the <code>vault.yml</code> file and prefix these variables with <code>vault_</code>. Adjust the variables in the <em>vars</em> file to point to the matching <em>vault_</em> variables using Jinja2 syntax, and ensure that the vault file is vault encrypted.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="ansible-variables-__tabbed_3_1" name="ansible-variables-__tabbed_3" type="radio" /><input id="ansible-variables-__tabbed_3_2" name="ansible-variables-__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="ansible-variables-__tabbed_3_1">Good</label><label for="ansible-variables-__tabbed_3_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#ansible-variables-__codelineno-6-1"></a><span class="nn">---</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#ansible-variables-__codelineno-6-2"></a><span class="c1"># file: group_vars/database_servers/vars.yml</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#ansible-variables-__codelineno-6-3"></a><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">vault_username</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#ansible-variables-__codelineno-6-4"></a><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">vault_password</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#ansible-variables-__codelineno-7-1"></a><span class="nn">---</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#ansible-variables-__codelineno-7-2"></a><span class="c1"># file: group_vars/database_servers/vault.yml</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#ansible-variables-__codelineno-7-3"></a><span class="c1"># NOTE: THIS FILE MUST ALWAYS BE VAULT-ENCRYPTED</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#ansible-variables-__codelineno-7-4"></a><span class="nt">vault_username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#ansible-variables-__codelineno-7-5"></a><span class="nt">vault_password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ex4mple</span>
</code></pre></div></p>
<details class="info">
<summary>I can still read the credentials...?</summary>
<p>Obviously, you wouldn't be able to read the content of the file <code>group_vars/database_servers/vault.yml</code>, as the file would be encrypted.<br />
<strong>This only demonstrates how the variables are referencing each other.</strong><br />
The encrypted <code>vault.yml</code> file looks something like this:
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#ansible-variables-__codelineno-8-1"></a><span class="l l-Scalar l-Scalar-Plain">$ANSIBLE_VAULT;1.1;AES256</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#ansible-variables-__codelineno-8-2"></a><span class="l l-Scalar l-Scalar-Plain">30653164396132376333316665656131666165613863343330616666376264353830323234623631</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#ansible-variables-__codelineno-8-3"></a><span class="l l-Scalar l-Scalar-Plain">6361303062336532303665643765336464656164363662370a663834313837303437323332336631</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#ansible-variables-__codelineno-8-4"></a><span class="l l-Scalar l-Scalar-Plain">65656335643031393065333366366639653330353634303664653135653230656461666266356530</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#ansible-variables-__codelineno-8-5"></a><span class="l l-Scalar l-Scalar-Plain">3935346533343834650a323934346666383032636562613966633136663631636435333834393261</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#ansible-variables-__codelineno-8-6"></a><span class="l l-Scalar l-Scalar-Plain">36363833373439333735653262306331333062383630623432633134386138656636343137333439</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#ansible-variables-__codelineno-8-7"></a><span class="l l-Scalar l-Scalar-Plain">61633965323066633433373137383330366466366332626334633234376231393330363335353436</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#ansible-variables-__codelineno-8-8"></a><span class="l l-Scalar l-Scalar-Plain">62383866616232323132376366326161386561666238623731323835633237373036636561666165</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#ansible-variables-__codelineno-8-9"></a><span class="l l-Scalar l-Scalar-Plain">36363838313737656232376365346136633934373861326130636531616438643036656137373762</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#ansible-variables-__codelineno-8-10"></a><span class="l l-Scalar l-Scalar-Plain">39616234353135613063393536306536303065653231306166306432623232356465613063336439</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#ansible-variables-__codelineno-8-11"></a><span class="l l-Scalar l-Scalar-Plain">34636232346334386464313935356537323832666436393336366536626463326631653137313639</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#ansible-variables-__codelineno-8-12"></a><span class="l l-Scalar l-Scalar-Plain">36353532623161653266666436646135396632656133623762643131323439613534643430636333</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#ansible-variables-__codelineno-8-13"></a><span class="l l-Scalar l-Scalar-Plain">31386635613238613233</span>
</code></pre></div></p>
</details>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#ansible-variables-__codelineno-9-1"></a><span class="gp"># </span>file:<span class="w"> </span>group_vars/database_servers.yml
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#ansible-variables-__codelineno-9-2"></a><span class="go">username: admin</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#ansible-variables-__codelineno-9-3"></a><span class="go">password: ex4mple</span>
</code></pre></div>
</div>
</div>
</div>
</div>
<p>Defining variables this way makes sure that you can still find them with <em>grep</em>.<br />
Encrypting files can be done with this command:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#ansible-variables-__codelineno-10-1"></a><span class="go">ansible-vault encrypt group_vars/database_servers/vault.yml</span>
</code></pre></div>
<p>Once a variable file is encrypted, it should <strong>not</strong> be decrypted again (because it may get committed unencrypted). View or edit the file like this:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#ansible-variables-__codelineno-11-1"></a><span class="go">ansible-vault view group_vars/database_servers/vault.yml</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#ansible-variables-__codelineno-12-1"></a><span class="go">ansible-vault edit group_vars/database_servers/vault.yml</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>There are modules which will print the values of encrypted variables into STDOUT while using them or with higher verbosity. Be sure to check the parameters and return values of all modules which use encrypted variables!</p>
</div>
<p>A good example is the <code>ansible.builtin.user</code> module, it automatically obfuscates the value for the <em>password</em> parameter, replacing it with the string <code>NOT_LOGGING_PASSWORD</code>.<br />
The <code>ansible.builtin.debug</code> module on the other hand is a bad example, it will output the password in clear-text (well, by design, but this is not what you would expect)!</p>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Always add the <strong><code>no_log: true</code></strong> key-value-pair for tasks that run the risk of leaking vault-encrypted content!</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="ansible-variables-__tabbed_4_1" name="ansible-variables-__tabbed_4" type="radio" /><input id="ansible-variables-__tabbed_4_2" name="ansible-variables-__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="ansible-variables-__tabbed_4_1">Good</label><label for="ansible-variables-__tabbed_4_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#ansible-variables-__codelineno-13-1"></a><span class="nn">---</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#ansible-variables-__codelineno-13-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Using no_log parameter</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#ansible-variables-__codelineno-13-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">database_servers</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#ansible-variables-__codelineno-13-4"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#ansible-variables-__codelineno-13-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Add user</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#ansible-variables-__codelineno-13-6"></a><span class="w">      </span><span class="nt">ansible.builtin.user</span><span class="p">:</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#ansible-variables-__codelineno-13-7"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">username</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#ansible-variables-__codelineno-13-8"></a><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">password</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#ansible-variables-__codelineno-13-9"></a>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#ansible-variables-__codelineno-13-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Debugging a vaulted variable with no_log</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#ansible-variables-__codelineno-13-11"></a><span class="w">      </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#ansible-variables-__codelineno-13-12"></a><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">password</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#ansible-variables-__codelineno-13-13"></a><span class="hll"><span class="w">      </span><span class="nt">no_log</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span></code></pre></div>
<details class="info">
<summary>Output of playbook run</summary>
<p>Using the <em>stdout_callback: community.general.yaml</em> for better readability, see <a href="#ansible-project-ansible-configuration">Ansible configuration</a> for more info.<br />
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#ansible-variables-__codelineno-14-1"></a><span class="gp">$ </span>ansible-playbook<span class="w"> </span>nolog.yml<span class="w"> </span>-v
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#ansible-variables-__codelineno-14-2"></a>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#ansible-variables-__codelineno-14-3"></a><span class="go">[...]</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#ansible-variables-__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#ansible-variables-__codelineno-14-5"></a><span class="go">TASK [Add user] *********************************************</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#ansible-variables-__codelineno-14-6"></a><span class="go">[WARNING]: The input password appears not to have been hashed. The &#39;password&#39;</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#ansible-variables-__codelineno-14-7"></a><span class="go">argument must be encrypted for this module to work properly.</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#ansible-variables-__codelineno-14-8"></a><span class="go">ok: [db_server1] =&gt; changed=false</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#ansible-variables-__codelineno-14-9"></a><span class="go">  append: false</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#ansible-variables-__codelineno-14-10"></a><span class="go">  comment: &#39;&#39;</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#ansible-variables-__codelineno-14-11"></a><span class="go">  group: 1002</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#ansible-variables-__codelineno-14-12"></a><span class="go">  home: /home/admin</span>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#ansible-variables-__codelineno-14-13"></a><span class="go">  move_home: false</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#ansible-variables-__codelineno-14-14"></a><span class="go">  name: admin</span>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#ansible-variables-__codelineno-14-15"></a><span class="go">  password: NOT_LOGGING_PASSWORD</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#ansible-variables-__codelineno-14-16"></a><span class="go">  shell: /bin/bash</span>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#ansible-variables-__codelineno-14-17"></a><span class="go">  state: present</span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#ansible-variables-__codelineno-14-18"></a><span class="go">  uid: 1002</span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#ansible-variables-__codelineno-14-19"></a>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#ansible-variables-__codelineno-14-20"></a><span class="go">ASK [Debugging a vaulted Variable with no_log] *************</span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#ansible-variables-__codelineno-14-21"></a><span class="go">ok: [db_server1] =&gt;</span>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#ansible-variables-__codelineno-14-22"></a><span class="go">  censored: &#39;the output has been hidden due to the fact that &#39;&#39;no_log: true&#39;&#39; was specified for this result&#39;</span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#ansible-variables-__codelineno-14-23"></a>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#ansible-variables-__codelineno-14-24"></a><span class="go">[...]</span>
</code></pre></div>
The <em>debug</em> task does not print the value of the password, the output is censored.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>Observing the output from the <em>"Add user"</em> task, you can see that the value of the <em>password</em> parameter is not shown.
The <em>warning</em> from the <em>"Add user"</em> task stating an unencrypted password is related to not having hashed the password. You can achieve this by using the <em>password_hash</em> filter:
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#ansible-variables-__codelineno-15-1"></a><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">vault_password</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">password_hash(&#39;sha512&#39;,</span><span class="nv"> </span><span class="s">&#39;mysecretsalt&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div>
This example uses the string <code>mysecretsalt</code> for salting, in cryptography, a salt is random data that is used as an additional input to a one-way function. Consider using a variable for the salt and treat it the same as the password itself!
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#ansible-variables-__codelineno-16-1"></a><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">vault_password</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">password_hash(&#39;sha512&#39;,</span><span class="nv"> </span><span class="s">vault_salt)</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div>
In this example, the salt is stored in a variable, the same way as the password itself. If you hashed the password, the warning will disappear.</p>
</div>
</details>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#ansible-variables-__codelineno-17-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Not using no_log parameter</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#ansible-variables-__codelineno-17-2"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">database_servers</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#ansible-variables-__codelineno-17-3"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#ansible-variables-__codelineno-17-4"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#ansible-variables-__codelineno-17-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Add user</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#ansible-variables-__codelineno-17-6"></a><span class="w">      </span><span class="nt">ansible.builtin.user</span><span class="p">:</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#ansible-variables-__codelineno-17-7"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">username</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#ansible-variables-__codelineno-17-8"></a><span class="w">        </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">password</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#ansible-variables-__codelineno-17-9"></a>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#ansible-variables-__codelineno-17-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Debugging a vaulted Variable</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#ansible-variables-__codelineno-17-11"></a><span class="w">      </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#ansible-variables-__codelineno-17-12"></a><span class="w">        </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">password</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#ansible-variables-__codelineno-17-13"></a><span class="hll"><span class="l l-Scalar l-Scalar-Plain">​</span>
</span></code></pre></div>
<details class="info">
<summary>Output of playbook run</summary>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#ansible-variables-__codelineno-18-1"></a><span class="gp">$ </span>ansible-playbook<span class="w"> </span>nolog.yml<span class="w"> </span>-v
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#ansible-variables-__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#ansible-variables-__codelineno-18-3"></a><span class="go">[...]</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#ansible-variables-__codelineno-18-4"></a>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#ansible-variables-__codelineno-18-5"></a><span class="go">TASK [Add user] *********************************************</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#ansible-variables-__codelineno-18-6"></a><span class="go">[WARNING]: The input password appears not to have been hashed. The &#39;password&#39;</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#ansible-variables-__codelineno-18-7"></a><span class="go">argument must be encrypted for this module to work properly.</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#ansible-variables-__codelineno-18-8"></a><span class="go">ok: [db_server1] =&gt; changed=false</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#ansible-variables-__codelineno-18-9"></a><span class="go">  append: false</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#ansible-variables-__codelineno-18-10"></a><span class="go">  comment: &#39;&#39;</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#ansible-variables-__codelineno-18-11"></a><span class="go">  group: 1002</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#ansible-variables-__codelineno-18-12"></a><span class="go">  home: /home/admin</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#ansible-variables-__codelineno-18-13"></a><span class="go">  move_home: false</span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#ansible-variables-__codelineno-18-14"></a><span class="go">  name: admin</span>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#ansible-variables-__codelineno-18-15"></a><span class="go">  password: NOT_LOGGING_PASSWORD</span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#ansible-variables-__codelineno-18-16"></a><span class="go">  shell: /bin/bash</span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#ansible-variables-__codelineno-18-17"></a><span class="go">  state: present</span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#ansible-variables-__codelineno-18-18"></a><span class="go">  uid: 1002</span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#ansible-variables-__codelineno-18-19"></a>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#ansible-variables-__codelineno-18-20"></a><span class="go">ASK [Debugging a vaulted Variable with no_log] *************</span>
<a id="__codelineno-18-21" name="__codelineno-18-21" href="#ansible-variables-__codelineno-18-21"></a><span class="go">ok: [db_server1] =&gt;</span>
<a id="__codelineno-18-22" name="__codelineno-18-22" href="#ansible-variables-__codelineno-18-22"></a><span class="go">  msg: ex4mple</span>
<a id="__codelineno-18-23" name="__codelineno-18-23" href="#ansible-variables-__codelineno-18-23"></a>
<a id="__codelineno-18-24" name="__codelineno-18-24" href="#ansible-variables-__codelineno-18-24"></a><span class="go">[...]</span>
</code></pre></div>
</details>
</div>
</div>
</div>
</div>
<h3 id="ansible-variables-prevent-unintentional-commits">Prevent unintentional commits</h3>
<p>Use a <em>pre-commit hook</em> to prevent accidentally committing unencrypted sensitive content. The easiest way would be to use the <em>pre-commit</em> framework/tool with the following configuration:</p>
<div class="highlight"><span class="filename">.pre-commit-config.yaml</span><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#ansible-variables-__codelineno-19-1"></a><span class="nt">repos</span><span class="p">:</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#ansible-variables-__codelineno-19-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/timgrt/pre-commit-hooks</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#ansible-variables-__codelineno-19-3"></a><span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">rev</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.2.1</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#ansible-variables-__codelineno-19-4"></a><span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">hooks</span><span class="p p-Indicator">:</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#ansible-variables-__codelineno-19-5"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-vault-files</span>
</code></pre></div>
<p>Take a look at the <a href="#development-linting-git-pre-commit-hook">development section</a> for additional information.</p>
<h2 id="ansible-variables-disable-variable-templating">Disable variable templating</h2>
<p>Sometimes, it is necessary to provide special characters like curly braces. The most common use cases include passwords that allow special characters like <code>{</code> or <code>%</code>, and JSON arguments that look like templates but should not be templated.  </p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#ansible-variables-__codelineno-20-1"></a><span class="nn">---</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#ansible-variables-__codelineno-20-2"></a><span class="nt">examplepassword</span><span class="p">:</span><span class="w"> </span><span class="kt">!unsafe</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">234%234{435lkj{{lkjsdf</span>
</code></pre></div>
<div class="admonition abstract">
<p class="admonition-title">Abstract</p>
<p>When handling values returned by lookup plugins, Ansible uses a data type called <code>unsafe</code> to block templating. Marking data as unsafe prevents malicious users from abusing Jinja2 templates to execute arbitrary code on target machines. The Ansible implementation <code>!unsafe</code> ensures that these values are never templated. You can use the same unsafe data type in variables you define, to prevent templating errors and information disclosure.</p>
</div>
<p>For complex variables such as hashes or arrays, use <code>!unsafe</code> on the individual elements, take a look at <a href="#automation-platform-credentials-automation-and-templating">this example for AWX/AAP automation</a>.</p>
<p>For Jinja2 templates this behavior can be achieved with the <code>{% raw %}</code> and <code>{% endraw %}</code> tags.<br />
Consider the following <em>template</em> where <em>name_of_receiver_group</em> should be replaced with a variable you set elsewhere, but <em>details</em> contains stuff which should stay as it is:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#ansible-variables-__codelineno-21-1"></a><span class="nt">receivers</span><span class="p">:</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#ansible-variables-__codelineno-21-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">name_of_receiver_group</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#ansible-variables-__codelineno-21-3"></a><span class="w">  </span><span class="nt">opsgenie_configs</span><span class="p">:</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#ansible-variables-__codelineno-21-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">123-123-123-123-123</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#ansible-variables-__codelineno-21-5"></a><span class="w">    </span><span class="nt">send_resolved</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<a id="__codelineno-21-6" name="__codelineno-21-6" href="#ansible-variables-__codelineno-21-6"></a><span class="w">    </span><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">raw %</span><span class="p p-Indicator">}</span>
<a id="__codelineno-21-7" name="__codelineno-21-7" href="#ansible-variables-__codelineno-21-7"></a><span class="w">    </span><span class="c1"># protecting the go templates inside the raw section.</span>
<a id="__codelineno-21-8" name="__codelineno-21-8" href="#ansible-variables-__codelineno-21-8"></a><span class="w">    </span><span class="nt">details</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt"> details</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">.CommonAnnotations.SortedPairs.Values</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">join</span><span class="nv"> </span><span class="s">\&quot;</span><span class="nv"> </span><span class="s">\&quot;</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"> </span><span class="p p-Indicator">}</span>
<a id="__codelineno-21-9" name="__codelineno-21-9" href="#ansible-variables-__codelineno-21-9"></a><span class="w">    </span><span class="p p-Indicator">{</span><span class="err">%</span><span class="w"> </span><span class="nv">endraw %</span><span class="p p-Indicator">}</span>
</code></pre></div>
<!-- markdownlint-disable --></section><h1 class='nav-section-title-end'>Ended: Ansible</h1>
                        <h1 class='nav-section-title' id='section-ansible-development'>
                            Ansible Development <a class='headerlink' href='#section-ansible-development' title='Permanent link'>↵</a>
                        </h1>
                        <section class="print-page" id="development"><h1 id="development-development">Development</h1>
<p>This topic is split into four main sections, each section covers a different additional tool to consider when <em>developing</em> your Ansible content.</p>
<div class="grid cards">
<ul>
<li>
<p><a href="#development-git"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1.5 3.25a2.25 2.25 0 1 1 3 2.122v5.256a2.251 2.251 0 1 1-1.5 0V5.372A2.25 2.25 0 0 1 1.5 3.25Zm5.677-.177L9.573.677A.25.25 0 0 1 10 .854V2.5h1A2.5 2.5 0 0 1 13.5 5v5.628a2.251 2.251 0 1 1-1.5 0V5a1 1 0 0 0-1-1h-1v1.646a.25.25 0 0 1-.427.177L7.177 3.427a.25.25 0 0 1 0-.354ZM3.75 2.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm0 9.5a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Zm8.25.75a.75.75 0 1 0 1.5 0 .75.75 0 0 0-1.5 0Z"/></svg></span> &nbsp; Version Control</a></p>
<hr />
<p>Small guide for version controlling playbooks.</p>
</li>
<li>
<p><a href="#development-linting"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="m9.585.52.929.68c.153.112.331.186.518.215l1.138.175a2.678 2.678 0 0 1 2.24 2.24l.174 1.139c.029.187.103.365.215.518l.68.928a2.677 2.677 0 0 1 0 3.17l-.68.928a1.174 1.174 0 0 0-.215.518l-.175 1.138a2.678 2.678 0 0 1-2.241 2.241l-1.138.175a1.17 1.17 0 0 0-.518.215l-.928.68a2.677 2.677 0 0 1-3.17 0l-.928-.68a1.174 1.174 0 0 0-.518-.215L3.83 14.41a2.678 2.678 0 0 1-2.24-2.24l-.175-1.138a1.17 1.17 0 0 0-.215-.518l-.68-.928a2.677 2.677 0 0 1 0-3.17l.68-.928c.112-.153.186-.331.215-.518l.175-1.14a2.678 2.678 0 0 1 2.24-2.24l1.139-.175c.187-.029.365-.103.518-.215l.928-.68a2.677 2.677 0 0 1 3.17 0ZM7.303 1.728l-.927.68a2.67 2.67 0 0 1-1.18.489l-1.137.174a1.179 1.179 0 0 0-.987.987l-.174 1.136a2.677 2.677 0 0 1-.489 1.18l-.68.928a1.18 1.18 0 0 0 0 1.394l.68.927c.256.348.424.753.489 1.18l.174 1.137c.078.509.478.909.987.987l1.136.174a2.67 2.67 0 0 1 1.18.489l.928.68c.414.305.979.305 1.394 0l.927-.68a2.67 2.67 0 0 1 1.18-.489l1.137-.174a1.18 1.18 0 0 0 .987-.987l.174-1.136a2.67 2.67 0 0 1 .489-1.18l.68-.928a1.176 1.176 0 0 0 0-1.394l-.68-.927a2.686 2.686 0 0 1-.489-1.18l-.174-1.137a1.179 1.179 0 0 0-.987-.987l-1.136-.174a2.677 2.677 0 0 1-1.18-.489l-.928-.68a1.176 1.176 0 0 0-1.394 0ZM11.28 6.78l-3.75 3.75a.75.75 0 0 1-1.06 0L4.72 8.78a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L7 8.94l3.22-3.22a.751.751 0 0 1 1.042.018.751.751 0 0 1 .018 1.042Z"/></svg></span> &nbsp; Linting</a></p>
<hr />
<p>Installation and usage of the community backed Ansible Best Practice checker.</p>
</li>
<li>
<p><a href="#development-testing"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M5.75.75A.75.75 0 0 1 6.5 0h3a.75.75 0 0 1 0 1.5h-.75v1l-.001.041a6.724 6.724 0 0 1 3.464 1.435l.007-.006.75-.75a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734l-.75.75-.006.007a6.75 6.75 0 1 1-10.548 0L2.72 5.03l-.75-.75a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l.75.75.007.006A6.72 6.72 0 0 1 7.25 2.541V1.5H6.5a.75.75 0 0 1-.75-.75ZM8 14.5a5.25 5.25 0 1 0-.001-10.501A5.25 5.25 0 0 0 8 14.5Zm.389-6.7 1.33-1.33a.75.75 0 1 1 1.061 1.06L9.45 8.861A1.503 1.503 0 0 1 8 10.75a1.499 1.499 0 1 1 .389-2.95Z"/></svg></span> &nbsp; Testing</a></p>
<hr />
<p>How to test your Ansible content during development.</p>
</li>
<li>
<p><a href="#development-extending"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M4 8H2.5a1 1 0 0 0-1 1v5.25a.75.75 0 0 1-1.5 0V9a2.5 2.5 0 0 1 2.5-2.5H4V5.133a1.75 1.75 0 0 1 1.533-1.737l2.831-.353.76-.913c.332-.4.825-.63 1.344-.63h.782c.966 0 1.75.784 1.75 1.75V4h2.25a.75.75 0 0 1 0 1.5H13v4h2.25a.75.75 0 0 1 0 1.5H13v.75a1.75 1.75 0 0 1-1.75 1.75h-.782c-.519 0-1.012-.23-1.344-.63l-.761-.912-2.83-.354A1.75 1.75 0 0 1 4 9.867Zm6.276-4.91-.95 1.14a.753.753 0 0 1-.483.265l-3.124.39a.25.25 0 0 0-.219.248v4.734c0 .126.094.233.219.249l3.124.39a.752.752 0 0 1 .483.264l.95 1.14a.25.25 0 0 0 .192.09h.782a.25.25 0 0 0 .25-.25v-8.5a.25.25 0 0 0-.25-.25h-.782a.25.25 0 0 0-.192.09Z"/></svg></span> &nbsp; Extending</a></p>
<hr />
<p>How to create your own custom modules and plugins.</p>
</li>
</ul>
</div>
<h2 id="development-tools">Tools</h2>
<p>Each section above make use of an additional tool to support you during your Ansible content development. In most cases the standalone installation, as well as a custom container-based installation and usage method is described.  </p>
<p>The Ansible community provides a Container image bundling all the tools described in the sections above.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#development-__codelineno-0-1"></a><span class="go">docker pull quay.io/ansible/creator-ee</span>
</code></pre></div>
<p>For example you could output the version of the installed tools like this:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#development-__codelineno-1-1"></a><span class="go">docker run --rm quay.io/ansible/creator-ee ansible-lint --version</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#development-__codelineno-2-1"></a><span class="go">docker run --rm quay.io/ansible/creator-ee molecule --version</span>
</code></pre></div>
<p>Take a look into the respective sections for more information and additional usage instructions.</p>
<!-- markdownlint-disable --></section><section class="print-page" id="development-git"><h1 id="development-git-version-control">Version Control</h1>
<p>Ansible content should be treated as any project containing source code, therefore using version control is always recommended. This guide focuses on <em>Git</em> as it is the most widespread tool.</p>
<h2 id="development-git-installation">Installation</h2>
<p>Most Linux distributions already have <em>Git</em> installed, otherwise install the package with the package manager of the system, for example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#development-git-__codelineno-0-1"></a><span class="go">sudo yum install git</span>
</code></pre></div>
<h2 id="development-git-configuration">Configuration</h2>
<p>Git needs some minimal configuration, most important you need to tell Git who you are.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#development-git-__codelineno-1-1"></a><span class="go">git config --global user.name &quot;Your Name&quot;</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#development-git-__codelineno-2-1"></a><span class="go">git config --global user.email &quot;your.mail@computacenter.com&quot;</span>
</code></pre></div>
<p>Every commit you make can now be traced back to you, this enables collaborating work on Ansible projects.</p>
<h2 id="development-git-workflow">Workflow</h2>
<p>Git has multiple <em>states</em> that your files can reside in:</p>
<ul>
<li><em>untracked</em></li>
<li><em>modified</em></li>
<li><em>staged</em></li>
<li><em>committed</em></li>
</ul>
<p>The files <em>flow</em> through different sections of your Git project:</p>
<ul>
<li><strong>Working Directory</strong> - also called <em>Working tree</em>, this is basically your filesystem where you are developing</li>
<li><strong>Staging Area</strong> - also called <em>Index</em>, the files that will go into your next commit</li>
<li><strong>Local Repository</strong> - the <code>.git</code> folder where metadata and objects are stored for your project.</li>
<li><strong>Remote Repository</strong> - the (optional, but recommended) <em>upstream</em> repository</li>
</ul>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Although this seems complicated, don't worry, in most cases Git is fairly easy.</p>
</div>
<p>The basic Git workflow goes something like this:</p>
<ol>
<li>You modify files in your working tree.</li>
<li>You selectively stage just those changes you want to be part of your next commit, which adds only those changes to the staging area.</li>
<li>You do a commit, which takes the files as they are in the staging area and stores that snapshot permanently to your Git directory.</li>
</ol>
<p>The commands you will be using the most and how the files in different states flow through the stages is shown below:</p>
<pre class="mermaid"><code>sequenceDiagram
  box Remote
  participant UR as Upstream Repository
  end
  box Local
  participant LR as Local Repository
  participant SG as Staging Area
  participant WS as Working Directory
  participant SH as Stash
  end
  UR-&gt;&gt;WS: git clone
  UR-&gt;&gt;WS: git pull
  UR-&gt;&gt;LR: git fetch
  LR-&gt;&gt;WS: git checkout -b &lt;branch-name&gt;
  WS-&gt;&gt;SG: git add &lt;file&gt;
  WS-&gt;&gt;SG: git add -A
  SG-&gt;&gt;LR: git commit -m "Commit message"
  LR-&gt;&gt;UR: git push
  WS-&gt;&gt;SH: git stash
  SH-&gt;&gt;WS: git stash pop</code></pre>
<h2 id="development-git-branching-concept">Branching concept</h2>
<p>Branches are a part of your everyday development process, they are effectively a pointer to a snapshot of your changes. When you want to add a new feature or fix a bug, you spawn a new branch to encapsulate your changes. This makes it harder for unstable code to get merged into the main code base, and it gives you the chance to clean up your future's history before merging it into the main branch.<br />
We are using the following branches:</p>
<ul>
<li>main (protected, only merge commits are allowed)</li>
<li>dev (protected, force-pushes are allowed)</li>
<li>feature/<em>branch-name</em></li>
<li>bugfix/<em>branch-name</em></li>
<li>hotfix/<em>branch-name</em></li>
</ul>
<p>The <em>main</em> branch is the <em>production-code</em>, forking (a <em>feature</em> or <em>bugfix</em> branch) is always done from the <em>dev</em> branch. Forking a <em>hotfix</em> branch is done from the <em>main</em> branch, as it should fix something not working with the production code.</p>
<h3 id="development-git-feature-request">Feature request</h3>
<p>Creating a new feature should be done with a fork of the <em>latest</em> stage of the dev branch, prefix your branch-name with <code>feature/</code> and provide a short, but meaningful description of the new feature.</p>
<pre class="mermaid"><code>gitGraph
   commit
   commit
   branch dev
   checkout dev
   commit
   branch feature
   checkout feature
   commit
   commit
   checkout dev
   commit
   checkout feature
   merge dev
   checkout dev
   merge feature
   commit
   checkout main
   merge dev
   checkout dev
   commit
   checkout main
   commit type:HIGHLIGHT</code></pre>
<p>The complete workflow with <em>git</em> commands looks something like this:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#development-git-__codelineno-3-1"></a><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>dev
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#development-git-__codelineno-3-2"></a><span class="go">Switched to branch &#39;dev&#39;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#development-git-__codelineno-3-3"></a><span class="go">Your branch is behind &#39;origin/dev&#39; by 3 commits, and can be fast-forwarded.</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#development-git-__codelineno-3-4"></a><span class="go">  (use &quot;git pull&quot; to update your local branch)</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#development-git-__codelineno-3-5"></a><span class="gp">$ </span>git<span class="w"> </span>pull
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#development-git-__codelineno-3-6"></a><span class="go">Updating b666be1..e1fc998</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#development-git-__codelineno-3-7"></a><span class="go">Fast-forward</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#development-git-__codelineno-3-8"></a><span class="go">...</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#development-git-__codelineno-3-9"></a><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>feature/postgres-ha
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#development-git-__codelineno-3-10"></a><span class="go">Switched to a new branch &#39;feature/postgres-ha&#39;</span>
</code></pre></div>
<p>The single steps in order:</p>
<ol>
<li><code>git checkout dev</code> - Switching to <em>dev</em> branch.</li>
<li><code>git pull</code> - Getting latest changes from upstream <em>dev</em> branch to local <em>dev</em> branch</li>
<li><code>git checkout -b feature/postgres-ha</code> - Creating and switching to <em>hotfix</em> branch.</li>
</ol>
<p>Start developing, save your work in a commit (or multiple commits).</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#development-git-__codelineno-4-1"></a><span class="gp">$ </span>git<span class="w"> </span>status
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#development-git-__codelineno-4-2"></a><span class="go">...</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#development-git-__codelineno-4-3"></a><span class="gp">$ </span>git<span class="w"> </span>add<span class="w"> </span>-A
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#development-git-__codelineno-4-4"></a><span class="go">...</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#development-git-__codelineno-4-5"></a><span class="gp">$ </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Added tasks to configure Postgres High-Availability.&quot;</span>
</code></pre></div>
<p>As the last step, before pushing your changes to the UR and opening a <em>merge request</em>, ensure that the latest changes from the <em>dev</em> branch (which were made by others during your feature development) are also in your branch and no merge conflicts arise.<br />
Do the following steps:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#development-git-__codelineno-5-1"></a><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>dev
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#development-git-__codelineno-5-2"></a><span class="go">Switched to branch &#39;dev&#39;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#development-git-__codelineno-5-3"></a><span class="go">Your branch is behind &#39;origin/dev&#39; by 2 commits, and can be fast-forwarded.</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#development-git-__codelineno-5-4"></a><span class="go">  (use &quot;git pull&quot; to update your local branch)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#development-git-__codelineno-5-5"></a><span class="gp">$ </span>git<span class="w"> </span>pull
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#development-git-__codelineno-5-6"></a><span class="go">Updating e546ag7..klr732i</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#development-git-__codelineno-5-7"></a><span class="go">Fast-forward</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#development-git-__codelineno-5-8"></a><span class="go">...</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#development-git-__codelineno-5-9"></a><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>feature/postgres-ha
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#development-git-__codelineno-5-10"></a><span class="go">...</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#development-git-__codelineno-5-11"></a><span class="go">Switched to branch &#39;feature/postgres-ha&#39;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#development-git-__codelineno-5-12"></a><span class="gp">$ </span>git<span class="w"> </span>merge<span class="w"> </span>dev
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#development-git-__codelineno-5-13"></a><span class="go">...</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#development-git-__codelineno-5-14"></a><span class="gp">$ </span>git<span class="w"> </span>push<span class="w"> </span>-u<span class="w"> </span>origin
</code></pre></div>
<h3 id="development-git-bugfix-request">Bugfix request</h3>
<p>In case you need to fix a bug in a role or playbook, fork a new branch from <em>dev</em> and prefix your branch-name with <code>bugfix/</code> and provide a short, but meaningful description of the unwanted behavior.  </p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The steps are the same as for a feature branch, only the branch-name should indicate that a bug is to be fixed.</p>
</div>
<pre class="mermaid"><code>gitGraph
   commit
   commit
   branch dev
   checkout dev
   commit
   branch bugfix
   checkout bugfix
   commit
   commit
   checkout dev
   commit
   checkout bugfix
   merge dev
   checkout dev
   merge bugfix
   commit
   checkout main
   merge dev
   checkout dev
   commit
   checkout main
   commit type:HIGHLIGHT</code></pre>
<p>Take a look at the section above for an explanation of the single steps.</p>
<h3 id="development-git-hotfix-request">Hotfix request</h3>
<pre class="mermaid"><code>gitGraph
   commit
   commit
   branch dev
   checkout dev
   commit
   checkout main
   commit
   branch hotfix
   checkout hotfix
   commit
   checkout main
   checkout hotfix
   commit
   checkout main
   merge hotfix
   checkout dev
   merge main
   commit
   commit
   checkout main
   commit type:HIGHLIGHT</code></pre>
<p>The complete workflow with <em>git</em> commands looks something like this:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#development-git-__codelineno-6-1"></a><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>main
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#development-git-__codelineno-6-2"></a><span class="go">Switched to branch &#39;main&#39;</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#development-git-__codelineno-6-3"></a><span class="go">Your branch is behind &#39;origin/main&#39; by 11 commits, and can be fast-forwarded.</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#development-git-__codelineno-6-4"></a><span class="go">  (use &quot;git pull&quot; to update your local branch)</span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#development-git-__codelineno-6-5"></a><span class="gp">$ </span>git<span class="w"> </span>pull
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#development-git-__codelineno-6-6"></a><span class="go">Updating b666be1..e1fc998</span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#development-git-__codelineno-6-7"></a><span class="go">Fast-forward</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#development-git-__codelineno-6-8"></a><span class="go">...</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#development-git-__codelineno-6-9"></a><span class="gp">$ </span>git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>hotfix/mitigate-prod-outage
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#development-git-__codelineno-6-10"></a><span class="go">Switched to a new branch &#39;hotfix/mitigate-prod-outage&#39;</span>
</code></pre></div>
<p>The single steps in order:</p>
<ol>
<li><code>git checkout main</code> - Switching to <em>main</em> branch.</li>
<li><code>git pull</code> - Getting latest changes from upstream <em>main</em> branch to local <em>main</em> branch</li>
<li><code>git checkout -b hotfix/mitigate-prod-outage</code> - Creating and switching to <em>hotfix</em> branch.</li>
</ol>
<p>After creating (and testing!) the fixes, save your work in a commit (or multiple commits).</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#development-git-__codelineno-7-1"></a><span class="gp">$ </span>git<span class="w"> </span>status
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#development-git-__codelineno-7-2"></a><span class="go">...</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#development-git-__codelineno-7-3"></a><span class="gp">$ </span>git<span class="w"> </span>add<span class="w"> </span>-A
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#development-git-__codelineno-7-4"></a><span class="go">...</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#development-git-__codelineno-7-5"></a><span class="gp">$ </span>git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Fixes Issue #31, will restore prod environment.&quot;</span>
</code></pre></div>
<p>Now, push your changes to the UR.</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#development-git-__codelineno-8-1"></a><span class="gp">$ </span>git<span class="w"> </span>push<span class="w"> </span>-u<span class="w"> </span>origin
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#development-git-__codelineno-8-2"></a><span class="go">...</span>
</code></pre></div>
<p>In the UR, open a <em>merge request</em> from your <em>hotfix</em> branch to the <em>main</em> branch.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>After rolling out the changes to the production environment and ensuring the hotfix works as expected, open a new merge request against the <em>dev</em> branch to ensure the fixes are also available in the development stage.</p>
</div>
<h2 id="development-git-git-hooks">Git hooks</h2>
<p>Git Hooks are scripts that Git can execute automatically when certain events occur, such as before or after a commit, push, or merge. There are several types of Git Hooks, each with a specific purpose.</p>
<h3 id="development-git-pre-commit">Pre-Commit</h3>
<p>Pre-commit hooks can be used to enforce code formatting or run tests before a commit is made.  </p>
<p>The most convenient way is the use of the <a href="https://pre-commit.com/" target="_blank">pre-commit framework</a>, install the <em>pre-commit</em> utility:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#development-git-__codelineno-9-1"></a><span class="go">pip3 install pre-commit</span>
</code></pre></div>
<p>Use the following configuration as a starting point, create the file in your project folder.</p>
<div class="highlight"><span class="filename">.pre-commit-config.yaml</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#development-git-__codelineno-10-1"></a><span class="nt">repos</span><span class="p">:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#development-git-__codelineno-10-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/pre-commit/pre-commit-hooks</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#development-git-__codelineno-10-3"></a><span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v4.4.0</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#development-git-__codelineno-10-4"></a><span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#development-git-__codelineno-10-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-yaml</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#development-git-__codelineno-10-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-merge-conflict</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#development-git-__codelineno-10-7"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trailing-whitespace</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#development-git-__codelineno-10-8"></a><span class="w">        </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">--markdown-linebreak-ext=md</span><span class="p p-Indicator">]</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#development-git-__codelineno-10-9"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no-commit-to-branch</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#development-git-__codelineno-10-10"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">requirements-txt-fixer</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#development-git-__codelineno-10-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/timgrt/pre-commit-hooks</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#development-git-__codelineno-10-12"></a><span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v0.2.0</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#development-git-__codelineno-10-13"></a><span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#development-git-__codelineno-10-14"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-file-names</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#development-git-__codelineno-10-15"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">check-vault-files</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#development-git-__codelineno-10-16"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">repo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://github.com/ansible-community/ansible-lint</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#development-git-__codelineno-10-17"></a><span class="w">    </span><span class="nt">rev</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v6.15.0</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#development-git-__codelineno-10-18"></a><span class="w">    </span><span class="nt">hooks</span><span class="p">:</span>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#development-git-__codelineno-10-19"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible-lint</span>
</code></pre></div>
<p>Take a look at <a href="https://pre-commit.com/hooks.html" target="_blank">https://pre-commit.com/hooks.html</a> for additional hooks for your use-case.  </p>
<p>Install all hooks of the <code>.pre-commit-config.yaml</code> file:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#development-git-__codelineno-11-1"></a><span class="go">pre-commit install</span>
</code></pre></div>
<p>Run the <code>autoupdate</code> command to update all revisions to the latest state:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#development-git-__codelineno-12-1"></a><span class="go">pre-commit autoupdate</span>
</code></pre></div>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p><em>pre-commit</em> will now run on every commit.</p>
</div>
<p>You can run all hooks at any time with the following command, without committing:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#development-git-__codelineno-13-1"></a><span class="go">pre-commit run -a</span>
</code></pre></div>
<details class="example">
<summary>Example output</summary>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#development-git-__codelineno-14-1"></a><span class="gp">$ </span>pre-commit<span class="w"> </span>run<span class="w"> </span>-a
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#development-git-__codelineno-14-2"></a><span class="go">check yaml...............................................................Passed</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#development-git-__codelineno-14-3"></a><span class="go">check for merge conflicts................................................Passed</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#development-git-__codelineno-14-4"></a><span class="go">trim trailing whitespace.................................................Passed</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#development-git-__codelineno-14-5"></a><span class="go">don&#39;t commit to branch...................................................Passed</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#development-git-__codelineno-14-6"></a><span class="go">fix requirements.txt.................................(no files to check)Skipped</span>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#development-git-__codelineno-14-7"></a><span class="go">markdownlint-docker......................................................Passed</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#development-git-__codelineno-14-8"></a><span class="go">Check files for non-compliant names......................................Passed</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#development-git-__codelineno-14-9"></a><span class="go">Ansible-lint.............................................................Failed</span>
<a id="__codelineno-14-10" name="__codelineno-14-10" href="#development-git-__codelineno-14-10"></a><span class="go">- hook id: ansible-lint</span>
<a id="__codelineno-14-11" name="__codelineno-14-11" href="#development-git-__codelineno-14-11"></a><span class="go">- exit code: 2</span>
<a id="__codelineno-14-12" name="__codelineno-14-12" href="#development-git-__codelineno-14-12"></a>
<a id="__codelineno-14-13" name="__codelineno-14-13" href="#development-git-__codelineno-14-13"></a><span class="go">[...output cut for readability...]</span>
<a id="__codelineno-14-14" name="__codelineno-14-14" href="#development-git-__codelineno-14-14"></a>
<a id="__codelineno-14-15" name="__codelineno-14-15" href="#development-git-__codelineno-14-15"></a><span class="go">Read documentation for instructions on how to ignore specific rule violations.</span>
<a id="__codelineno-14-16" name="__codelineno-14-16" href="#development-git-__codelineno-14-16"></a>
<a id="__codelineno-14-17" name="__codelineno-14-17" href="#development-git-__codelineno-14-17"></a><span class="go">                      Rule Violation Summary  </span>
<a id="__codelineno-14-18" name="__codelineno-14-18" href="#development-git-__codelineno-14-18"></a><span class="go">count tag                           profile rule associated tags  </span>
<a id="__codelineno-14-19" name="__codelineno-14-19" href="#development-git-__codelineno-14-19"></a><span class="go">    3 role-name                     basic   deprecations, metadata</span>
<a id="__codelineno-14-20" name="__codelineno-14-20" href="#development-git-__codelineno-14-20"></a><span class="go">    1 name[missing]                 basic   idiom  </span>
<a id="__codelineno-14-21" name="__codelineno-14-21" href="#development-git-__codelineno-14-21"></a><span class="go">    2 yaml[comments]                basic   formatting, yaml  </span>
<a id="__codelineno-14-22" name="__codelineno-14-22" href="#development-git-__codelineno-14-22"></a><span class="go">    1 yaml[new-line-at-end-of-file] basic   formatting, yaml  </span>
<a id="__codelineno-14-23" name="__codelineno-14-23" href="#development-git-__codelineno-14-23"></a>
<a id="__codelineno-14-24" name="__codelineno-14-24" href="#development-git-__codelineno-14-24"></a><span class="go">Failed after min profile: 7 failure(s), 0 warning(s) on 30 files.</span>
</code></pre></div>
</details>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>The first time pre-commit runs on a file it will automatically download, install, and run the hook. Note that running a hook for the first time may be slow. but will be faster in subsequent iterations.</p>
</div>
<h4 id="development-git-offline">Offline</h4>
<p>The <em>pre-commit</em> framework by default needs internet connection to setup the hooks, in disconnected environments you can build the pre-commit hook yourself.</p>
<p>The following script can be used as a starting point, it uses <em>ansible-lint</em> from inside a container (see <a href="#development-linting-lint-in-docker-image">Lint in Docker Image</a> how to build it) and also checks for unencrypted files in your commit.</p>
<details class="example">
<summary>.git/hooks/pre-commit</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#development-git-__codelineno-15-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#development-git-__codelineno-15-2"></a><span class="c1">#</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#development-git-__codelineno-15-3"></a><span class="c1"># File should be .git/hooks/pre-commit and executable</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#development-git-__codelineno-15-4"></a><span class="c1">#</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#development-git-__codelineno-15-5"></a>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#development-git-__codelineno-15-6"></a><span class="c1"># Pre-commit hook that runs ansible-lint Container for best practice checking</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#development-git-__codelineno-15-7"></a><span class="c1"># If lint has errors, commit will fail with an error message.</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#development-git-__codelineno-15-8"></a><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span><span class="k">$(</span>docker<span class="w"> </span>inspect<span class="w"> </span>ansible-lint<span class="k">)</span><span class="w"> </span><span class="o">]]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#development-git-__codelineno-15-9"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;# DOCKER IMAGE NOT FOUND&quot;</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#development-git-__codelineno-15-10"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;# Build the Docker image from the Gitlab project &#39;ansible-lint Docker Image&#39;.&quot;</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#development-git-__codelineno-15-11"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;# No linting is done!&quot;</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#development-git-__codelineno-15-12"></a><span class="k">else</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#development-git-__codelineno-15-13"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;# Running &#39;ansible-lint&#39; against commit, this takes some time ...&quot;</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#development-git-__codelineno-15-14"></a><span class="w">  </span><span class="c1"># Getting all files currently staged and storing them in variable</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#development-git-__codelineno-15-15"></a><span class="w">  </span><span class="nv">FILES_TO_LINT</span><span class="o">=</span><span class="k">$(</span>git<span class="w"> </span>diff<span class="w"> </span>--cached<span class="w"> </span>--name-only<span class="k">)</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#development-git-__codelineno-15-16"></a><span class="w">  </span><span class="c1"># Running with shared profile, see https://ansible-lint.readthedocs.io/profiles/</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#development-git-__codelineno-15-17"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$FILES_TO_LINT</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#development-git-__codelineno-15-18"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;# No files linting found. Add files to SG area with &#39;git add &lt;file&gt;&#39;.&quot;</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#development-git-__codelineno-15-19"></a><span class="w">  </span><span class="k">else</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#development-git-__codelineno-15-20"></a><span class="w">    </span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>-v<span class="w"> </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/data<span class="w"> </span>ansible-lint<span class="w"> </span><span class="nv">$FILES_TO_LINT</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#development-git-__codelineno-15-21"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span><span class="nv">$?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#development-git-__codelineno-15-22"></a><span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;# COMMIT REJECTED&quot;</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#development-git-__codelineno-15-23"></a><span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;# Please fix the shown linting errors&quot;</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#development-git-__codelineno-15-24"></a><span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;#   (or force the commit with &#39;--no-verify&#39;).&quot;</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#development-git-__codelineno-15-25"></a><span class="w">      </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span><span class="p">;</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#development-git-__codelineno-15-26"></a><span class="w">    </span><span class="k">fi</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#development-git-__codelineno-15-27"></a><span class="w">  </span><span class="k">fi</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#development-git-__codelineno-15-28"></a><span class="k">fi</span>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#development-git-__codelineno-15-29"></a>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#development-git-__codelineno-15-30"></a><span class="c1"># Pre-commit hook that verifies if all files containing &#39;vault&#39; in the name</span>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#development-git-__codelineno-15-31"></a><span class="c1"># are encrypted.</span>
<a id="__codelineno-15-32" name="__codelineno-15-32" href="#development-git-__codelineno-15-32"></a><span class="c1"># If not, commit will fail with an error message.</span>
<a id="__codelineno-15-33" name="__codelineno-15-33" href="#development-git-__codelineno-15-33"></a><span class="c1"># Finds all files in &#39;inventory&#39; folder or &#39;files&#39; folder in roles. Files in other</span>
<a id="__codelineno-15-34" name="__codelineno-15-34" href="#development-git-__codelineno-15-34"></a><span class="c1"># locations are not recognized!</span>
<a id="__codelineno-15-35" name="__codelineno-15-35" href="#development-git-__codelineno-15-35"></a><span class="nv">FILES_PATTERN</span><span class="o">=</span><span class="s1">&#39;(inventory.*vault.*)|(files.*vault.*)&#39;</span>
<a id="__codelineno-15-36" name="__codelineno-15-36" href="#development-git-__codelineno-15-36"></a><span class="nv">REQUIRED</span><span class="o">=</span><span class="s1">&#39;ANSIBLE_VAULT&#39;</span>
<a id="__codelineno-15-37" name="__codelineno-15-37" href="#development-git-__codelineno-15-37"></a>
<a id="__codelineno-15-38" name="__codelineno-15-38" href="#development-git-__codelineno-15-38"></a><span class="nv">EXIT_STATUS</span><span class="o">=</span><span class="m">0</span>
<a id="__codelineno-15-39" name="__codelineno-15-39" href="#development-git-__codelineno-15-39"></a><span class="nv">wipe</span><span class="o">=</span><span class="s2">&quot;\033[1m\033[0m&quot;</span>
<a id="__codelineno-15-40" name="__codelineno-15-40" href="#development-git-__codelineno-15-40"></a><span class="nv">yellow</span><span class="o">=</span><span class="s1">&#39;\033[1;33m&#39;</span>
<a id="__codelineno-15-41" name="__codelineno-15-41" href="#development-git-__codelineno-15-41"></a><span class="c1"># carriage return hack. Leave it on 2 lines.</span>
<a id="__codelineno-15-42" name="__codelineno-15-42" href="#development-git-__codelineno-15-42"></a><span class="nv">cr</span><span class="o">=</span><span class="s1">&#39;</span>
<a id="__codelineno-15-43" name="__codelineno-15-43" href="#development-git-__codelineno-15-43"></a><span class="s1">&#39;</span>
<a id="__codelineno-15-44" name="__codelineno-15-44" href="#development-git-__codelineno-15-44"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;# Checking for unencrypted vault files in commit ...&quot;</span>
<a id="__codelineno-15-45" name="__codelineno-15-45" href="#development-git-__codelineno-15-45"></a><span class="k">for</span><span class="w"> </span>f<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="k">$(</span>git<span class="w"> </span>diff<span class="w"> </span>--cached<span class="w"> </span>--name-only<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-E<span class="w"> </span><span class="nv">$FILES_PATTERN</span><span class="k">)</span>
<a id="__codelineno-15-46" name="__codelineno-15-46" href="#development-git-__codelineno-15-46"></a><span class="k">do</span>
<a id="__codelineno-15-47" name="__codelineno-15-47" href="#development-git-__codelineno-15-47"></a><span class="w">  </span><span class="c1"># test for the presence of the required bit.</span>
<a id="__codelineno-15-48" name="__codelineno-15-48" href="#development-git-__codelineno-15-48"></a><span class="w">  </span><span class="nv">MATCH</span><span class="o">=</span><span class="sb">`</span>head<span class="w"> </span>-n1<span class="w"> </span><span class="nv">$f</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>--no-messages<span class="w"> </span><span class="nv">$REQUIRED</span><span class="sb">`</span>
<a id="__codelineno-15-49" name="__codelineno-15-49" href="#development-git-__codelineno-15-49"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span><span class="nv">$MATCH</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-15-50" name="__codelineno-15-50" href="#development-git-__codelineno-15-50"></a><span class="w">    </span><span class="c1"># Build the list of unencrypted files if any</span>
<a id="__codelineno-15-51" name="__codelineno-15-51" href="#development-git-__codelineno-15-51"></a><span class="w">    </span><span class="nv">UNENCRYPTED_FILES</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$f$cr$UNENCRYPTED_FILES</span><span class="s2">&quot;</span>
<a id="__codelineno-15-52" name="__codelineno-15-52" href="#development-git-__codelineno-15-52"></a><span class="w">    </span><span class="nv">EXIT_STATUS</span><span class="o">=</span><span class="m">1</span>
<a id="__codelineno-15-53" name="__codelineno-15-53" href="#development-git-__codelineno-15-53"></a><span class="w">  </span><span class="k">fi</span>
<a id="__codelineno-15-54" name="__codelineno-15-54" href="#development-git-__codelineno-15-54"></a><span class="k">done</span>
<a id="__codelineno-15-55" name="__codelineno-15-55" href="#development-git-__codelineno-15-55"></a><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span><span class="nv">$EXIT_STATUS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-15-56" name="__codelineno-15-56" href="#development-git-__codelineno-15-56"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;# COMMIT REJECTED&#39;</span>
<a id="__codelineno-15-57" name="__codelineno-15-57" href="#development-git-__codelineno-15-57"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;# Looks like unencrypted ansible-vault files are part of the commit:&#39;</span>
<a id="__codelineno-15-58" name="__codelineno-15-58" href="#development-git-__codelineno-15-58"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;#&#39;</span>
<a id="__codelineno-15-59" name="__codelineno-15-59" href="#development-git-__codelineno-15-59"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>line<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-15-60" name="__codelineno-15-60" href="#development-git-__codelineno-15-60"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-15-61" name="__codelineno-15-61" href="#development-git-__codelineno-15-61"></a><span class="w">      </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;#\t</span><span class="si">${</span><span class="nv">yellow</span><span class="si">}</span><span class="s2">unencrypted:   </span><span class="nv">$line</span><span class="si">${</span><span class="nv">wipe</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-15-62" name="__codelineno-15-62" href="#development-git-__codelineno-15-62"></a><span class="w">    </span><span class="k">fi</span>
<a id="__codelineno-15-63" name="__codelineno-15-63" href="#development-git-__codelineno-15-63"></a><span class="w">  </span><span class="k">done</span><span class="w"> </span><span class="o">&lt;&lt;&lt;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$UNENCRYPTED_FILES</span><span class="s2">&quot;</span>
<a id="__codelineno-15-64" name="__codelineno-15-64" href="#development-git-__codelineno-15-64"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;#&#39;</span>
<a id="__codelineno-15-65" name="__codelineno-15-65" href="#development-git-__codelineno-15-65"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;# Please encrypt them with &#39;ansible-vault encrypt &lt;file&gt;&#39;&quot;</span>
<a id="__codelineno-15-66" name="__codelineno-15-66" href="#development-git-__codelineno-15-66"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;#   (or force the commit with &#39;--no-verify&#39;).&quot;</span>
<a id="__codelineno-15-67" name="__codelineno-15-67" href="#development-git-__codelineno-15-67"></a><span class="w">  </span><span class="nb">exit</span><span class="w"> </span><span class="nv">$EXIT_STATUS</span>
<a id="__codelineno-15-68" name="__codelineno-15-68" href="#development-git-__codelineno-15-68"></a><span class="k">fi</span>
<a id="__codelineno-15-69" name="__codelineno-15-69" href="#development-git-__codelineno-15-69"></a><span class="nb">exit</span><span class="w"> </span><span class="nv">$EXIT_STATUS</span>
</code></pre></div>
</details>
<!-- markdownlint-disable --></section><section class="print-page" id="development-linting"><h1 id="development-linting-linting">Linting</h1>
<p><a href="https://ansible-lint.readthedocs.io/" target="_blank"><em>Ansible Lint</em></a> is a best-practice checker for Ansible, maintained by the Ansible community.</p>
<h2 id="development-linting-installation">Installation</h2>
<p>Ansible Lint is installed through the Python packet manager:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>Ansible Lint</em> always needs <em>Ansible</em> itself, <em>ansible-core</em> is enough.</p>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#development-linting-__codelineno-0-1"></a><span class="go">pip3 install ansible-lint</span>
</code></pre></div>
<h2 id="development-linting-configuration">Configuration</h2>
<p>Minimal configuration is necessary, use the following as a starting point in your project directory:</p>
<div class="highlight"><span class="filename">.ansible-lint</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#development-linting-__codelineno-1-1"></a><span class="nn">---</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#development-linting-__codelineno-1-2"></a><span class="nt">profile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shared</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#development-linting-__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#development-linting-__codelineno-1-4"></a><span class="c1"># Silence infos, warnings and don&#39;t show summary</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#development-linting-__codelineno-1-5"></a><span class="nt">quiet</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#development-linting-__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#development-linting-__codelineno-1-7"></a><span class="nt">skip_list</span><span class="p">:</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#development-linting-__codelineno-1-8"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">role-name</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#development-linting-__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#development-linting-__codelineno-1-10"></a><span class="c1"># Enable some useful rules which are opt-in</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#development-linting-__codelineno-1-11"></a><span class="nt">enable_list</span><span class="p">:</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#development-linting-__codelineno-1-12"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">args</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#development-linting-__codelineno-1-13"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">empty-string-compare</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#development-linting-__codelineno-1-14"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no-log-password</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#development-linting-__codelineno-1-15"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no-same-owner</span>
</code></pre></div>
<p>Profiles gradually increase the strictness of rules, from lowest to highest, every profile extends to previous:</p>
<table>
<thead>
<tr>
<th>Strictness</th>
<th>Profile name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>min</td>
<td>ensures that Ansible can load content, rules in this profile are mandatory</td>
</tr>
<tr>
<td>2</td>
<td>basic</td>
<td>prevents common coding issues and enforces standard styles and formatting</td>
</tr>
<tr>
<td>3</td>
<td>moderate</td>
<td>ensures that content adheres to best practices for making content easier to read and maintain</td>
</tr>
<tr>
<td>4</td>
<td>safety</td>
<td>avoids module calls that can have non-determinant outcomes or security concerns</td>
</tr>
<tr>
<td>5</td>
<td><strong>shared</strong></td>
<td>for packaging and publishing to <em>galaxy.ansible.com</em>, <em>automation-hub</em>, or a private instance</td>
</tr>
<tr>
<td>6</td>
<td>production</td>
<td>for inclusion in AAP as <em>validated</em> or <em>certified</em> content</td>
</tr>
</tbody>
</table>
<p>Take a look at the <a href="https://ansible-lint.readthedocs.io/configuring/" target="_blank">official documentation</a> for more information.</p>
<h2 id="development-linting-usage">Usage</h2>
<p>The usage is fairly simple, just run <code>ansible-lint &lt;your-playbook&gt;</code>.<br />
The tool will check your playbook for best-practices, it traverses your playbook and will lint all included playbooks and roles.</p>
<p>Take a look at the <a href="https://ansible-lint.readthedocs.io/" target="_blank"><em>ansible-lint documentation</em></a> for additional information.</p>
<h3 id="development-linting-lint-in-docker-image">Lint in Docker Image</h3>
<p>The following <em>Dockerfile</em> can be used to build a Docker Container image which bundles <em>ansible-lint</em> and its dependencies:</p>
<details class="example">
<summary>Dockerfile</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#development-linting-__codelineno-2-1"></a><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9-slim</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#development-linting-__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#development-linting-__codelineno-2-3"></a><span class="c"># Enable colored output</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#development-linting-__codelineno-2-4"></a><span class="k">ENV</span><span class="w"> </span>TERM<span class="w"> </span>xterm-256color
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#development-linting-__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#development-linting-__codelineno-2-6"></a><span class="c"># Defining Ansible environment variable to not output deprecation warnings. This is not useful in the linting container.</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#development-linting-__codelineno-2-7"></a><span class="c"># This overwrites the value in the ansible.cfg from volume mount</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#development-linting-__codelineno-2-8"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">ANSIBLE_DEPRECATION_WARNINGS</span><span class="o">=</span><span class="nb">false</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#development-linting-__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#development-linting-__codelineno-2-10"></a><span class="c"># Install requirements.</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#development-linting-__codelineno-2-11"></a><span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#development-linting-__codelineno-2-12"></a><span class="w">  </span>git<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#development-linting-__codelineno-2-13"></a><span class="w">  </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#development-linting-__codelineno-2-14"></a>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#development-linting-__codelineno-2-15"></a><span class="c"># Update pip</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#development-linting-__codelineno-2-16"></a><span class="k">RUN</span><span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>--no-compile<span class="w"> </span>--upgrade<span class="w"> </span>pip
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#development-linting-__codelineno-2-17"></a>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#development-linting-__codelineno-2-18"></a><span class="c"># Install ansible-lint and dependencies</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#development-linting-__codelineno-2-19"></a><span class="k">RUN</span><span class="w"> </span>pip3<span class="w"> </span>install<span class="w"> </span>--no-cache-dir<span class="w"> </span>--no-compile<span class="w"> </span>ansible-lint<span class="w"> </span>ansible<span class="w"> </span>yamllint
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#development-linting-__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#development-linting-__codelineno-2-21"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/data</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#development-linting-__codelineno-2-22"></a><span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;ansible-lint&quot;</span><span class="p">]</span>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#development-linting-__codelineno-2-23"></a><span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;--version&quot;</span><span class="p">]</span>
</code></pre></div>
</details>
<p>Build the container image, the command expects that the <em>Dockerfile</em> is present in the current directory:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#development-linting-__codelineno-3-1"></a><span class="go">docker build -t ansible-lint .</span>
</code></pre></div>
<p>After building the image, the image can be used. Inside of the Ansible project directory, run this command (e.g. this lints the <code>site.yml</code> playbook).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#development-linting-__codelineno-4-1"></a><span class="go">docker run --rm -v $(pwd):/data ansible-lint site.yml</span>
</code></pre></div>
<p>The output for example is something like this, <em>ansible-lint</em> reports a warning regarding unnecessary white-spaces in a line, as well as an error regarding unset file permissions (fix could be setting <code>mode: 0644</code> in the task):</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#development-linting-__codelineno-5-1"></a><span class="gp">$ </span>docker<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>-v<span class="w"> </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/data<span class="w"> </span>ansible-lint<span class="w"> </span>site.yml
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#development-linting-__codelineno-5-2"></a><span class="go">WARNING  Overriding detected file kind &#39;yaml&#39; with &#39;playbook&#39; for given positional argument: site.yml</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#development-linting-__codelineno-5-3"></a><span class="go">WARNING  Listing 2 violation(s) that are fatal</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#development-linting-__codelineno-5-4"></a><span class="go">yaml: trailing spaces (trailing-spaces)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#development-linting-__codelineno-5-5"></a><span class="go">roles/network/tasks/cacheserve-loopback-interface.yml:19</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#development-linting-__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#development-linting-__codelineno-5-7"></a><span class="go">risky-file-permissions: File permissions unset or incorrect</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#development-linting-__codelineno-5-8"></a><span class="go">roles/network/tasks/cacheserve-loopback-interface.yml:43 Task/Handler: Deploy loopback interface config for Cacheserve</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#development-linting-__codelineno-5-9"></a>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#development-linting-__codelineno-5-10"></a><span class="go">You can skip specific rules or tags by adding them to your configuration file:</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#development-linting-__codelineno-5-11"></a><span class="gp"># </span>.ansible-lint
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#development-linting-__codelineno-5-12"></a><span class="go">warn_list:  # or &#39;skip_list&#39; to silence them completely</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#development-linting-__codelineno-5-13"></a><span class="go">  - experimental  # all rules tagged as experimental</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#development-linting-__codelineno-5-14"></a><span class="go">  - yaml  # Violations reported by yamllint</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#development-linting-__codelineno-5-15"></a>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#development-linting-__codelineno-5-16"></a><span class="go">Finished with 1 failure(s), 1 warning(s) on 460 files.</span>
</code></pre></div>
<p>To simplify the usage, consider adding an <em>alias</em> to your <code>.bashrc</code>, e.g.:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#development-linting-__codelineno-6-1"></a><span class="gp"># </span>.bashrc
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#development-linting-__codelineno-6-2"></a><span class="gp"># </span>User<span class="w"> </span>specific<span class="w"> </span>aliases<span class="w"> </span>and<span class="w"> </span>functions
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#development-linting-__codelineno-6-3"></a><span class="go">alias lint=&quot;docker run --rm -v $(pwd):/data ansible-lint&quot;</span>
</code></pre></div>
<p>After running <code>source ~/.bashrc</code> you can use the alias:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#development-linting-__codelineno-7-1"></a><span class="go">lint site.yml</span>
</code></pre></div>
<h2 id="development-linting-automated-linting">Automated Linting</h2>
<p>Lining can and should be done automatically, this way you can't forget to check your playbook for best practices. This can be done on multiple levels, either locally as part of your Git workflow, as well as with a pipeline in your remote repository.</p>
<h3 id="development-linting-git-pre-commit-hook">Git pre-commit hook</h3>
<p>A nice way to check for best practices during your Git workflow is the usage of a <em>pre-commit</em> hook. These hooks can be simple bash script, which are run whenever you are committing changes locally to the staging area or a framework/utility like <a href="https://pre-commit.com/" target="_blank">pre-commit</a>.</p>
<p>Take a look at the <a href="#development-git-pre-commit">Version Control section</a> for installing and configuring <em>pre-commit</em> hooks.</p>
<h3 id="development-linting-ci-pipeline"><abbr title="Continuous Integration">CI</abbr> Pipeline</h3>
<p>Running <em>ansible-lint</em> through a <abbr title="Continuous Integration">CI</abbr> pipeline automatically when merging changes to the Git repository is <strong>highly advisable</strong>.</p>
<p>A possible pipeline in Gitlab may look like this, utilizing the container image above:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#development-linting-__codelineno-8-1"></a><span class="nt">workflow</span><span class="p">:</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#development-linting-__codelineno-8-2"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#development-linting-__codelineno-8-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$CI_PIPELINE_SOURCE == &#39;merge_request_event&#39;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#development-linting-__codelineno-8-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$CI_PIPELINE_SOURCE == &#39;web&#39;</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#development-linting-__codelineno-8-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$CI_PIPELINE_SOURCE == &#39;schedule&#39;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#development-linting-__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#development-linting-__codelineno-8-7"></a><span class="nt">variables</span><span class="p">:</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#development-linting-__codelineno-8-8"></a><span class="w">  </span><span class="nt">GIT_STRATEGY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">clone</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#development-linting-__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#development-linting-__codelineno-8-10"></a><span class="nt">stages</span><span class="p">:</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#development-linting-__codelineno-8-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prepare</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#development-linting-__codelineno-8-12"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">syntax</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#development-linting-__codelineno-8-13"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lint</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#development-linting-__codelineno-8-14"></a>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#development-linting-__codelineno-8-15"></a><span class="nt">prepare</span><span class="p">:</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#development-linting-__codelineno-8-16"></a><span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prepare</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#development-linting-__codelineno-8-17"></a><span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#development-linting-__codelineno-8-18"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">&quot;###</span><span class="nv"> </span><span class="s">Prepare</span><span class="nv"> </span><span class="s">playbook</span><span class="nv"> </span><span class="s">execution.</span><span class="nv"> </span><span class="s">###&quot;&#39;</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#development-linting-__codelineno-8-19"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;cp</span><span class="nv"> </span><span class="s">ansible.cfg.sample-lab</span><span class="nv"> </span><span class="s">ansible.cfg&#39;</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#development-linting-__codelineno-8-20"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">&quot;$VAULT_PASSWORD&quot;</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">.vault-password&#39;</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#development-linting-__codelineno-8-21"></a><span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#development-linting-__codelineno-8-22"></a><span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#development-linting-__codelineno-8-23"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible.cfg</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#development-linting-__codelineno-8-24"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.vault-password</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#development-linting-__codelineno-8-25"></a><span class="w">  </span><span class="nt">cache</span><span class="p">:</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#development-linting-__codelineno-8-26"></a><span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#development-linting-__codelineno-8-27"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible.cfg</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#development-linting-__codelineno-8-28"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.vault-password</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#development-linting-__codelineno-8-29"></a><span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#development-linting-__codelineno-8-30"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible-lint</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#development-linting-__codelineno-8-31"></a>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#development-linting-__codelineno-8-32"></a><span class="nt">syntax-check</span><span class="p">:</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#development-linting-__codelineno-8-33"></a><span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">syntax</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#development-linting-__codelineno-8-34"></a><span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#development-linting-__codelineno-8-35"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">&quot;Perform</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">syntax</span><span class="nv"> </span><span class="s">check</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">playbook.</span><span class="nv"> </span><span class="s">###&quot;&#39;</span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#development-linting-__codelineno-8-36"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;docker</span><span class="nv"> </span><span class="s">run</span><span class="nv"> </span><span class="s">--rm</span><span class="nv"> </span><span class="s">--entrypoint</span><span class="nv"> </span><span class="s">ansible-playbook</span><span class="nv"> </span><span class="s">-v</span><span class="nv"> </span><span class="s">$(pwd):/data</span><span class="nv"> </span><span class="s">ansible-lint</span><span class="nv"> </span><span class="s">site.yml</span><span class="nv"> </span><span class="s">--syntax-check&#39;</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#development-linting-__codelineno-8-37"></a><span class="w">  </span><span class="nt">cache</span><span class="p">:</span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#development-linting-__codelineno-8-38"></a><span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#development-linting-__codelineno-8-39"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible.cfg</span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#development-linting-__codelineno-8-40"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.vault-password</span>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#development-linting-__codelineno-8-41"></a><span class="w">  </span><span class="nt">dependencies</span><span class="p">:</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#development-linting-__codelineno-8-42"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prepare</span>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#development-linting-__codelineno-8-43"></a><span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#development-linting-__codelineno-8-44"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible-lint</span>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#development-linting-__codelineno-8-45"></a>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#development-linting-__codelineno-8-46"></a><span class="nt">ansible-lint</span><span class="p">:</span>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#development-linting-__codelineno-8-47"></a><span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lint</span>
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#development-linting-__codelineno-8-48"></a><span class="w">  </span><span class="nt">script</span><span class="p">:</span>
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#development-linting-__codelineno-8-49"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">&quot;###</span><span class="nv"> </span><span class="s">Check</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">best</span><span class="nv"> </span><span class="s">practices</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">ansible-lint.</span><span class="nv"> </span><span class="s">###&quot;&#39;</span>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#development-linting-__codelineno-8-50"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">&quot;###</span><span class="nv"> </span><span class="s">Using</span><span class="nv"> </span><span class="s">ansible-lint</span><span class="nv"> </span><span class="s">version:</span><span class="nv"> </span><span class="s">###&quot;&#39;</span>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#development-linting-__codelineno-8-51"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;docker</span><span class="nv"> </span><span class="s">run</span><span class="nv"> </span><span class="s">--rm</span><span class="nv"> </span><span class="s">-v</span><span class="nv"> </span><span class="s">$(pwd):/data</span><span class="nv"> </span><span class="s">ansible-lint&#39;</span>
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#development-linting-__codelineno-8-52"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;docker</span><span class="nv"> </span><span class="s">run</span><span class="nv"> </span><span class="s">--rm</span><span class="nv"> </span><span class="s">-v</span><span class="nv"> </span><span class="s">$(pwd):/data</span><span class="nv"> </span><span class="s">ansible-lint</span><span class="nv"> </span><span class="s">site.yml&#39;</span>
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#development-linting-__codelineno-8-53"></a><span class="w">  </span><span class="nt">cache</span><span class="p">:</span>
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#development-linting-__codelineno-8-54"></a><span class="w">    </span><span class="nt">paths</span><span class="p">:</span>
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#development-linting-__codelineno-8-55"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible.cfg</span>
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#development-linting-__codelineno-8-56"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.vault-password</span>
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#development-linting-__codelineno-8-57"></a><span class="w">  </span><span class="nt">dependencies</span><span class="p">:</span>
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#development-linting-__codelineno-8-58"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prepare</span>
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#development-linting-__codelineno-8-59"></a><span class="w">  </span><span class="nt">tags</span><span class="p">:</span>
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#development-linting-__codelineno-8-60"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible-lint</span>
</code></pre></div>
<p>If you want to utilize the installed <em>ansible</em> and <em>ansible-lint</em> utilities on the host running the Gitlab Runner change the commands in the <em>syntax</em> stage to <code>ansible-playbook site.yml --syntax-check</code> and in the <em>lint</em> stage to <code>ansible-lint --version</code> and <code>ansible-lint site.yml</code>.</p>
<!-- markdownlint-disable --></section><section class="print-page" id="development-testing"><h1 id="development-testing-testing">Testing</h1>
<p>With many people contributing to the automation, it is crucial to test the automation content in-depth. So when you’re developing new Ansible Content like playbooks, roles and collections, it’s a good idea to test the content in a test environment before using it to automate production infrastructure. Testing ensures the automation works as designed and avoids unpleasant surprises down the road.<br />
Testing automation content is often a challenge, since it requires the deployment of specific testing infrastructure as well as setting up the testing conditions to ensure the tests are relevant.</p>
<p>Consider the following list for testing your Ansible content, with increasing complexity:</p>
<ol>
<li>yamllint</li>
<li>ansible-playbook --syntax-check</li>
<li>ansible-lint</li>
<li>molecule test</li>
<li>ansible-playbook --check (<em>against production</em>)</li>
<li>Parallel infrastructure</li>
</ol>
<h2 id="development-testing-syntax-check">Syntax check</h2>
<p>The whole playbook (and all roles and tasks) need to, minimally, pass a basic ansible-playbook syntax check run.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#development-testing-__codelineno-0-1"></a><span class="go">ansible-playbook main.yml --syntax-check</span>
</code></pre></div>
<p>Running this as a step in a <abbr title="Continuous Integration">CI</abbr> Pipeline is advisable.</p>
<h2 id="development-testing-linting">Linting</h2>
<p>Take a look at the <a href="#development-linting">Linting section</a> for further information.</p>
<h2 id="development-testing-molecule">Molecule</h2>
<p>The <em>Molecule</em> project is designed to aid in the development and testing of Ansible roles, provides support for testing with multiple instances, operating systems and distributions, virtualization providers, test frameworks and testing scenarios.<br />
Molecule is mostly used to test roles in isolation (although it is possible to test multiple roles or playbooks at once). To test against a fresh system, molecule uses a container runtime to provision virtualized/containerized test hosts, runs commands on them and asserts the success. Molecule does not connect via ssh to the container, instead it uses an Ansible installation inside the container. It is therefore necessary to use a custom build container image.</p>
<p>Take a look at the <a href="https://molecule.readthedocs.io/en/latest/index.html#" target="_blank">Molecule documentation</a> for a full overview.</p>
<h3 id="development-testing-installation">Installation</h3>
<p>The described configuration below expects the <em>Podman</em> container runtime on the Ansible Controller (other drivers like <em>Docker</em> are available). You can install Podman with the following command:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#development-testing-__codelineno-1-1"></a><span class="go">sudo apt install podman</span>
</code></pre></div>
<p>The <em>Molecule</em> binary and dependencies are installed through the <em>Python package manager</em>, you'll need a fairly new Python version (<em>Python &gt;= 3.10</em> with <em>ansible-core &gt;= 2.12</em>).<br />
Use a <em>Python Virtual environment</em> (requires the <code>python3-venv</code> package) to encapsulate the installation from the rest of your Controller.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#development-testing-__codelineno-2-1"></a><span class="go">python3 -m venv molecule-venv</span>
</code></pre></div>
<p>Activate the <abbr title="Virtual Environment">VE</abbr>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#development-testing-__codelineno-3-1"></a><span class="go">source molecule-venv/bin/activate</span>
</code></pre></div>
<p>Install dependencies, after upgrading pip:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#development-testing-__codelineno-4-1"></a><span class="go">pip3 install --upgrade pip setuptools</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#development-testing-__codelineno-5-1"></a><span class="go">pip3 install ansible-core molecule molecule-plugins[podman]</span>
</code></pre></div>
<p>Molecule plugins contains the following provider:</p>
<ul>
<li>azure</li>
<li>containers</li>
<li>docker</li>
<li>ec2</li>
<li>gce</li>
<li>podman</li>
<li>vagrant</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Molecule Podman provider requires the modules of the <em>containers.podman</em> collection (as it provisions the containers with Ansible itself).<br />
If you only installed <code>ansible-core</code>, you'll need to install the collection separately:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#development-testing-__codelineno-6-1"></a><span class="go">ansible-galaxy collection install containers.podman</span>
</code></pre></div>
</div>
<p>If you are done with Molecule testing, use <code>deactivate</code> to leave your <abbr title="Virtual Environment">VE</abbr>.</p>
<h3 id="development-testing-configuration">Configuration</h3>
<p>The <em>molecule</em> configuration files are kept in the role folder you want to test. Create the directory <code>molecule/default</code> and at least the <code>molecule.yml</code> and <code>converge.yml</code>:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#development-testing-__codelineno-7-1"></a><span class="go">roles/</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#development-testing-__codelineno-7-2"></a><span class="go">└── webserver-demo</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#development-testing-__codelineno-7-3"></a><span class="go">    ├── defaults</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#development-testing-__codelineno-7-4"></a><span class="go">    │   └── main.yml</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#development-testing-__codelineno-7-5"></a><span class="go">    ├── molecule</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#development-testing-__codelineno-7-6"></a><span class="go">    │   └── default</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#development-testing-__codelineno-7-7"></a><span class="go">    │       ├── converge.yml</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#development-testing-__codelineno-7-8"></a><span class="go">    │       └── molecule.yml</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#development-testing-__codelineno-7-9"></a><span class="go">    ├── tasks</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#development-testing-__codelineno-7-10"></a><span class="go">    │   └── main.yml</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#development-testing-__codelineno-7-11"></a><span class="go">    └── templates</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#development-testing-__codelineno-7-12"></a><span class="go">        └── index.html</span>
</code></pre></div>
<p>You may use these example configurations as a starting point. It expects that the Container image is already present (use <code>podman pull docker.io/timgrt/rockylinux9-ansible:latest</code>).</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:4"><input checked="checked" id="development-testing-__tabbed_1_1" name="development-testing-__tabbed_1" type="radio" /><input id="development-testing-__tabbed_1_2" name="development-testing-__tabbed_1" type="radio" /><input id="development-testing-__tabbed_1_3" name="development-testing-__tabbed_1" type="radio" /><input id="development-testing-__tabbed_1_4" name="development-testing-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="development-testing-__tabbed_1_1">Central Molecule configuration</label><label for="development-testing-__tabbed_1_2">Playbook file</label><label for="development-testing-__tabbed_1_3">Preparation stage</label><label for="development-testing-__tabbed_1_4">Verification</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">molecule.yml</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#development-testing-__codelineno-8-1"></a><span class="nn">---</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#development-testing-__codelineno-8-2"></a><span class="nt">driver</span><span class="p">:</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#development-testing-__codelineno-8-3"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">podman</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#development-testing-__codelineno-8-4"></a><span class="nt">platforms</span><span class="p">:</span><span class="w"> </span><span class="c1"># (1)!</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#development-testing-__codelineno-8-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance1</span><span class="w"> </span><span class="c1"># (2)!</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#development-testing-__codelineno-8-6"></a><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="c1"># (3)!</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#development-testing-__codelineno-8-7"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">molecule</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#development-testing-__codelineno-8-8"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rocky</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#development-testing-__codelineno-8-9"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker.io/timgrt/rockylinux9-ansible:latest</span><span class="w"> </span><span class="c1"># (4)!</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#development-testing-__codelineno-8-10"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#development-testing-__codelineno-8-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/fs/cgroup:/sys/fs/cgroup:ro</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#development-testing-__codelineno-8-12"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/usr/sbin/init&quot;</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#development-testing-__codelineno-8-13"></a><span class="w">    </span><span class="nt">pre_build_image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># (5)!</span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#development-testing-__codelineno-8-14"></a><span class="w">    </span><span class="nt">exposed_ports</span><span class="p">:</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#development-testing-__codelineno-8-15"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80/tcp</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#development-testing-__codelineno-8-16"></a><span class="w">    </span><span class="nt">published_ports</span><span class="p">:</span><span class="w"> </span><span class="c1"># (6)!</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#development-testing-__codelineno-8-17"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080:80/tcp</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#development-testing-__codelineno-8-18"></a><span class="nt">provisioner</span><span class="p">:</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#development-testing-__codelineno-8-19"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#development-testing-__codelineno-8-20"></a><span class="w">  </span><span class="nt">options</span><span class="p">:</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#development-testing-__codelineno-8-21"></a><span class="w">    </span><span class="nt">D</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># (7)!</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#development-testing-__codelineno-8-22"></a><span class="w">  </span><span class="nt">connection_options</span><span class="p">:</span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#development-testing-__codelineno-8-23"></a><span class="w">    </span><span class="nt">ansible_user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible</span><span class="w"> </span><span class="c1"># (8)!</span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#development-testing-__codelineno-8-24"></a><span class="w">  </span><span class="nt">config_options</span><span class="p">:</span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#development-testing-__codelineno-8-25"></a><span class="w">    </span><span class="nt">defaults</span><span class="p">:</span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#development-testing-__codelineno-8-26"></a><span class="w">      </span><span class="nt">interpreter_python</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">auto_silent</span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#development-testing-__codelineno-8-27"></a><span class="w">      </span><span class="nt">callback_whitelist</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">profile_tasks, timer, yaml</span><span class="w"> </span><span class="c1"># (9)!</span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#development-testing-__codelineno-8-28"></a><span class="w">  </span><span class="nt">inventory</span><span class="p">:</span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#development-testing-__codelineno-8-29"></a><span class="w">    </span><span class="nt">links</span><span class="p">:</span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#development-testing-__codelineno-8-30"></a><span class="w">      </span><span class="nt">group_vars</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">../../../../inventory/group_vars/</span><span class="w"> </span><span class="c1"># (10)!</span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#development-testing-__codelineno-8-31"></a><span class="nt">scenario</span><span class="p">:</span><span class="w"> </span><span class="c1"># (11)!</span>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#development-testing-__codelineno-8-32"></a><span class="w">  </span><span class="nt">create_sequence</span><span class="p">:</span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#development-testing-__codelineno-8-33"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create</span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#development-testing-__codelineno-8-34"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prepare</span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#development-testing-__codelineno-8-35"></a><span class="w">  </span><span class="nt">converge_sequence</span><span class="p">:</span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#development-testing-__codelineno-8-36"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create</span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#development-testing-__codelineno-8-37"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prepare</span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#development-testing-__codelineno-8-38"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">converge</span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#development-testing-__codelineno-8-39"></a><span class="w">  </span><span class="nt">test_sequence</span><span class="p">:</span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#development-testing-__codelineno-8-40"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">destroy</span>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#development-testing-__codelineno-8-41"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create</span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#development-testing-__codelineno-8-42"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">converge</span>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#development-testing-__codelineno-8-43"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">idempotence</span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#development-testing-__codelineno-8-44"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">destroy</span>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#development-testing-__codelineno-8-45"></a><span class="w">  </span><span class="nt">destroy_sequence</span><span class="p">:</span>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#development-testing-__codelineno-8-46"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">destroy</span>
</code></pre></div>
<ol>
<li>List of hosts to provision by <em>molecule</em>, copy the list item and use a unique name if you want to deploy multiple containers. In the following example one Container with Rocky Linux 8 and one Ubuntu 20.04 container are provisioned.
    <div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#development-testing-__codelineno-9-1"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rocky8-instance1</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#development-testing-__codelineno-9-2"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker.io/timgrt/rockylinux9-ansible:latest</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#development-testing-__codelineno-9-3"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#development-testing-__codelineno-9-4"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/fs/cgroup:/sys/fs/cgroup:ro</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#development-testing-__codelineno-9-5"></a><span class="w">    </span><span class="nt">tmpfs</span><span class="p">:</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#development-testing-__codelineno-9-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/run</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#development-testing-__codelineno-9-7"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#development-testing-__codelineno-9-8"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/usr/sbin/init&quot;</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#development-testing-__codelineno-9-9"></a><span class="w">    </span><span class="nt">pre_build_image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#development-testing-__codelineno-9-10"></a><span class="w">    </span><span class="nt">groups</span><span class="p">:</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#development-testing-__codelineno-9-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">molecule</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#development-testing-__codelineno-9-12"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rocky</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#development-testing-__codelineno-9-13"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu2004</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#development-testing-__codelineno-9-14"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker.io/timgrt/ubuntu2004-ansible:latest</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#development-testing-__codelineno-9-15"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#development-testing-__codelineno-9-16"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/fs/cgroup:/sys/fs/cgroup:ro</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#development-testing-__codelineno-9-17"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/lib/systemd/systemd&quot;</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#development-testing-__codelineno-9-18"></a><span class="w">    </span><span class="nt">pre_build_image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#development-testing-__codelineno-9-19"></a><span class="w">    </span><span class="nt">groups</span><span class="p">:</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#development-testing-__codelineno-9-20"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">molecule</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#development-testing-__codelineno-9-21"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
</code></pre></div></li>
<li>The <em>name</em> of your container, for better identification you could use e.g. <code>demo.${USER}.molecule</code> which uses your username from environment variable    substitution, showing who deployed the container for what purpose.</li>
<li>Additional <em>groups</em> the host should be part of, using a custom <code>molecule</code> group for referencing in <code>converge.yml</code>.<br />
If you want your container to inherit variables from <em>group_vars</em> (see <em>inventory.links.group_vars</em> in the <em>provisioner</em> section), add the group(s) to this list.</li>
<li>For more information regarding the used container image, see <a href="https://hub.docker.com/r/timgrt/rockylinux9-ansible" target="_blank">https://hub.docker.com/r/timgrt/rockylinux9-ansible</a>. The image provides a <em>systemd-enabled</em> environment, this ensures you can install and start services with <em>systemctl</em> as in any normal VM.<br />
Some more useful images are:<ul>
<li><a href="https://hub.docker.com/r/timgrt/rockylinux8-ansible" target="_blank">Rocky Linux 8</a></li>
<li><a href="https://hub.docker.com/r/timgrt/fedora37-ansible" target="_blank">Fedora 39</a></li>
<li><a href="https://hub.docker.com/r/timgrt/ubuntu2004-ansible" target="_blank">Ubuntu 20.04</a></li>
<li><a href="https://hub.docker.com/r/timgrt/debian10-ansible" target="_blank">Debian 10</a></li>
<li><a href="https://hub.docker.com/r/timgrt/opensuse15-ansible" target="_blank">OpenSuse 15</a></li>
</ul>
</li>
<li>Container image must be present before running Molecule, pull it with <code>podman pull docker.io/timgrt/rockylinux9-ansible:latest</code></li>
<li>When running a webserver inside the container (on port 80), this will publish the container port 80 to the host port 8080. Now, you can check the webserver content by using <code>http://localhost:8080</code> (or use the IP of your host).</li>
<li>Enables <em>diff</em> mode, set to <code>false</code> if you don't want that.</li>
<li>Uses the <em>ansible</em> user to connect to the container (defined in the container image), this way you can test with <code>become</code>. Otherwise you would connect with the <em>root</em> user, most likely this is not what you would do in production.</li>
<li>Adds a timer to every task and the overall playbook run, as well as formatting the Ansible output to YAML for better readability.<br />
Install necessary collections with <code>ansible-galaxy collection install ansible.posix community.general</code>.</li>
<li>If you want your container to inherit variables from <em>group_vars</em>, reference the location of your <em>group_vars</em> (here they are stored in the subfolder <em>inventory</em> of the project, searching begins in the scenario folder <em>defaults</em>). Delete the <em>inventory</em> key and all content if you don't need this.</li>
<li>A scenario allows Molecule to test a role in a particular way, these are the stages when executing Molecule.<br />
For example, running <code>molecule converge</code> would create a container (if not already created), prepare it (if not already prepared) and run the <em>converge</em> stage/playbook.  </li>
</ol>
</div>
</div>
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">converge.yml</p>
<p>The <em>role</em> to test must be defined here, change <code>role-name</code> to the actual name.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#development-testing-__codelineno-10-1"></a><span class="nn">---</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#development-testing-__codelineno-10-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Converge</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#development-testing-__codelineno-10-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">molecule</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#development-testing-__codelineno-10-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#development-testing-__codelineno-10-5"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#development-testing-__codelineno-10-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">role-name</span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">prepare.yml</p>
<p>Adds an <strong>optional</strong> preparation stage (referenced by <code>prepare</code> in the <em>scenario</em> definition).<br />
For example, if you want to test SSH Key-Pair creation in your container (this is also used by the <em>user</em> module to create SSH keys), install the necessary packages before running the role itself.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#development-testing-__codelineno-11-1"></a><span class="nn">---</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#development-testing-__codelineno-11-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prepare</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#development-testing-__codelineno-11-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">molecule</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#development-testing-__codelineno-11-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#development-testing-__codelineno-11-5"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#development-testing-__codelineno-11-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install OpenSSH for ssh-keygen</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#development-testing-__codelineno-11-7"></a><span class="w">      </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#development-testing-__codelineno-11-8"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openssh</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#development-testing-__codelineno-11-9"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div>
<p>Remember, you are using a Container image, not every package from the distribution is installed by default to minimize the image size.</p>
</div>
</div>
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">verify.yml</p>
<p>Adds an <strong>optional</strong> verification stage (referenced by <code>verify</code> in the <em>scenario</em> definition). <strong>Not used in the example above.</strong></p>
<p>Add this block to your <code>molecule.yml</code> as a top-level key:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#development-testing-__codelineno-12-1"></a><span class="nt">verifier</span><span class="p">:</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#development-testing-__codelineno-12-2"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible</span>
</code></pre></div>
<p>The <code>verify.yml</code> contains your tests for your role.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#development-testing-__codelineno-13-1"></a><span class="nn">---</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#development-testing-__codelineno-13-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Verify</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#development-testing-__codelineno-13-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">molecule</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#development-testing-__codelineno-13-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#development-testing-__codelineno-13-5"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#development-testing-__codelineno-13-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Get service facts</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#development-testing-__codelineno-13-7"></a><span class="w">      </span><span class="nt">ansible.builtin.service_facts</span><span class="p">:</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#development-testing-__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#development-testing-__codelineno-13-9"></a><span class="w">    </span><span class="c1"># Service may have started, returning &#39;OK&#39; in the service module, but may have failed later.</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#development-testing-__codelineno-13-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ensure that MariaDB is in running state</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#development-testing-__codelineno-13-11"></a><span class="w">      </span><span class="nt">assert</span><span class="p">:</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#development-testing-__codelineno-13-12"></a><span class="w">        </span><span class="nt">that</span><span class="p">:</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#development-testing-__codelineno-13-13"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible_facts[&#39;services&#39;][&#39;mariadb.service&#39;][&#39;state&#39;] == &#39;running&#39;</span>
</code></pre></div>
<p>Other <em>verifiers</em> like <em>testinfra</em> can be used.</p>
</div>
</div>
</div>
</div>
<h3 id="development-testing-usage">Usage</h3>
<p>Molecule is executed from within the role you want to test, change directory:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#development-testing-__codelineno-14-1"></a><span class="go">cd roles/webserver-demo</span>
</code></pre></div>
<p>From here, run the molecule scenario, after activating your Python <abbr title="Virtual Environment">VE</abbr> with molecule:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#development-testing-__codelineno-15-1"></a><span class="go">source molecule-venv/bin/activate</span>
</code></pre></div>
<p>To only create the defined containers, but not run the Ansible tasks:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#development-testing-__codelineno-16-1"></a><span class="go">molecule create</span>
</code></pre></div>
<p>To run the Ansible tasks of the role (if the container does not exist, it will be created):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#development-testing-__codelineno-17-1"></a><span class="go">molecule converge</span>
</code></pre></div>
<p>To execute a full test circle (existing containers are deleted, re-created and Ansible tasks are executed, containers are deleted(!) afterwards):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#development-testing-__codelineno-18-1"></a><span class="go">molecule test</span>
</code></pre></div>
<p>If you want to login to a running container instance:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#development-testing-__codelineno-19-1"></a><span class="go">molecule login</span>
</code></pre></div>
<!-- markdownlint-disable --></section><section class="print-page" id="development-extending"><h1 id="development-extending-extending-ansible">Extending Ansible</h1>
<p>Ansible is easily customizable, you can extend Ansible by adding custom modules or plugins.<br />
You might wonder whether you need a module or a plugin. Ansible modules are units of code that can control system resources or execute system commands. Ansible provides a module library that you can execute directly on remote hosts or through playbooks.<br />
Similar to modules are plugins, which are pieces of code that extend core Ansible functionality. Ansible uses a plugin architecture to enable a rich, flexible, and expandable feature set. It ships with several plugins and lets you easily use your own plugins.</p>
<h2 id="development-extending-store-custom-content">Store custom content</h2>
<p>Custom modules can be stored in the <code>library</code> folder in your project root directory, plugins need to be stored in folders called <code>&lt;plugin type&gt;_plugins</code>, e.g. <code>filter_plugins</code>. These locations are still valid, but it is <strong>recommended</strong> to store custom content in a <em>collection</em>, this way you have all your custom content in a single location (folder).</p>
<p>You can store custom collections with your Ansible project, create it with the <em>ansible-galaxy</em> utility and provide the <code>--init-path</code> parameter. The folder <code>collections/ansible_collections</code> will automatically be picked up by Ansible (although your custom collection is not shown by the <code>ansible-galaxy collection list</code> command, adjust the <code>ansible.cfg</code> for that, take a look into the next subsection).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#development-extending-__codelineno-0-1"></a><span class="go">ansible-galaxy collection init computacenter.utils --init-path collections/ansible_collections</span>
</code></pre></div>
<p>This creates the following structure:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#development-extending-__codelineno-1-1"></a><span class="go">collections/</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#development-extending-__codelineno-1-2"></a><span class="go">└── ansible_collections</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#development-extending-__codelineno-1-3"></a><span class="go">    └── computacenter</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#development-extending-__codelineno-1-4"></a><span class="go">        └── utils</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#development-extending-__codelineno-1-5"></a><span class="go">            ├── README.md</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#development-extending-__codelineno-1-6"></a><span class="go">            ├── docs</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#development-extending-__codelineno-1-7"></a><span class="go">            ├── galaxy.yml</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#development-extending-__codelineno-1-8"></a><span class="go">            ├── plugins</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#development-extending-__codelineno-1-9"></a><span class="go">            │   └── README.md</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#development-extending-__codelineno-1-10"></a><span class="go">            └── roles</span>
</code></pre></div>
<p>Create subfolder beneath the <code>plugins</code> folder, <code>modules</code> for modules and e.g. <code>filter</code> for filter plugins. Take a look into the included <code>README.md</code> in the <em>plugins</em> folder. Store your custom content in python files in the respective folders.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Only underscores (<code>_</code>) are allowed for filenames inside collections!<br />
Naming a file <code>cc-filter-plugins.py</code> will result in an error!</p>
</div>
<h3 id="development-extending-listing-custom-collections">Listing (custom) collections</h3>
<p>When storing custom collections alongside your project and you want to list all collections, you need to adjust your Ansible configuration. You will be able to use your custom collection nevertheless, this is more a quality of life change.</p>
<p>Adjust the <code>collections_paths</code> parameter in the <code>defaults</code> section of your <code>ansible.cfg</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#development-extending-__codelineno-2-1"></a><span class="k">[defaults]</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#development-extending-__codelineno-2-2"></a><span class="na">collections_paths</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">~/.ansible/collections:/usr/share/ansible/collections:./collections</span>
</code></pre></div>
<p>The first two paths are the default locations for collections, paths are separated with colons.</p>
<details class="example">
<summary>Listing collections</summary>
<p>Using a custom collection in the project folder <code>test</code> with adjusted configuration file.
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#development-extending-__codelineno-3-1"></a><span class="gp">$ </span>ansible-galaxy<span class="w"> </span>collection<span class="w"> </span>list
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#development-extending-__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#development-extending-__codelineno-3-3"></a><span class="gp"># </span>/home/tgruetz/.ansible/collections/ansible_collections
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#development-extending-__codelineno-3-4"></a><span class="go">Collection        Version</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#development-extending-__codelineno-3-5"></a><span class="go">----------------- -------</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#development-extending-__codelineno-3-6"></a><span class="go">ansible.netcommon 4.1.0  </span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#development-extending-__codelineno-3-7"></a><span class="go">ansible.posix     1.4.0  </span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#development-extending-__codelineno-3-8"></a><span class="go">ansible.utils     2.8.0  </span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#development-extending-__codelineno-3-9"></a><span class="go">cisco.aci         2.3.0  </span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#development-extending-__codelineno-3-10"></a><span class="go">cisco.ios         4.2.0  </span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#development-extending-__codelineno-3-11"></a><span class="go">community.docker  3.3.2  </span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#development-extending-__codelineno-3-12"></a><span class="go">community.general 6.1.0  </span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#development-extending-__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#development-extending-__codelineno-3-14"></a><span class="gp"># </span>/home/tgruetz/test/collections/ansible_collections
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#development-extending-__codelineno-3-15"></a><span class="go">Collection          Version</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#development-extending-__codelineno-3-16"></a><span class="go">------------------- -------</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#development-extending-__codelineno-3-17"></a><span class="go">computacenter.utils 1.0.0</span>
</code></pre></div></p>
</details>
<h2 id="development-extending-custom-facts">Custom facts</h2>
<p>The <code>setup</code> module in Ansible automatically discovers a standard set of facts about each host. If you want to add custom values to your facts, you can provide permanent custom facts using the <code>facts.d</code> directory or even write a custom facts module.</p>
<h3 id="development-extending-static-facts">Static facts</h3>
<p>The easiest method is to add an <code>.ini</code> file to <code>/etc/ansible/facts.d</code> on the remote host, e.g.</p>
<div class="highlight"><span class="filename">/etc/ansible/facts.d/general.fact</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#development-extending-__codelineno-4-1"></a><span class="k">[owner]</span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#development-extending-__codelineno-4-2"></a><span class="na">name</span><span class="o">=</span><span class="s">Computacenter AG</span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#development-extending-__codelineno-4-3"></a><span class="na">community</span><span class="o">=</span><span class="s">Ansible Community</span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#development-extending-__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#development-extending-__codelineno-4-5"></a><span class="k">[environment]</span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#development-extending-__codelineno-4-6"></a><span class="na">stage</span><span class="o">=</span><span class="s">production</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Ensure the file has the <code>.fact</code> extension and is <strong>not</strong> executable, this will break the <code>ansible.builtin.setup</code> module!</p>
</div>
<p>For example, running an ad-hoc command against an example host with the custom fact:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#development-extending-__codelineno-5-1"></a><span class="gp">$ </span>ansible<span class="w"> </span>-i<span class="w"> </span>inventory<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-m<span class="w"> </span>ansible.builtin.setup<span class="w"> </span>-a<span class="w"> </span><span class="nv">filter</span><span class="o">=</span>ansible_local
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#development-extending-__codelineno-5-2"></a><span class="go">ubuntu | SUCCESS =&gt; {</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#development-extending-__codelineno-5-3"></a><span class="go">     &quot;ansible_facts&quot;: {</span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#development-extending-__codelineno-5-4"></a><span class="go">        &quot;ansible_local&quot;: {</span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#development-extending-__codelineno-5-5"></a><span class="go">            &quot;general&quot;: {</span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#development-extending-__codelineno-5-6"></a><span class="go">                &quot;environment&quot;: {</span>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#development-extending-__codelineno-5-7"></a><span class="go">                    &quot;stage&quot;: &quot;production&quot;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#development-extending-__codelineno-5-8"></a><span class="go">                },</span>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#development-extending-__codelineno-5-9"></a><span class="go">                &quot;owner&quot;: {</span>
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#development-extending-__codelineno-5-10"></a><span class="go">                    &quot;community&quot;: &quot;Ansible Community&quot;,</span>
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#development-extending-__codelineno-5-11"></a><span class="go">                    &quot;name&quot;: &quot;Computacenter AG&quot;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#development-extending-__codelineno-5-12"></a><span class="go">                }</span>
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#development-extending-__codelineno-5-13"></a><span class="go">            }</span>
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#development-extending-__codelineno-5-14"></a><span class="go">        },</span>
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#development-extending-__codelineno-5-15"></a><span class="go">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python3&quot;</span>
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#development-extending-__codelineno-5-16"></a><span class="go">    },</span>
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#development-extending-__codelineno-5-17"></a><span class="go">    &quot;changed&quot;: false</span>
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#development-extending-__codelineno-5-18"></a><span class="go">}</span>
</code></pre></div>
<p>The parent key for the custom fact is the name of the file, the lower keys are the section names of the <em>ini</em> file.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>The key in <code>ansible_facts</code> for custom content is always <code>ansible_local</code>, this has nothing to do with running locally.</p>
</div>
<h3 id="development-extending-dynamic-facts">Dynamic facts</h3>
<p>You can also use <code>facts.d</code> to execute a script on the remote host, generating dynamic custom facts to the <em>ansible_local</em> namespace. Consider the following points when creating dynamic custom facts:</p>
<ul>
<li>must return JSON data</li>
<li>must have the <code>.fact</code> extension (add the correct Shebang!)</li>
<li>is executable by the Ansible connection user</li>
<li>dependencies must be installed on the remote host</li>
</ul>
<p>For example, a custom fact returning information about running or exited Docker containers on the remote host can look like this:</p>
<div class="highlight"><span class="filename">/etc/ansible/facts.d/docker-containers.fact</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#development-extending-__codelineno-6-1"></a><span class="ch">#!/usr/bin/env python3</span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#development-extending-__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#development-extending-__codelineno-6-3"></a><span class="c1"># DEPENDENCY: requires Python module &#39;docker&#39;, install e.g. with &#39;pip3 install docker&#39; or install &#39;python3-docker&#39; rpm with package manager</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#development-extending-__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#development-extending-__codelineno-6-5"></a><span class="kn">import</span> <span class="nn">json</span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#development-extending-__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#development-extending-__codelineno-6-7"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#development-extending-__codelineno-6-8"></a>    <span class="kn">import</span> <span class="nn">docker</span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#development-extending-__codelineno-6-9"></a><span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#development-extending-__codelineno-6-10"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Python docker module not found! Install requirements!&quot;</span><span class="p">}))</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#development-extending-__codelineno-6-11"></a>    <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">()</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#development-extending-__codelineno-6-12"></a>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#development-extending-__codelineno-6-13"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#development-extending-__codelineno-6-14"></a>    <span class="n">client</span> <span class="o">=</span> <span class="n">docker</span><span class="o">.</span><span class="n">from_env</span><span class="p">()</span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#development-extending-__codelineno-6-15"></a><span class="k">except</span> <span class="n">docker</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">DockerException</span><span class="p">:</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#development-extending-__codelineno-6-16"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Docker Client not instantiated! Is Docker running?&quot;</span><span class="p">}))</span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#development-extending-__codelineno-6-17"></a>    <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">()</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#development-extending-__codelineno-6-18"></a>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#development-extending-__codelineno-6-19"></a><span class="k">def</span> <span class="nf">exited_containers</span><span class="p">():</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#development-extending-__codelineno-6-20"></a>    <span class="n">exited_containers</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#development-extending-__codelineno-6-21"></a>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#development-extending-__codelineno-6-22"></a>    <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;exited&quot;</span><span class="p">}):</span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#development-extending-__codelineno-6-23"></a>        <span class="n">exited_containers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">container</span><span class="o">.</span><span class="n">short_id</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">container</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#development-extending-__codelineno-6-24"></a>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#development-extending-__codelineno-6-25"></a>    <span class="k">return</span> <span class="n">exited_containers</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#development-extending-__codelineno-6-26"></a>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#development-extending-__codelineno-6-27"></a><span class="k">def</span> <span class="nf">running_containers</span><span class="p">():</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#development-extending-__codelineno-6-28"></a>    <span class="n">running_containers</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#development-extending-__codelineno-6-29"></a>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#development-extending-__codelineno-6-30"></a>    <span class="k">for</span> <span class="n">container</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">containers</span><span class="o">.</span><span class="n">list</span><span class="p">():</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#development-extending-__codelineno-6-31"></a>        <span class="n">running_containers</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">container</span><span class="o">.</span><span class="n">short_id</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">container</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span> <span class="n">container</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#development-extending-__codelineno-6-32"></a>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#development-extending-__codelineno-6-33"></a>    <span class="k">return</span> <span class="n">running_containers</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#development-extending-__codelineno-6-34"></a>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#development-extending-__codelineno-6-35"></a>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#development-extending-__codelineno-6-36"></a><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#development-extending-__codelineno-6-37"></a>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#development-extending-__codelineno-6-38"></a>    <span class="n">container_facts</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="n">running_containers</span><span class="p">(),</span> <span class="s2">&quot;exited&quot;</span><span class="p">:</span> <span class="n">exited_containers</span><span class="p">()}</span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#development-extending-__codelineno-6-39"></a>    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">container_facts</span><span class="p">))</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#development-extending-__codelineno-6-40"></a>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#development-extending-__codelineno-6-41"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#development-extending-__codelineno-6-42"></a>   <span class="n">main</span><span class="p">()</span>
</code></pre></div>
<p>The custom fact returns a JSON dictionary with two lists, <code>running</code> and <code>exited</code>. Every list item has the Container ID, name and image.</p>
<details class="warning">
<summary>Warning</summary>
<p>Using the fact requires the Python docker module (mind the <code>import docker</code> statement) and the Docker service running on the target node.<br />
Otherwise, an error message is returned, e.g.:</p>
<p><div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#development-extending-__codelineno-7-1"></a><span class="go">&quot;ansible_local&quot;: {</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#development-extending-__codelineno-7-2"></a><span class="go">        &quot;docker-containers&quot;: {</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#development-extending-__codelineno-7-3"></a><span class="go">            &quot;error&quot;: &quot;Python docker module not found! Install requirements!&quot;</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#development-extending-__codelineno-7-4"></a><span class="go">        }</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#development-extending-__codelineno-7-5"></a><span class="go">    }</span>
</code></pre></div>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#development-extending-__codelineno-8-1"></a><span class="go">&quot;ansible_local&quot;: {</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#development-extending-__codelineno-8-2"></a><span class="go">        &quot;docker-containers&quot;: {</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#development-extending-__codelineno-8-3"></a><span class="go">            &quot;error&quot;: &quot;Docker Client not instantiated! Is Docker running?&quot;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#development-extending-__codelineno-8-4"></a><span class="go">        }</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#development-extending-__codelineno-8-5"></a><span class="go">    }</span>
</code></pre></div></p>
</details>
<p>Executing fact gathering for example returns this:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#development-extending-__codelineno-9-1"></a><span class="gp">$ </span>ansible<span class="w"> </span>-i<span class="w"> </span>inventory<span class="w"> </span><span class="nb">test</span><span class="w"> </span>-m<span class="w"> </span>setup<span class="w"> </span>-a<span class="w"> </span><span class="nv">filter</span><span class="o">=</span>ansible_local
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#development-extending-__codelineno-9-2"></a><span class="go">ubuntu | SUCCESS =&gt; {</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#development-extending-__codelineno-9-3"></a><span class="go">    &quot;ansible_facts&quot;: {</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#development-extending-__codelineno-9-4"></a><span class="go">        &quot;ansible_local&quot;: {</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#development-extending-__codelineno-9-5"></a><span class="go">            &quot;docker-containers&quot;: {</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#development-extending-__codelineno-9-6"></a><span class="go">                &quot;exited&quot;: [</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#development-extending-__codelineno-9-7"></a><span class="go">                    {</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#development-extending-__codelineno-9-8"></a><span class="go">                        &quot;id&quot;: &quot;a6bfc512b842&quot;,</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#development-extending-__codelineno-9-9"></a><span class="go">                        &quot;image&quot;: &quot;timgrt/rockylinux8-ansible:latest&quot;,</span>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#development-extending-__codelineno-9-10"></a><span class="go">                        &quot;name&quot;: &quot;rocky-linux&quot;</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#development-extending-__codelineno-9-11"></a><span class="go">                    }</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#development-extending-__codelineno-9-12"></a><span class="go">                ],</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#development-extending-__codelineno-9-13"></a><span class="go">                &quot;running&quot;: [</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#development-extending-__codelineno-9-14"></a><span class="go">                    {</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#development-extending-__codelineno-9-15"></a><span class="go">                        &quot;id&quot;: &quot;f3731d560625&quot;,</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#development-extending-__codelineno-9-16"></a><span class="go">                        &quot;image&quot;: &quot;local/timgrt/ansible-best-practices:latest&quot;,</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#development-extending-__codelineno-9-17"></a><span class="go">                        &quot;name&quot;: &quot;ansible-best-practices&quot;</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#development-extending-__codelineno-9-18"></a><span class="go">                    }</span>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#development-extending-__codelineno-9-19"></a><span class="go">                ]</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#development-extending-__codelineno-9-20"></a><span class="go">            }</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#development-extending-__codelineno-9-21"></a><span class="go">        },</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#development-extending-__codelineno-9-22"></a><span class="go">        &quot;discovered_interpreter_python&quot;: &quot;/usr/bin/python3&quot;</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#development-extending-__codelineno-9-23"></a><span class="go">    },</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#development-extending-__codelineno-9-24"></a><span class="go">    &quot;changed&quot;: false</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#development-extending-__codelineno-9-25"></a><span class="go">}</span>
</code></pre></div>
<p>In the example, we have one running container and one stopped container.</p>
<details class="example">
<summary>Additional info</summary>
<p>Running <code>docker ps</code> on the target host
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#development-extending-__codelineno-10-1"></a><span class="gp">$ </span>docker<span class="w"> </span>ps<span class="w"> </span>-a
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#development-extending-__codelineno-10-2"></a><span class="go">CONTAINER ID   IMAGE                                 COMMAND                  CREATED             STATUS                           PORTS                  NAMES</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#development-extending-__codelineno-10-3"></a><span class="go">a6bfc512b842   timgrt/rockylinux8-ansible:latest     &quot;/usr/lib/systemd/sy…&quot;   About an hour ago   Exited (137) About an hour ago                          rocky-linux</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#development-extending-__codelineno-10-4"></a><span class="go">f3731d560625   local/timgrt/ansible-best-practices   &quot;/bin/sh -c &#39;python …&quot;   4 hours ago         Up 4 hours                       0.0.0.0:8080-&gt;80/tcp   ansible-best-practices</span>
</code></pre></div>
Executing the script standalone (using a JSON module for better readability):
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#development-extending-__codelineno-11-1"></a><span class="gp">$ </span>/etc/ansible/facts.d/docker-containers.fact<span class="w"> </span><span class="p">|</span><span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>json.tool
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#development-extending-__codelineno-11-2"></a><span class="go">{</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#development-extending-__codelineno-11-3"></a><span class="go">    &quot;running&quot;: [</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#development-extending-__codelineno-11-4"></a><span class="go">        {</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#development-extending-__codelineno-11-5"></a><span class="go">            &quot;id&quot;: &quot;f3731d560625&quot;,</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#development-extending-__codelineno-11-6"></a><span class="go">            &quot;name&quot;: &quot;ansible-best-practices&quot;,</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#development-extending-__codelineno-11-7"></a><span class="go">            &quot;image&quot;: &quot;local/timgrt/ansible-best-practices:latest&quot;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#development-extending-__codelineno-11-8"></a><span class="go">        }</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#development-extending-__codelineno-11-9"></a><span class="go">    ],</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#development-extending-__codelineno-11-10"></a><span class="go">    &quot;exited&quot;: [</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#development-extending-__codelineno-11-11"></a><span class="go">        {</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#development-extending-__codelineno-11-12"></a><span class="go">            &quot;id&quot;: &quot;a6bfc512b842&quot;,</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#development-extending-__codelineno-11-13"></a><span class="go">            &quot;name&quot;: &quot;rocky-linux&quot;,</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#development-extending-__codelineno-11-14"></a><span class="go">            &quot;image&quot;: &quot;timgrt/rockylinux8-ansible:latest&quot;</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#development-extending-__codelineno-11-15"></a><span class="go">        }</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#development-extending-__codelineno-11-16"></a><span class="go">    ]</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#development-extending-__codelineno-11-17"></a><span class="go">}</span>
</code></pre></div></p>
</details>
<h2 id="development-extending-developing-modules">Developing modules</h2>
<p>Modules are reusable, standalone scripts that can be used by the Ansible API, the <em>ansible</em> command, or the <em>ansible-playbook</em> command.   Modules provide a defined interface. Each module accepts arguments and returns information to Ansible by printing a JSON string to stdout before exiting. <strong>Modules execute on the target system (usually that means on a remote system) in separate processes.</strong> Modules are technically plugins, but for historical reasons we do not usually talk about “module plugins”.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Work in Progress</strong> - More description necessary.</p>
</div>
<h2 id="development-extending-developing-plugins">Developing plugins</h2>
<p>Plugins extend Ansible’s core functionality and <strong>execute on the control node within the /usr/bin/ansible process.</strong> Plugins offer options and extensions for the core features of Ansible e.g. transforming data, logging output, connecting to inventory, and more. Take a look into the <a href="https://docs.ansible.com/ansible/latest/dev_guide/developing_plugins.html" target="_blank"><em>Ansible Developer Documentation</em></a> for an overview of the different plugin types.</p>
<p>All plugins must</p>
<ul>
<li>be written in Python (<a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html#control-node-requirements" target="_blank"><em>in a compatible version of Python</em></a>)</li>
<li>raise errors (<a href="https://docs.ansible.com/ansible/latest/dev_guide/developing_plugins.html#raising-errors" target="_blank"><em>when things go wrong</em></a>)</li>
<li>return strings in unicode (<a href="https://docs.ansible.com/ansible/latest/dev_guide/developing_plugins.html#string-encoding" target="_blank"><em>to run through Jinja2</em></a>)</li>
<li>conform to Ansible’s configuration and documentation standards (<a href="https://docs.ansible.com/ansible/latest/dev_guide/developing_plugins.html#plugin-configuration-documentation-standards" target="_blank"><em>how to use your plugin</em></a>)</li>
</ul>
<p>Depending on the type of plugin you want to create, different considerations need to be taken, the next subsections give a brief overview with a small example. Always use the latest Ansible documentation for additional information.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The usage of the <abbr title="Full Qualified Collection Name">FQCN</abbr> for your Plugin is mandatory!</p>
</div>
<h3 id="development-extending-filter-plugins">Filter plugins</h3>
<p><a href="https://docs.ansible.com/ansible/latest/dev_guide/developing_plugins.html#filter-plugins" target="_blank">Filter plugins</a> manipulate data. They are a feature of Jinja2 and are also available in Jinja2 templates used by the <em>template</em> module. As with all plugins, they can be easily extended, but instead of having a file for each one you can have several per file.</p>
<p>This file may be used as a minimal starting point, it includes a small example:</p>
<div class="admonition example">
<p class="admonition-title">cc_filter_plugins.py</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#development-extending-__codelineno-12-1"></a><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#development-extending-__codelineno-12-2"></a><span class="n">__metaclass__</span> <span class="o">=</span> <span class="nb">type</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#development-extending-__codelineno-12-3"></a>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#development-extending-__codelineno-12-4"></a><span class="kn">from</span> <span class="nn">ansible.errors</span> <span class="kn">import</span> <span class="n">AnsibleError</span><span class="c1"># (1)!</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#development-extending-__codelineno-12-5"></a><span class="kn">from</span> <span class="nn">ansible.module_utils.common.text.converters</span> <span class="kn">import</span> <span class="n">to_native</span><span class="c1"># (2)!</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#development-extending-__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#development-extending-__codelineno-12-7"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#development-extending-__codelineno-12-8"></a>    <span class="kn">import</span> <span class="nn">netaddr</span><span class="c1"># (3)!</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#development-extending-__codelineno-12-9"></a><span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">imp_exc</span><span class="p">:</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#development-extending-__codelineno-12-10"></a>    <span class="n">NETADDR_IMPORT_ERROR</span> <span class="o">=</span> <span class="n">imp_exc</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#development-extending-__codelineno-12-11"></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#development-extending-__codelineno-12-12"></a>    <span class="n">NETADDR_IMPORT_ERROR</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#development-extending-__codelineno-12-13"></a>
<a id="__codelineno-12-14" name="__codelineno-12-14" href="#development-extending-__codelineno-12-14"></a>
<a id="__codelineno-12-15" name="__codelineno-12-15" href="#development-extending-__codelineno-12-15"></a><span class="k">def</span> <span class="nf">sort_ip</span><span class="p">(</span><span class="n">unsorted_ip_list</span><span class="p">):</span><span class="c1"># (4)!</span>
<a id="__codelineno-12-16" name="__codelineno-12-16" href="#development-extending-__codelineno-12-16"></a>    <span class="c1"># Function sorts a given list of IP addresses</span>
<a id="__codelineno-12-17" name="__codelineno-12-17" href="#development-extending-__codelineno-12-17"></a>
<a id="__codelineno-12-18" name="__codelineno-12-18" href="#development-extending-__codelineno-12-18"></a>    <span class="k">if</span> <span class="n">NETADDR_IMPORT_ERROR</span><span class="p">:</span>
<a id="__codelineno-12-19" name="__codelineno-12-19" href="#development-extending-__codelineno-12-19"></a>        <span class="k">raise</span> <span class="n">AnsibleError</span><span class="p">(</span><span class="s1">&#39;netaddr library must be installed to use this plugin&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">NETADDR_IMPORT_ERROR</span>
<a id="__codelineno-12-20" name="__codelineno-12-20" href="#development-extending-__codelineno-12-20"></a>
<a id="__codelineno-12-21" name="__codelineno-12-21" href="#development-extending-__codelineno-12-21"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unsorted_ip_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span><span class="c1"># (5)!</span>
<a id="__codelineno-12-22" name="__codelineno-12-22" href="#development-extending-__codelineno-12-22"></a>        <span class="k">raise</span> <span class="n">AnsibleError</span><span class="p">(</span><span class="s2">&quot;Filter needs list input, got &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">unsorted_ip_list</span><span class="p">))</span>
<a id="__codelineno-12-23" name="__codelineno-12-23" href="#development-extending-__codelineno-12-23"></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-12-24" name="__codelineno-12-24" href="#development-extending-__codelineno-12-24"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-12-25" name="__codelineno-12-25" href="#development-extending-__codelineno-12-25"></a>            <span class="n">sorted_ip_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unsorted_ip_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">netaddr</span><span class="o">.</span><span class="n">IPAddress</span><span class="p">)</span><span class="c1"># (6)!</span>
<a id="__codelineno-12-26" name="__codelineno-12-26" href="#development-extending-__codelineno-12-26"></a>        <span class="k">except</span> <span class="n">netaddr</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">AddrFormatError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-12-27" name="__codelineno-12-27" href="#development-extending-__codelineno-12-27"></a>            <span class="k">raise</span> <span class="n">AnsibleError</span><span class="p">(</span><span class="s1">&#39;Error from netaddr library, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">to_native</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
<a id="__codelineno-12-28" name="__codelineno-12-28" href="#development-extending-__codelineno-12-28"></a>
<a id="__codelineno-12-29" name="__codelineno-12-29" href="#development-extending-__codelineno-12-29"></a>    <span class="k">return</span> <span class="n">sorted_ip_list</span><span class="c1"># (7)!</span>
<a id="__codelineno-12-30" name="__codelineno-12-30" href="#development-extending-__codelineno-12-30"></a>
<a id="__codelineno-12-31" name="__codelineno-12-31" href="#development-extending-__codelineno-12-31"></a>
<a id="__codelineno-12-32" name="__codelineno-12-32" href="#development-extending-__codelineno-12-32"></a><span class="k">class</span> <span class="nc">FilterModule</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> <span class="c1"># (8)!</span>
<a id="__codelineno-12-33" name="__codelineno-12-33" href="#development-extending-__codelineno-12-33"></a>
<a id="__codelineno-12-34" name="__codelineno-12-34" href="#development-extending-__codelineno-12-34"></a>    <span class="k">def</span> <span class="nf">filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-12-35" name="__codelineno-12-35" href="#development-extending-__codelineno-12-35"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-12-36" name="__codelineno-12-36" href="#development-extending-__codelineno-12-36"></a>            <span class="c1"># Sorting list of IP Addresses</span>
<a id="__codelineno-12-37" name="__codelineno-12-37" href="#development-extending-__codelineno-12-37"></a>            <span class="s1">&#39;sort_ip&#39;</span><span class="p">:</span> <span class="n">sort_ip</span> <span class="c1"># (9)!</span>
<a id="__codelineno-12-38" name="__codelineno-12-38" href="#development-extending-__codelineno-12-38"></a>        <span class="p">}</span>
</code></pre></div>
<ol>
<li>This is the most generic <a href="https://github.com/ansible/ansible/blob/devel/lib/ansible/errors/__init__.py" target="_blank">AnsibleError object</a>, depending on the specific plugin type you’re developing you may want to use different ones.</li>
<li>Use this to convert plugin output to convert output into Python’s unicode type (<em>to_text</em>) or for wrapping other exceptions into error messages (<em>to_native</em>).</li>
<li>This is a non-standard dependency, the user needs to install this beforehand (e.g. <code>pip3 install netaddr --user</code>), therefore surrounding it with <em>try-except</em>. <strong>Document necessary requirements!</strong></li>
<li>Example plugin definition, this sorts a given list of IP addresses ( Jinja2 <em>sort</em> filter does not work correctly with IPs), it expects a list.</li>
<li>Testing if input is a <em>list</em>, otherwise return an error message. Maybe another error type (e.g. <em>AnsibleFilterTypeError</em>) is more appropriate? What other exceptions need to be caught?</li>
<li>This line sorts the list with the <a href="https://docs.python.org/3/library/functions.html#sorted" target="_blank"><em>built-in Python sorted()</em></a> library, the key specifies the comparison key for each list element, it uses the <em>netaddr</em> library.</li>
<li>The function returns a sorted list of IPs.</li>
<li>Main class, this is called by Ansible's <em>PluginLoader</em>.</li>
<li>Mapping of filter name and definition, you may call your filter like this: <code>"{{ ip_list | sort_ip }}"</code> (this only works when stored in the project root in the folder <code>filter_plugins</code>, otherwise you need to use the <abbr title="Full Qualified Collection Name">FQCN</abbr>!). Filter name and definition do not need to have the same name.  Add more filter definitions by comma-separation.</li>
</ol>
</div>
<p>The Python file needs to be stored in a collection, e.g.:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#development-extending-__codelineno-13-1"></a><span class="go">collections/</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#development-extending-__codelineno-13-2"></a><span class="go">└── ansible_collections</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#development-extending-__codelineno-13-3"></a><span class="go">    └── computacenter</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#development-extending-__codelineno-13-4"></a><span class="go">        └── utils</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#development-extending-__codelineno-13-5"></a><span class="go">            ├── README.md</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#development-extending-__codelineno-13-6"></a><span class="go">            ├── docs</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#development-extending-__codelineno-13-7"></a><span class="go">            ├── galaxy.yml</span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#development-extending-__codelineno-13-8"></a><span class="go">            ├── plugins</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#development-extending-__codelineno-13-9"></a><span class="go">            │   ├── README.md</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#development-extending-__codelineno-13-10"></a><span class="go">            │   └── filter</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#development-extending-__codelineno-13-11"></a><span class="go">            │       └── cc_filter_plugins.py</span>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#development-extending-__codelineno-13-12"></a><span class="go">            └── roles</span>
</code></pre></div>
<p>Now, the filter can be used:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#development-extending-__codelineno-14-1"></a><span class="nt">sorted_ip_list</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">ip_list</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">computacenter.utils.sort_ip</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div>
<h3 id="development-extending-inventory-plugins">Inventory plugins</h3>
<p>Ansible can pull information from different sources, like ServiceNow, Cisco etc. If your source is not covered with the integrated inventory plugins, you can create your own.</p>
<p>For more information take a look at <a href="https://docs.ansible.com/ansible/latest/dev_guide/developing_inventory.html" target="_blank">Ansible docs - Developing inventory plugin</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Key things to note</p>
<ul>
<li>The DOCUMENTATION section is required and used by the plugin. Note how the options here reflect exactly the options we specified in the csv_inventory.yaml file in the previous step.</li>
<li>The NAME should exactly match the name of the plugin everywhere else.</li>
<li>For details on the imports and base classes/helpers take a look at the <a href="https://github.com/ansible/ansible/tree/devel/lib/ansible/inventory" target="_blank">python code in Github</a></li>
</ul>
</div>
<p>This file may be used as a minimal starting point, it includes a small example:</p>
<div class="admonition example">
<p class="admonition-title">cc_cisco_prime.py</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#development-extending-__codelineno-15-1"></a><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#development-extending-__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#development-extending-__codelineno-15-3"></a><span class="n">__metaclass__</span> <span class="o">=</span> <span class="nb">type</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#development-extending-__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#development-extending-__codelineno-15-5"></a><span class="c1"># (1)!</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#development-extending-__codelineno-15-6"></a><span class="n">DOCUMENTATION</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;&#39;&#39;</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#development-extending-__codelineno-15-7"></a><span class="s1">    name: cc_cisco_prime</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#development-extending-__codelineno-15-8"></a><span class="s1">    author:</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#development-extending-__codelineno-15-9"></a><span class="s1">    - Kevin Blase (@FlachDerPlatte)</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#development-extending-__codelineno-15-10"></a><span class="s1">    - Jonathan Schmidt (@SchmidtJonathan1)</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#development-extending-__codelineno-15-11"></a><span class="s1">    short_description: Inventory source for Cisco Prime API.</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#development-extending-__codelineno-15-12"></a><span class="s1">    description:</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#development-extending-__codelineno-15-13"></a><span class="s1">    - Builds inventory from Cisco Prime API.</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#development-extending-__codelineno-15-14"></a><span class="s1">    - Requires a configuration file ending in C(prime.yml) or C(prime.yaml).</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#development-extending-__codelineno-15-15"></a><span class="s1">        See the example section for more details.</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#development-extending-__codelineno-15-16"></a><span class="s1">    version_added: 1.0.0</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#development-extending-__codelineno-15-17"></a><span class="s1">    extends_documentation_fragment:</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#development-extending-__codelineno-15-18"></a><span class="s1">    - ansible.builtin.constructed</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#development-extending-__codelineno-15-19"></a><span class="s1">    notes:</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#development-extending-__codelineno-15-20"></a><span class="s1">    - Nothing</span>
<a id="__codelineno-15-21" name="__codelineno-15-21" href="#development-extending-__codelineno-15-21"></a><span class="s1">    options:</span>
<a id="__codelineno-15-22" name="__codelineno-15-22" href="#development-extending-__codelineno-15-22"></a><span class="s1">    plugin:</span>
<a id="__codelineno-15-23" name="__codelineno-15-23" href="#development-extending-__codelineno-15-23"></a><span class="s1">        description:</span>
<a id="__codelineno-15-24" name="__codelineno-15-24" href="#development-extending-__codelineno-15-24"></a><span class="s1">        - The name of the Cisco Prime API Inventory Plugin.</span>
<a id="__codelineno-15-25" name="__codelineno-15-25" href="#development-extending-__codelineno-15-25"></a><span class="s1">        - This should always be C(computacenter.utils.cc_cisco_prime).</span>
<a id="__codelineno-15-26" name="__codelineno-15-26" href="#development-extending-__codelineno-15-26"></a><span class="s1">        required: true</span>
<a id="__codelineno-15-27" name="__codelineno-15-27" href="#development-extending-__codelineno-15-27"></a><span class="s1">        type: str</span>
<a id="__codelineno-15-28" name="__codelineno-15-28" href="#development-extending-__codelineno-15-28"></a><span class="s1">        choices: [ computacenter.utils.cc_cisco_prime ]</span>
<a id="__codelineno-15-29" name="__codelineno-15-29" href="#development-extending-__codelineno-15-29"></a><span class="s1">&#39;&#39;&#39;</span>
<a id="__codelineno-15-30" name="__codelineno-15-30" href="#development-extending-__codelineno-15-30"></a>
<a id="__codelineno-15-31" name="__codelineno-15-31" href="#development-extending-__codelineno-15-31"></a><span class="c1"># (2)!</span>
<a id="__codelineno-15-32" name="__codelineno-15-32" href="#development-extending-__codelineno-15-32"></a><span class="n">EXAMPLES</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;&#39;&#39;</span>
<a id="__codelineno-15-33" name="__codelineno-15-33" href="#development-extending-__codelineno-15-33"></a><span class="s1">    # Inventory File in YAML format</span>
<a id="__codelineno-15-34" name="__codelineno-15-34" href="#development-extending-__codelineno-15-34"></a><span class="s1">    plugin: computacenter.utils.cc_cisco_prime</span>
<a id="__codelineno-15-35" name="__codelineno-15-35" href="#development-extending-__codelineno-15-35"></a><span class="s1">    api_user: user123</span>
<a id="__codelineno-15-36" name="__codelineno-15-36" href="#development-extending-__codelineno-15-36"></a><span class="s1">    api_pass: password123</span>
<a id="__codelineno-15-37" name="__codelineno-15-37" href="#development-extending-__codelineno-15-37"></a><span class="s1">    api_host_url: host.domain.tld</span>
<a id="__codelineno-15-38" name="__codelineno-15-38" href="#development-extending-__codelineno-15-38"></a><span class="s1">&#39;&#39;&#39;</span>
<a id="__codelineno-15-39" name="__codelineno-15-39" href="#development-extending-__codelineno-15-39"></a>
<a id="__codelineno-15-40" name="__codelineno-15-40" href="#development-extending-__codelineno-15-40"></a><span class="kn">import</span> <span class="nn">requests</span>
<a id="__codelineno-15-41" name="__codelineno-15-41" href="#development-extending-__codelineno-15-41"></a><span class="kn">from</span> <span class="nn">ansible.errors</span> <span class="kn">import</span> <span class="n">AnsibleParserError</span>
<a id="__codelineno-15-42" name="__codelineno-15-42" href="#development-extending-__codelineno-15-42"></a><span class="kn">from</span> <span class="nn">ansible.inventory.group</span> <span class="kn">import</span> <span class="n">to_safe_group_name</span>
<a id="__codelineno-15-43" name="__codelineno-15-43" href="#development-extending-__codelineno-15-43"></a><span class="kn">from</span> <span class="nn">ansible.plugins.inventory</span> <span class="kn">import</span> <span class="p">(</span>
<a id="__codelineno-15-44" name="__codelineno-15-44" href="#development-extending-__codelineno-15-44"></a>    <span class="n">BaseInventoryPlugin</span><span class="p">,</span>
<a id="__codelineno-15-45" name="__codelineno-15-45" href="#development-extending-__codelineno-15-45"></a>    <span class="n">Constructable</span><span class="p">,</span>
<a id="__codelineno-15-46" name="__codelineno-15-46" href="#development-extending-__codelineno-15-46"></a>    <span class="n">to_safe_group_name</span><span class="p">,</span>
<a id="__codelineno-15-47" name="__codelineno-15-47" href="#development-extending-__codelineno-15-47"></a><span class="p">)</span>
<a id="__codelineno-15-48" name="__codelineno-15-48" href="#development-extending-__codelineno-15-48"></a>
<a id="__codelineno-15-49" name="__codelineno-15-49" href="#development-extending-__codelineno-15-49"></a><span class="k">class</span> <span class="nc">InventoryModule</span><span class="p">(</span><span class="n">BaseInventoryPlugin</span><span class="p">,</span> <span class="n">Constructable</span><span class="p">):</span>
<a id="__codelineno-15-50" name="__codelineno-15-50" href="#development-extending-__codelineno-15-50"></a>
<a id="__codelineno-15-51" name="__codelineno-15-51" href="#development-extending-__codelineno-15-51"></a>    <span class="n">NAME</span> <span class="o">=</span> <span class="s1">&#39;computacenter.utils.cc_cisco_prime&#39;</span>  <span class="c1"># used internally by Ansible, it should match the file name but not required</span>
<a id="__codelineno-15-52" name="__codelineno-15-52" href="#development-extending-__codelineno-15-52"></a>
<a id="__codelineno-15-53" name="__codelineno-15-53" href="#development-extending-__codelineno-15-53"></a>    <span class="k">def</span> <span class="nf">verify_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span> <span class="c1"># (3)!</span>
<a id="__codelineno-15-54" name="__codelineno-15-54" href="#development-extending-__codelineno-15-54"></a>        <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-15-55" name="__codelineno-15-55" href="#development-extending-__codelineno-15-55"></a>        <span class="k">if</span> <span class="nb">super</span><span class="p">(</span><span class="n">InventoryModule</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">verify_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-15-56" name="__codelineno-15-56" href="#development-extending-__codelineno-15-56"></a>            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s1">&#39;prime.yaml&#39;</span><span class="p">,</span> <span class="s1">&#39;prime.yml&#39;</span><span class="p">)):</span>
<a id="__codelineno-15-57" name="__codelineno-15-57" href="#development-extending-__codelineno-15-57"></a>                <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-15-58" name="__codelineno-15-58" href="#development-extending-__codelineno-15-58"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-15-59" name="__codelineno-15-59" href="#development-extending-__codelineno-15-59"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">vvv</span><span class="p">(</span>
<a id="__codelineno-15-60" name="__codelineno-15-60" href="#development-extending-__codelineno-15-60"></a>                    <span class="s1">&#39;Skipping due to inventory source not ending in &quot;prime.yaml&quot; nor &quot;prime.yml&quot;&#39;</span><span class="p">)</span>
<a id="__codelineno-15-61" name="__codelineno-15-61" href="#development-extending-__codelineno-15-61"></a>        <span class="k">return</span> <span class="n">valid</span>
<a id="__codelineno-15-62" name="__codelineno-15-62" href="#development-extending-__codelineno-15-62"></a>
<a id="__codelineno-15-63" name="__codelineno-15-63" href="#development-extending-__codelineno-15-63"></a>    <span class="k">def</span> <span class="nf">add_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">host_vars</span><span class="p">):</span>
<a id="__codelineno-15-64" name="__codelineno-15-64" href="#development-extending-__codelineno-15-64"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">add_host</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
<a id="__codelineno-15-65" name="__codelineno-15-65" href="#development-extending-__codelineno-15-65"></a>
<a id="__codelineno-15-66" name="__codelineno-15-66" href="#development-extending-__codelineno-15-66"></a>        <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var_value</span> <span class="ow">in</span> <span class="n">host_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-15-67" name="__codelineno-15-67" href="#development-extending-__codelineno-15-67"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">inventory</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var_value</span><span class="p">)</span>
<a id="__codelineno-15-68" name="__codelineno-15-68" href="#development-extending-__codelineno-15-68"></a>
<a id="__codelineno-15-69" name="__codelineno-15-69" href="#development-extending-__codelineno-15-69"></a>        <span class="n">strict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;strict&#39;</span><span class="p">)</span>
<a id="__codelineno-15-70" name="__codelineno-15-70" href="#development-extending-__codelineno-15-70"></a>
<a id="__codelineno-15-71" name="__codelineno-15-71" href="#development-extending-__codelineno-15-71"></a>        <span class="c1"># Add variables created by the user&#39;s Jinja2 expressions to the host</span>
<a id="__codelineno-15-72" name="__codelineno-15-72" href="#development-extending-__codelineno-15-72"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_set_composite_vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;compose&#39;</span><span class="p">),</span> <span class="n">host_vars</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-15-73" name="__codelineno-15-73" href="#development-extending-__codelineno-15-73"></a>
<a id="__codelineno-15-74" name="__codelineno-15-74" href="#development-extending-__codelineno-15-74"></a>        <span class="c1"># Create user-defined groups using variables and Jinja2 conditionals</span>
<a id="__codelineno-15-75" name="__codelineno-15-75" href="#development-extending-__codelineno-15-75"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_host_to_composed_groups</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">),</span> <span class="n">host_vars</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span>
<a id="__codelineno-15-76" name="__codelineno-15-76" href="#development-extending-__codelineno-15-76"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_add_host_to_keyed_groups</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;keyed_groups&#39;</span><span class="p">),</span> <span class="n">host_vars</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span>
<a id="__codelineno-15-77" name="__codelineno-15-77" href="#development-extending-__codelineno-15-77"></a><span class="o">...</span>
</code></pre></div>
<ol>
<li>Declare option that are needed in the plugin. <a href="https://docs.ansible.com/ansible/latest/dev_guide/developing_plugins.html#plugin-configuration-documentation-standards" target="_blank">More about documentation</a></li>
<li>Example with parameter for a inventory file to run the script.</li>
<li>Different methods like verify_file, parse and more. <a href="https://docs.ansible.com/ansible/latest/dev_guide/developing_inventory.html#developing-an-inventory-plugin" target="_blank">Additional information about class and function here</a></li>
</ol>
</div>
<p>The Python file needs to be stored in a collection, e.g.:</p>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#development-extending-__codelineno-16-1"></a><span class="go">collections/</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#development-extending-__codelineno-16-2"></a><span class="go">└── ansible_collections</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#development-extending-__codelineno-16-3"></a><span class="go">    └── computacenter</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#development-extending-__codelineno-16-4"></a><span class="go">        └── utils</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#development-extending-__codelineno-16-5"></a><span class="go">            ├── README.md</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#development-extending-__codelineno-16-6"></a><span class="go">            ├── plugins</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#development-extending-__codelineno-16-7"></a><span class="go">            │   ├── README.md</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#development-extending-__codelineno-16-8"></a><span class="go">            │   └── inventory</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#development-extending-__codelineno-16-9"></a><span class="go">            │       └── cc_cisco_prime.py</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#development-extending-__codelineno-16-10"></a><span class="go">            └── roles</span>
</code></pre></div>
<p>To run this script, create a inventory file with the correct entries, as in the <em>examples</em> section of the inventory script.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#development-extending-__codelineno-17-1"></a><span class="c1"># inventory.yml</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#development-extending-__codelineno-17-2"></a><span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">computacenter.utils.cc_cisco_prime</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#development-extending-__codelineno-17-3"></a><span class="nt">api_user</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;user123&quot;</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#development-extending-__codelineno-17-4"></a><span class="nt">api_pass</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;password123&quot;</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#development-extending-__codelineno-17-5"></a><span class="nt">api_host_url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;host.domain.tld&quot;</span>
</code></pre></div>
<p>Run your playbook, referencing the custom inventory plugin file:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#development-extending-__codelineno-18-1"></a><span class="go">ansible-playbook -i inventory.yml main.yml</span>
</code></pre></div>
<!-- markdownlint-disable --></section><h1 class='nav-section-title-end'>Ended: Ansible Development</h1>
                        <h1 class='nav-section-title' id='section-ansible-automation-platform'>
                            Ansible Automation Platform <a class='headerlink' href='#section-ansible-automation-platform' title='Permanent link'>↵</a>
                        </h1>
                        <section class="print-page" id="automation-platform"><h1 id="automation-platform-ansible-automation-platform">Ansible Automation Platform</h1>
<p>This topic is split into multiple sections, each section covers a different aspect of using the Ansible Automation Platform.</p>
<div class="grid cards">
<ul>
<li>
<p><a href="#automation-platform-credentials"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M10.5 0a5.499 5.499 0 1 1-1.288 10.848l-.932.932a.749.749 0 0 1-.53.22H7v.75a.749.749 0 0 1-.22.53l-.5.5a.749.749 0 0 1-.53.22H5v.75a.749.749 0 0 1-.22.53l-.5.5a.749.749 0 0 1-.53.22h-2A1.75 1.75 0 0 1 0 14.25v-2c0-.199.079-.389.22-.53l4.932-4.932A5.5 5.5 0 0 1 10.5 0Zm-4 5.5c-.001.431.069.86.205 1.269a.75.75 0 0 1-.181.768L1.5 12.56v1.69c0 .138.112.25.25.25h1.69l.06-.06v-1.19a.75.75 0 0 1 .75-.75h1.19l.06-.06v-1.19a.75.75 0 0 1 .75-.75h1.19l1.023-1.025a.75.75 0 0 1 .768-.18A4 4 0 1 0 6.5 5.5ZM11 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg></span> &nbsp; Credentials</a></p>
<hr />
<p>Secret handling in AAP</p>
</li>
<li>
<p><a href="#automation-platform-workflows"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 1.75C0 .784.784 0 1.75 0h3.5C6.216 0 7 .784 7 1.75v3.5A1.75 1.75 0 0 1 5.25 7H4v4a1 1 0 0 0 1 1h4v-1.25C9 9.784 9.784 9 10.75 9h3.5c.966 0 1.75.784 1.75 1.75v3.5A1.75 1.75 0 0 1 14.25 16h-3.5A1.75 1.75 0 0 1 9 14.25v-.75H5A2.5 2.5 0 0 1 2.5 11V7h-.75A1.75 1.75 0 0 1 0 5.25Zm1.75-.25a.25.25 0 0 0-.25.25v3.5c0 .138.112.25.25.25h3.5a.25.25 0 0 0 .25-.25v-3.5a.25.25 0 0 0-.25-.25Zm9 9a.25.25 0 0 0-.25.25v3.5c0 .138.112.25.25.25h3.5a.25.25 0 0 0 .25-.25v-3.5a.25.25 0 0 0-.25-.25Z"/></svg></span> &nbsp; Workflows</a></p>
<hr />
<p>Everything regarding Workflow Job templates</p>
</li>
</ul>
</div>
<!-- markdownlint-disable --></section><section class="print-page" id="automation-platform-credentials"><h1 id="automation-platform-credentials-credentials">Credentials</h1>
<p>Credentials are utilized for authentication when launching Jobs against machines, synchronizing with inventory sources, and importing project content from a version control system.</p>
<p>You can grant users and teams the ability to use these credentials, without actually exposing the credential to the user.</p>
<h2 id="automation-platform-credentials-custom-credentials">Custom Credentials</h2>
<p>Although a growing number of <a href="https://docs.ansible.com/automation-controller/latest/html/userguide/credentials.html#ug-credentials-cred-types" target="_blank"><em>credential types</em></a> are already available, it is possible to
define additional <em>custom</em> credential types that works in ways similar to existing ones.<br />
For example, you could create a custom credential type that injects an API token for a third-party web service into an environment variable, which your playbook or custom inventory script could consume.</p>
<p>For example, to provide login credentials for plugins and modules of the <a href="https://docs.ansible.com/ansible/latest/collections/dellemc/openmanage/ome_inventory_inventory.html#ansible-collections-dellemc-openmanage-ome-inventory-inventory" target="_blank">Dell EMC OpenManage Enterprise Collection</a> you need to create a custom credential, as no existing credentials type is available.<br />
You can set the <em>environment variables</em> <code>OME_USERNAME</code> and <code>OME_PASSWORD</code> by creating a new AAP credentials type.</p>
<p>In the left navigation bar, choose <em>Credential Types</em> and click <em>Add</em>, besides the name you need to fill two fields:</p>
<table>
<thead>
<tr>
<th>Configuration</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>Input</em></td>
<td>Which input fields you will make available when creating a credential of this type.</td>
</tr>
<tr>
<td><em>Injector</em></td>
<td>What your credential type will provide to the playbook</td>
</tr>
</tbody>
</table>
<div class="highlight"><span class="filename">Input Configuration</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#automation-platform-credentials-__codelineno-0-1"></a><span class="nt">fields</span><span class="p">:</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#automation-platform-credentials-__codelineno-0-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#automation-platform-credentials-__codelineno-0-3"></a><span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">username</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#automation-platform-credentials-__codelineno-0-4"></a><span class="w">    </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Username</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#automation-platform-credentials-__codelineno-0-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#automation-platform-credentials-__codelineno-0-6"></a><span class="w">    </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#automation-platform-credentials-__codelineno-0-7"></a><span class="w">    </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Password</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#automation-platform-credentials-__codelineno-0-8"></a><span class="w">    </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#automation-platform-credentials-__codelineno-0-9"></a><span class="nt">required</span><span class="p">:</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#automation-platform-credentials-__codelineno-0-10"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">username</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#automation-platform-credentials-__codelineno-0-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
</code></pre></div>
<div class="highlight"><span class="filename">Injector Configuration</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#automation-platform-credentials-__codelineno-1-1"></a><span class="nt">env</span><span class="p">:</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#automation-platform-credentials-__codelineno-1-2"></a><span class="w">  </span><span class="nt">OME_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">username</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#automation-platform-credentials-__codelineno-1-3"></a><span class="w">  </span><span class="nt">OME_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">password</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You are responsible for avoiding collisions in the <code>extra_vars</code>, <code>env</code>, and file namespaces. Also, avoid environment variable or extra variable names that start with <code>ANSIBLE_</code> because they are reserved.</p>
</div>
<p>Save your credential type, create a new credential of this type and attach it to the Job template with the playbook targeting the OpenManage Enterprise API.</p>
<p>An example task may look like this:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#automation-platform-credentials-__codelineno-2-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Retrieve basic inventory of all devices</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#automation-platform-credentials-__codelineno-2-2"></a><span class="w">  </span><span class="nt">dellemc.openmanage.ome_device_info</span><span class="p">:</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#automation-platform-credentials-__codelineno-2-3"></a><span class="w">    </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">ansible_host</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#automation-platform-credentials-__codelineno-2-4"></a><span class="w">    </span><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(&#39;env&#39;,</span><span class="nv"> </span><span class="s">&#39;OME_USERNAME&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#automation-platform-credentials-__codelineno-2-5"></a><span class="w">    </span><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">lookup(&#39;env&#39;,</span><span class="nv"> </span><span class="s">&#39;OME_PASSWORD&#39;)</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Depending on the module used, you may leave out the <code>username</code> and <code>password</code> key, environment variables are evaluated first.  Take a look at the module documentation if this is possible, otherwise use the <em>lookup</em> plugin as shown above.</p>
</div>
<p>Additional information can be found in the <a href="https://docs.ansible.com/automation-controller/latest/html/userguide/credential_types.html" target="_blank">Ansible documentation</a>.</p>
<h3 id="automation-platform-credentials-automation-and-templating">Automation and templating</h3>
<p>Creating a custom credential with a playbook can be tricky as you need to provide the special, reserved curly braces character as part of the <em>Injector Configuration</em>.<br />
During the playbook run, Ansible will try to template the values which will fail as they are undefined (and you want the <em>literal</em> string representation anyway). Therefore, prefix the values with <code>!unsafe</code> to prevent templating the values.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#automation-platform-credentials-__codelineno-3-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create custom Credential type for DELL OME</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#automation-platform-credentials-__codelineno-3-2"></a><span class="w">  </span><span class="nt">awx.awx.credential_type</span><span class="p">:</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#automation-platform-credentials-__codelineno-3-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dell EMC OpenManage Enterprise</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#automation-platform-credentials-__codelineno-3-4"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Sets environment variables for logging in to OpenManage Enterprise</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#automation-platform-credentials-__codelineno-3-5"></a><span class="w">    </span><span class="nt">inputs</span><span class="p">:</span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#automation-platform-credentials-__codelineno-3-6"></a><span class="w">      </span><span class="nt">fields</span><span class="p">:</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#automation-platform-credentials-__codelineno-3-7"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">username</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#automation-platform-credentials-__codelineno-3-8"></a><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#automation-platform-credentials-__codelineno-3-9"></a><span class="w">          </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Username</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#automation-platform-credentials-__codelineno-3-10"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#automation-platform-credentials-__codelineno-3-11"></a><span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#automation-platform-credentials-__codelineno-3-12"></a><span class="w">          </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Password</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#automation-platform-credentials-__codelineno-3-13"></a><span class="w">          </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#automation-platform-credentials-__codelineno-3-14"></a><span class="w">      </span><span class="nt">required</span><span class="p">:</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#automation-platform-credentials-__codelineno-3-15"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">username</span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#automation-platform-credentials-__codelineno-3-16"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
<a id="__codelineno-3-17" name="__codelineno-3-17" href="#automation-platform-credentials-__codelineno-3-17"></a><span class="w">    </span><span class="nt">injectors</span><span class="p">:</span>
<a id="__codelineno-3-18" name="__codelineno-3-18" href="#automation-platform-credentials-__codelineno-3-18"></a><span class="w">      </span><span class="nt">env</span><span class="p">:</span>
<a id="__codelineno-3-19" name="__codelineno-3-19" href="#automation-platform-credentials-__codelineno-3-19"></a><span class="hll"><span class="w">        </span><span class="nt">OME_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="kt">!unsafe</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">password</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span><a id="__codelineno-3-20" name="__codelineno-3-20" href="#automation-platform-credentials-__codelineno-3-20"></a><span class="hll"><span class="w">        </span><span class="nt">OME_USERNAME</span><span class="p">:</span><span class="w"> </span><span class="kt">!unsafe</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">username</span><span class="nv"> </span><span class="s">}}&quot;</span>
</span></code></pre></div>
<p>Take a look at <a href="#ansible-variables-disable-variable-templating">Disable variable templating</a> for additional information.</p>
<!-- markdownlint-disable --></section><section class="print-page" id="automation-platform-workflows"><h1 id="automation-platform-workflows-workflows">Workflows</h1>
<p><a href="https://docs.ansible.com/automation-controller/latest/html/userguide/workflows.html" target="_blank">Workflows</a> allow you to configure a sequence of disparate job templates (or workflow templates) that may or may not share inventory, playbooks, or permissions.</p>
<h2 id="automation-platform-workflows-variables-across-workflow-steps">Variables across workflow steps</h2>
<p>Transferring information across workflow steps can't be done by the <code>set_fact</code> module, these facts are only available during a normal playbook run. Workflow job template run separate Jobs targeting separate playbooks.</p>
<div class="admonition quote">
<p class="admonition-title">Possible Use-case</p>
<p>Think of a first workflow step searching for an available IP address in an IPAM tool. The second workflow step can't know this IP before the workflow itself starts, therefore this information needs to be transferred from the first workflow step to the second one.</p>
</div>
<p>In addition to the workflow <code>extra_vars</code>, jobs ran as part of a workflow can inherit variables in the <em>artifacts</em> dictionary of a parent job in the workflow. These artifacts can be defined by the <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/set_stats_module.html" target="_blank"><code>set_stats</code> module</a>.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The point of set_stats in workflows is to have a vehicle to pass data via <code>--extra-vars</code> to the next job template.</p>
</div>
<h3 id="automation-platform-workflows-setting-stats">Setting stats</h3>
<p>The first playbook (Job Template) in the workflow run defines a variable in the <code>data</code> dictionary.</p>
<div class="highlight"><span class="filename">Task of playbook in Workflow node 1</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#automation-platform-workflows-__codelineno-0-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Setting stat of free IP address for subsequent workflow step</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#automation-platform-workflows-__codelineno-0-2"></a><span class="w">  </span><span class="nt">ansible.builtin.set_stats</span><span class="p">:</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#automation-platform-workflows-__codelineno-0-3"></a><span class="w">    </span><span class="nt">data</span><span class="p">:</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#automation-platform-workflows-__codelineno-0-4"></a><span class="w">      </span><span class="nt">available_ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">ipam_returned_ip</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div>
<div class="admonition bug">
<p class="admonition-title">Bug</p>
<p>Do <strong>not</strong> use the <code>per_host</code> parameter, it breaks the artifacts gathering!<br />
You can't provide distinct stats per host (without workarounds).</p>
</div>
<h3 id="automation-platform-workflows-retrieving-stats">Retrieving stats</h3>
<p>The second playbook (Job Template) in the workflow run references the variable of the <code>data</code> dictionary.</p>
<div class="highlight"><span class="filename">Task of playbook in Workflow node 2</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#automation-platform-workflows-__codelineno-1-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Output available IP address from previous workflow step</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#automation-platform-workflows-__codelineno-1-2"></a><span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#automation-platform-workflows-__codelineno-1-3"></a><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">available_ip</span><span class="nv"> </span><span class="s">}}&quot;</span>
</code></pre></div>
<h3 id="automation-platform-workflows-display-custom-stats">Display custom stats</h3>
<p>Custom stats can be displayed at the playbook recap, you must set <code>show_custom_stats</code> in the <code class="highlight"><span class="k">[defaults]</span></code> section of your Ansible configuration file:</p>
<div class="highlight"><span class="filename">ansible.cfg</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#automation-platform-workflows-__codelineno-2-1"></a><span class="k">[defaults]</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#automation-platform-workflows-__codelineno-2-2"></a><span class="na">show_custom_stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">true</span>
</code></pre></div>
<p>Defining the environment variable <code>ANSIBLE_SHOW_CUSTOM_STATS</code> and setting to <code>true</code> achieves the same behavior.</p>
<details class="example">
<summary>Play recap with custom stats</summary>
<div class="no-copy highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#automation-platform-workflows-__codelineno-3-1"></a><span class="go">PLAY RECAP *********************************************************************</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#automation-platform-workflows-__codelineno-3-2"></a><span class="go">localhost                  : ok=13    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#automation-platform-workflows-__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#automation-platform-workflows-__codelineno-3-4"></a><span class="go">CUSTOM STATS: ******************************************************************</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#automation-platform-workflows-__codelineno-3-5"></a><span class="go">    RUN: { &quot;available_ip&quot;: 10.28.13.5&quot;}</span>
</code></pre></div>
</details>
<!-- markdownlint-disable --></section><h1 class='nav-section-title-end'>Ended: Ansible Automation Platform</h1></div>












                

              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; Tim Grützmacher 2024
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com/timgrt/Ansible-Best-Practices/pkgs/container/ansible-best-practices" target="_blank" rel="noopener" title="Docker Container in Github Container Repository" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M349.9 236.3h-66.1v-59.4h66.1v59.4zm0-204.3h-66.1v60.7h66.1V32zm78.2 144.8H362v59.4h66.1v-59.4zm-156.3-72.1h-66.1v60.1h66.1v-60.1zm78.1 0h-66.1v60.1h66.1v-60.1zm276.8 100c-14.4-9.7-47.6-13.2-73.1-8.4-3.3-24-16.7-44.9-41.1-63.7l-14-9.3-9.3 14c-18.4 27.8-23.4 73.6-3.7 103.8-8.7 4.7-25.8 11.1-48.4 10.7H2.4c-8.7 50.8 5.8 116.8 44 162.1 37.1 43.9 92.7 66.2 165.4 66.2 157.4 0 273.9-72.5 328.4-204.2 21.4.4 67.6.1 91.3-45.2 1.5-2.5 6.6-13.2 8.5-17.1l-13.3-8.9zm-511.1-27.9h-66v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm78.1 0h-66.1v59.4h66.1v-59.4zm-78.1-72.1h-66.1v60.1h66.1v-60.1z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "/", "features": ["content.code.annotate", "content.code.copy", "navigation.indexes", "navigation.instant", "navigation.sections", "navigation.top", "search.highlight", "search.suggest"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.af256bd8.min.js"></script>
      
        <script src="../js/print-site.js"></script>
      
        <script src="../assets/javascripts/extra/refresh-on-toggle-dark-light.js"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../assets/javascripts/extra/tablesort.js"></script>
      
        <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
      
    
  </body>
</html>